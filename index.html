<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Minute Adventurer</title>
<link rel="manifest" href="./manifest.json">
<link rel="apple-touch-icon" href="./apple-touch-icon.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Minute Adventurer">
<meta name="theme-color" content="#1a1814">
<meta name="description" content="A text-based dark fantasy adventure played in minutes.">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
--bg:#1a1814;--bg2:#252219;--bg3:#322d24;--bgO:rgba(0,0,0,.7);
--text:#e8e4dc;--text2:#a89f8c;--text3:#847a6c;
--gold:#c9a84c;--gold-dim:#8a7030;--gold-bright:#e0c060;
--red:#c44054;--blue:#4a8b7c;--green:#5a9c6a;--green-dim:#385c44;
--border:#3d3629;--focus:#e0c060;
--fn:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
--fm:'Courier New',Consolas,monospace;
}
html,body{height:100%;overflow:hidden;background:var(--bg);color:var(--text);font-family:var(--fn);font-size:16px;line-height:1.7;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}
*:focus-visible{outline:3px solid var(--focus)!important;outline-offset:2px!important;border-radius:2px}
/* Landing */
#landing{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100dvh;position:relative;overflow:hidden}
#landing.hidden{display:none}
#particles{position:fixed;inset:0;pointer-events:none;z-index:0}
#landing-content{position:relative;z-index:1;text-align:center;padding:20px;width:100%;max-width:400px}
#landing-title{font-size:1.75rem;color:var(--gold);font-weight:700;letter-spacing:.12em;text-transform:uppercase;opacity:0;animation:fadeIn .8s ease forwards}
#landing-sub{font-size:1rem;color:var(--text2);margin-top:8px;opacity:0;animation:fadeIn .8s ease .4s forwards}
#landing-buttons{margin-top:32px;display:flex;flex-direction:column;gap:12px;align-items:center;opacity:0;animation:fadeIn .8s ease 1s forwards}
.lbtn{display:block;width:100%;max-width:320px;min-height:52px;background:transparent;border-radius:8px;font-family:var(--fn);font-size:1rem;cursor:pointer;padding:12px 24px;transition:background .15s}
.lbtn-primary{border:2px solid var(--gold);color:var(--gold)}
.lbtn-primary:hover,.lbtn-primary:active{background:rgba(201,168,76,.08)}
.lbtn-secondary{border:1px solid var(--border);color:var(--text2)}
.lbtn-secondary:hover,.lbtn-secondary:active{background:rgba(201,168,76,.08)}
.lbtn-link{border:none;color:var(--text3);font-size:.9rem;min-height:auto;padding:8px;background:transparent}
.lbtn-link:hover{color:var(--text2)}
.lbtn-sub{font-size:.85rem;color:var(--text3);margin-top:4px}
#landing-version{position:absolute;bottom:20px;left:0;right:0;text-align:center;font-size:.8rem;color:var(--text3)}
/* App */
#app{display:none;flex-direction:column;height:100dvh;max-width:680px;margin:0 auto;position:relative}
#app.vis{display:flex}
/* HUD */
#hud{display:none;flex-shrink:0;background:var(--bg2);border-bottom:1px solid var(--border);padding:8px 10px;z-index:100}
#hud.vis{display:flex;align-items:center;gap:8px}
#hud-l{display:flex;align-items:center;gap:8px;flex:1;min-width:0}
#hud-portrait{width:32px;height:32px;image-rendering:pixelated;flex-shrink:0}
#hud-info{display:flex;flex-direction:column;min-width:0;gap:2px}
#hud-nc{font-size:.85rem;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
#hud-bars{display:flex;flex-direction:column;gap:3px}
.bar-row{display:flex;align-items:center;gap:6px}
.bar-o{width:80px;height:6px;background:var(--bg);border-radius:3px;overflow:hidden}
.bar-i{height:100%;border-radius:3px;transition:width .3s}
.bar-hp{background:var(--red)}.bar-mp{background:var(--blue)}
.bar-txt{font-size:.8rem;color:var(--text2);min-width:55px}
/* HUD Buttons */
#hud-r{display:flex;align-items:center;gap:2px;flex-shrink:0}
#hud-explore,#hud-combat{display:flex;gap:2px}
#hud-combat{display:none}
#hud.combat-mode #hud-explore{display:none}
#hud.combat-mode #hud-combat{display:flex}
.hbtn{width:48px;height:48px;background:transparent;border:none;cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;color:var(--text2);transition:background .15s;border-radius:4px;padding:4px}
.hbtn:active,.hbtn:hover{background:var(--bg3)}
.hbtn[disabled]{opacity:.3;cursor:default;pointer-events:none}
.hbtn canvas{width:20px;height:20px;image-rendering:pixelated}
.hbtn span{font-size:.7rem;color:var(--text3);line-height:1}
@keyframes pulse{0%,100%{box-shadow:none}50%{box-shadow:0 0 8px 2px var(--gold)}}.hbtn.pulse{animation:pulse 1s ease-in-out 3}
/* Narrative */
#narr-w{flex:1;overflow-y:auto;overflow-x:hidden;padding:12px 16px;scroll-behavior:smooth;-webkit-overflow-scrolling:touch;position:relative}
#narr-log{display:flex;flex-direction:column;gap:12px}
.ne{font-size:1rem;line-height:1.7;color:var(--text);animation:fadeSlide .3s ease}
.ne-h{font-size:1.2rem;color:var(--gold);font-weight:600;margin-top:20px}
.ne-f{color:var(--text2);font-style:italic}
.ne-c{color:var(--text)}
.ne-s{color:var(--green)}
.ne-d{color:var(--red)}
.ne-y{font-size:.85rem;color:var(--text3)}
.ne-g{color:var(--gold)}
/* Zone Display */
#zone-display{display:none;background:var(--bg2);border-bottom:1px solid var(--border);padding:8px 16px}
#zone-display.vis{display:block}
.zone-labels{display:flex;gap:0;justify-content:center;margin-bottom:4px}
.zone-lbl{flex:1;min-height:32px;background:transparent;border:1px solid var(--border);color:var(--text3);font-family:var(--fn);font-size:.8rem;cursor:default;text-align:center;padding:4px 8px;letter-spacing:.08em;transition:color .15s,border-color .15s}
.zone-lbl:first-child{border-radius:4px 0 0 4px}.zone-lbl:last-child{border-radius:0 4px 4px 0}
.zone-lbl.active{color:var(--gold);border-color:var(--gold);background:rgba(201,168,76,.08);font-weight:600}
#zone-enemy-info{display:none}
/* Enemy HP Bar */
#enemy-hp-wrap{margin-top:6px;text-align:center}
#enemy-hp-name{font-size:.95rem;font-weight:600;margin-bottom:4px}
.tier-badge{font-size:.65rem;text-transform:uppercase;letter-spacing:.08em;padding:1px 5px;border-radius:3px;margin-right:6px;vertical-align:1px}
.tier-1{color:var(--text3);border:1px solid var(--text3)}.tier-2{color:var(--text);border:1px solid var(--text)}.tier-3{color:var(--gold);border:1px solid var(--gold)}.tier-4{color:var(--red);border:1px solid var(--red)}.tier-5{color:#b060d0;border:1px solid #b060d0}
.enemy-hp-bar{width:100%;height:8px;background:var(--bg);border-radius:4px;overflow:hidden;margin:4px 0}
.enemy-hp-fill{height:100%;border-radius:4px;transition:width .3s ease,background .3s ease}
.ehp-high{background:var(--green)}.ehp-mid{background:var(--gold)}.ehp-low{background:var(--red)}
#enemy-hp-text{font-size:.8rem;color:var(--text2)}
/* Combat FX */
#hit-flash{display:none;position:fixed;inset:0;pointer-events:none;z-index:150}
@keyframes hitFlashAnim{0%{opacity:0}30%{opacity:1}100%{opacity:0}}
.hit-flash-red{display:block!important;background:radial-gradient(transparent 40%,rgba(196,64,84,.18));animation:hitFlashAnim .35s ease forwards}
.hit-flash-gold{display:block!important;background:radial-gradient(transparent 40%,rgba(201,168,76,.18));animation:hitFlashAnim .35s ease forwards}
@keyframes dmgPop{0%{opacity:1;transform:translateY(0)}100%{opacity:0;transform:translateY(-28px)}}
.dmg-pop{position:absolute;right:16px;font-weight:700;font-size:1.1rem;pointer-events:none;animation:dmgPop .7s ease forwards;z-index:160}
.dmg-pop-red{color:var(--red)}.dmg-pop-gold{color:var(--gold)}.dmg-pop-green{color:var(--green)}.dmg-pop-grey{color:var(--text3)}
@keyframes screenShake{0%,100%{transform:translateX(0)}20%{transform:translateX(-3px)}40%{transform:translateX(3px)}60%{transform:translateX(-2px)}80%{transform:translateX(2px)}}
.screen-shake{animation:screenShake .3s ease}
/* Toast */
.toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%) translateY(20px);padding:10px 20px;border-radius:6px;font-family:var(--fn);font-size:.9rem;z-index:800;opacity:0;transition:opacity .3s,transform .3s;pointer-events:none;max-width:90%}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
.toast-info{background:var(--bg3);color:var(--text);border:1px solid var(--border)}
.toast-error{background:rgba(196,64,84,.15);color:var(--red);border:1px solid var(--red)}
.toast-success{background:rgba(90,156,106,.15);color:var(--green);border:1px solid var(--green)}
/* CC shake */
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-4px)}75%{transform:translateX(4px)}}
.cc-shake{animation:shake .3s ease}
.cc-hint{font-size:.8rem;color:var(--red);margin-top:4px;text-align:center}
/* Bottom bar */
#bbar{display:none;flex-shrink:0;background:var(--bg2);border-top:1px solid var(--border);padding:8px 10px;padding-bottom:calc(8px + env(safe-area-inset-bottom,0px))}
#bbar.vis{display:block}
#explore-bar{display:flex;gap:8px;align-items:center}
#combat-bar{display:none;gap:6px}
#bbar.combat-mode #explore-bar{display:none}
#bbar.combat-mode #combat-bar{display:flex}
.acts-btn{min-height:48px;padding:8px 16px;background:transparent;border:1px solid var(--border);border-radius:6px;color:var(--text2);font-family:var(--fn);font-size:.9rem;cursor:pointer;white-space:nowrap;transition:border-color .15s}
.acts-btn:active{border-color:var(--gold)}
.cbtn{flex:1;min-height:48px;background:var(--bg3);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:var(--fn);font-size:.9rem;cursor:pointer;padding:6px 4px;transition:background .15s,border-color .15s}
.cbtn:active,.cbtn:hover{background:var(--bg2);border-color:var(--gold)}
.cbtn[disabled]{opacity:.35;cursor:default;pointer-events:none}
.cbtn .pct{display:block;font-size:.75rem;color:var(--text2)}
/* Modals */
.mo{display:none;position:fixed;inset:0;background:var(--bgO);z-index:500;justify-content:center;align-items:center;padding:0}
.mo.open{display:flex}
.mc{background:var(--bg2);width:100%;height:100%;overflow-y:auto;padding:16px;display:flex;flex-direction:column;animation:modalIn .2s ease}
@media(min-width:600px){.mc{max-width:560px;max-height:85vh;height:auto;border-radius:8px;margin:20px}}
.mh{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-shrink:0}
.mt{font-size:1.2rem;color:var(--gold);font-weight:600}
.mx{width:48px;height:48px;background:transparent;border:none;border-radius:4px;color:var(--text3);font-size:1.4rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:color .15s}
.mx:active,.mx:hover{color:var(--text)}
.mb{flex:1;overflow-y:auto}
.mbtn{display:block;width:100%;min-height:52px;background:var(--bg3);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:var(--fn);font-size:1rem;cursor:pointer;padding:10px 14px;text-align:left;margin-bottom:8px;transition:border-color .15s,background .15s}
.mbtn:active,.mbtn:hover{border-color:var(--gold);background:rgba(201,168,76,.06)}
.mbtn.sel{border-color:var(--gold);box-shadow:0 0 0 2px var(--gold)}
.mbtn[disabled]{opacity:.4;cursor:default;pointer-events:none}
/* Tabs */
.tab-bar{display:flex;gap:0;border-bottom:1px solid var(--border);margin-bottom:16px;flex-shrink:0;overflow-x:auto;-webkit-overflow-scrolling:touch}
.tab-btn{flex:1;min-width:0;min-height:44px;padding:8px 12px;background:transparent;border:none;border-bottom:2px solid transparent;color:var(--text3);font-family:var(--fn);font-size:.85rem;cursor:pointer;white-space:nowrap;transition:color .15s,border-color .15s}
.tab-btn.act{color:var(--gold);border-bottom-color:var(--gold)}
.tab-btn:hover{color:var(--text2)}
.tab-panel{display:none}.tab-panel.act{display:block}
/* Char creation */
#cc{flex:1;overflow-y:auto;padding:20px 16px;display:flex;flex-direction:column;align-items:center}
#cc h1{font-size:1.75rem;color:var(--gold);font-weight:700;letter-spacing:.06em;text-align:center;margin-bottom:6px}
#cc .sub{color:var(--text2);font-size:1rem;text-align:center;margin-bottom:20px}
.cc-step{font-size:.8rem;color:var(--text3);text-align:center;margin-bottom:16px}
.ccs{display:none;width:100%;max-width:480px}.ccs.act{display:block}
.ccs h2{font-size:1.2rem;color:var(--gold);font-weight:600;margin-bottom:14px;text-align:center}
#ninp{width:100%;min-height:52px;background:var(--bg);border:2px solid var(--border);border-radius:8px;color:var(--text);font-family:var(--fn);font-size:1.2rem;padding:10px 16px;text-align:center}
#ninp:focus{border-color:var(--gold)}
.ccds{display:flex;flex-direction:column;gap:10px}
@media(min-width:480px){.ccds{display:grid;grid-template-columns:1fr 1fr}}
.ccd{background:var(--bg3);border:2px solid var(--border);border-radius:8px;padding:14px;cursor:pointer;display:flex;gap:12px;align-items:flex-start;min-height:80px;transition:border-color .15s,box-shadow .15s}
.ccd:active,.ccd:hover{border-color:var(--gold)}
.ccd.sel,.ccd[aria-checked="true"]{border-color:var(--gold);box-shadow:0 0 12px rgba(201,168,76,.15)}
.ccd canvas{width:64px;height:64px;image-rendering:pixelated;flex-shrink:0}
.ccd-i{flex:1;min-width:0}
.ccd-n{font-size:1rem;color:var(--gold);font-weight:600}
.ccd-d{font-size:.9rem;color:var(--text2);margin-top:2px}
.ccd-s{font-size:.8rem;color:var(--text3);margin-top:4px}
.ccnv{display:flex;gap:10px;margin-top:18px;width:100%;max-width:480px;align-items:center}
.ccnb{flex:1;min-height:52px;background:transparent;border:1px solid var(--border);border-radius:8px;color:var(--text2);font-family:var(--fn);font-size:1rem;cursor:pointer;transition:border-color .15s}
.ccnb.pri{border:2px solid var(--gold);color:var(--gold)}
.ccnb:active{background:var(--bg3)}
.ccnb[disabled]{opacity:.35;cursor:default}
.csum{background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:16px;width:100%}
.csr{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);font-size:.9rem}
.csl{color:var(--text2)}.csv{color:var(--text)}
.sbar{display:flex;align-items:center;gap:6px;margin:2px 0}
.sbar-l{font-size:.8rem;color:var(--text2);width:65px;text-align:right}
.sbar-o{flex:1;height:6px;background:var(--bg);border-radius:3px;overflow:hidden;max-width:140px}
.sbar-i{height:100%;background:var(--gold);border-radius:3px}
.sbar-v{font-family:var(--fm);font-size:.8rem;color:var(--text);width:20px}
.hb-row{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:6px;margin-bottom:6px}
.hb-name{font-size:.9rem;color:var(--text)}
.hb-val{font-family:var(--fm);font-size:1rem;color:var(--gold);min-width:20px;text-align:center}
.hb-btn{width:48px;height:48px;background:transparent;border:1px solid var(--border);border-radius:4px;color:var(--gold);font-size:1.4rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background .15s}
.hb-btn:active{background:var(--bg2);border-color:var(--gold)}
.hb-btn[disabled]{opacity:.3;cursor:default;pointer-events:none}
.hb-pts{font-size:.9rem;color:var(--gold);text-align:center;margin-bottom:12px}
/* Section titles */
.ist{font-size:.7rem;color:var(--text3);text-transform:uppercase;letter-spacing:.1em;margin:20px 0 8px}
.ist:first-child{margin-top:0}
/* Equipment/items */
.isl{background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:12px;margin-bottom:8px}
.isl-head{font-size:.7rem;color:var(--text3);text-transform:uppercase;letter-spacing:.05em;margin-bottom:6px}
.isl-top{display:flex;justify-content:space-between;align-items:center}
.isl-name{font-size:1rem;color:var(--text);font-weight:600}
.isl-l{font-size:.7rem;color:var(--text3);text-transform:uppercase;letter-spacing:.05em;margin-bottom:4px}
.isl-i{font-size:.85rem;color:var(--text2);margin-top:2px}
.isl-e{font-size:.9rem;color:var(--text3);font-style:italic}
.isl-empty{border-style:dashed}
.isl-a{display:flex;gap:4px;margin-top:8px}
.iab{min-width:48px;min-height:44px;background:transparent;border:1px solid var(--border);border-radius:4px;color:var(--text2);font-family:var(--fn);font-size:.85rem;cursor:pointer;padding:4px 12px;transition:border-color .15s}
.iab:active{background:var(--bg2);border-color:var(--gold)}
/* Stat rows */
.stat-row{display:flex;align-items:center;padding:6px 0;gap:8px}
.stat-name{font-size:.85rem;color:var(--text2);flex:1}
.stat-val{font-family:var(--fm);font-size:1rem;color:var(--text);min-width:24px;text-align:right}
.stat-derived{font-size:.85rem;color:var(--text3);min-width:80px;text-align:right}
.trait-card{background:var(--bg3);border-radius:6px;padding:10px 12px;margin-top:8px}
.trait-card strong{color:var(--gold)}
.trait-card p{font-size:.9rem;color:var(--text2);margin-top:4px}
.xp-bar-o{width:100%;height:4px;background:var(--bg);border-radius:2px;overflow:hidden;margin-top:6px}
.xp-bar-i{height:100%;background:var(--gold);border-radius:2px}
/* Journal */
.jtabs{display:flex;gap:0;border-bottom:1px solid var(--border);margin-bottom:16px;flex-shrink:0;overflow-x:auto;-webkit-overflow-scrolling:touch}
.jtab{flex:1;min-width:0;min-height:44px;padding:8px 10px;background:transparent;border:none;border-bottom:2px solid transparent;color:var(--text3);font-family:var(--fn);font-size:.85rem;cursor:pointer;white-space:nowrap;transition:color .15s}
.jtab.act{color:var(--gold);border-bottom-color:var(--gold)}
.jtab:active{color:var(--text2)}
.jp{display:none}.jp.act{display:block}
.jp h3{font-size:1.1rem;color:var(--gold);font-weight:600;margin:16px 0 8px}
.jp p{font-size:1rem;line-height:1.7;color:var(--text);margin-bottom:8px}
/* Bestiary */
.be{background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:12px;margin-bottom:10px}
.be-n{font-size:1rem;color:var(--gold);font-weight:600}
.be-l{font-style:italic;color:var(--text2);margin:4px 0;font-size:.9rem}
.be-s{font-size:.8rem;color:var(--text3)}
/* Save/Load */
.ssl{background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:12px;margin-bottom:8px}
.ssl-h{font-size:.9rem;color:var(--text);font-weight:600;margin-bottom:4px}
.ssl-i{font-size:.85rem;color:var(--text2)}
.ssl-a{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
.slb{min-height:44px;min-width:48px;padding:8px 16px;background:transparent;border:1px solid var(--border);border-radius:4px;color:var(--text2);font-family:var(--fn);font-size:.9rem;cursor:pointer;transition:border-color .15s}
.slb:active{border-color:var(--gold);background:var(--bg3)}
.slb.dng{border-color:var(--red);color:var(--red)}.slb.dng:active{background:rgba(196,64,84,.1)}
.snotice{font-size:.8rem;color:var(--text3);margin-top:12px;padding:8px;background:var(--bg3);border-radius:4px}
/* Dialogue */
.dlg-name{font-size:1.2rem;color:var(--gold);text-align:center;text-transform:uppercase;letter-spacing:.08em;margin-bottom:2px}
.dlg-title{font-size:.85rem;color:var(--text3);text-align:center;margin-bottom:16px}
.dsp{font-size:1.2rem;color:var(--gold);font-weight:600;margin-bottom:8px}
.dtx{font-size:1rem;line-height:1.7;color:var(--text);margin-bottom:20px;padding:0 8px}
.dopts{display:flex;flex-direction:column;gap:8px}
/* Weight tags */
.wt-tag{font-size:.7rem;padding:1px 5px;border-radius:3px;margin-left:4px}
.wt-0{color:var(--green);border:1px solid var(--green)}.wt-1{color:var(--gold);border:1px solid var(--gold)}.wt-2{color:var(--red);border:1px solid var(--red)}
/* Misc */
.msep{border:none;border-top:1px solid var(--border);margin:10px 0}
.rc{text-align:center;padding:20px 0}
.rc h2{font-size:1.4rem;color:var(--gold);font-weight:600;margin-bottom:12px}
.rc .xp{font-family:var(--fm);font-size:1.2rem;color:var(--green);margin-bottom:8px}
.rc .lu{font-size:1.2rem;color:var(--gold-bright);margin-bottom:16px}
/* Animations */
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes fadeSlide{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}
@keyframes modalIn{from{opacity:0;transform:scale(.97)}to{opacity:1;transform:scale(1)}}
@media(prefers-reduced-motion:reduce){
*,*::before,*::after{animation-duration:.01ms!important;transition-duration:.01ms!important}
#particles{display:none}
}
@media(max-width:480px){.ne{font-size:1.05rem}#hud{padding:6px 8px}}
/* Settings: high contrast & larger text (applied to html) */
html.settings-high-contrast{--text:#f0ece0;--text2:#b8b0a0;--text3:#9a9080;--border:#4a4238}
html.settings-large-text{font-size:1.1rem}
.sr{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
/* Title Card */
#title-card{display:none;position:fixed;inset:0;background:var(--bg);z-index:600;justify-content:center;align-items:center;flex-direction:column;opacity:0;transition:opacity .3s ease}
#title-card.vis{display:flex}
#title-card.show{opacity:1}
#tc-name{font-size:1.75rem;color:var(--gold);text-transform:uppercase;letter-spacing:.12em;font-weight:700;text-align:center}
#tc-sub{font-size:.85rem;color:var(--text3);margin-top:8px;text-align:center}
/* Death Screen */
#death-screen{display:none;position:fixed;inset:0;background:var(--bg);z-index:700;justify-content:center;align-items:center;flex-direction:column;gap:16px;opacity:0;transition:opacity .5s ease}
#death-screen.vis{display:flex}
#death-screen.show{opacity:1}
#death-screen h2{font-size:1.5rem;color:var(--red);text-transform:uppercase;letter-spacing:.1em;font-weight:700}
#death-screen .dq{color:var(--text3);font-style:italic;font-size:.9rem;margin-bottom:12px;text-align:center;padding:0 20px}
.ds-btn{min-width:200px;min-height:52px;background:transparent;border:1px solid var(--border);border-radius:8px;color:var(--text2);font-family:var(--fn);font-size:1rem;cursor:pointer;padding:12px 24px;transition:border-color .15s}
.ds-btn:hover,.ds-btn:active{border-color:var(--gold);background:rgba(201,168,76,.06)}
/* Scene Nav Buttons */
.nav-exits{margin-top:16px;padding-top:10px;border-top:1px solid var(--border)}
.nav-exits-lbl{font-size:.7rem;color:var(--text3);text-transform:uppercase;letter-spacing:.1em;margin-bottom:8px}
.nav-btns{display:flex;flex-wrap:wrap;gap:8px}
.nav-btn{background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:10px 16px;color:var(--text);font-family:var(--fn);font-size:.9rem;cursor:pointer;transition:border-color .15s,background .15s;min-height:44px}
.nav-btn:hover,.nav-btn:active{border-color:var(--gold);background:rgba(201,168,76,.06)}
.nav-tag{color:var(--text3);font-size:.8rem;margin-left:4px}
/* NPC Buttons */
.npc-btns{margin-top:12px;display:flex;flex-wrap:wrap;gap:8px}
.npc-btn{background:var(--bg3);border:1px solid var(--gold);border-radius:6px;padding:10px 16px;color:var(--gold);font-family:var(--fn);font-size:.9rem;cursor:pointer;transition:background .15s;min-height:44px}
.npc-btn:hover,.npc-btn:active{background:rgba(201,168,76,.06)}
/* Victory Card */
.vic-card{background:var(--bg3);border:1px solid var(--gold);border-radius:8px;padding:16px;margin-top:12px;animation:fadeSlide .3s ease}
.vic-h{color:var(--gold);font-size:1.1rem;font-weight:600;margin-bottom:8px}
.vic-stat{font-size:.9rem;color:var(--text);padding:2px 0}
.vic-loot-h{color:var(--text3);font-size:.7rem;text-transform:uppercase;letter-spacing:.06em;margin:12px 0 6px;padding-top:10px;border-top:1px solid var(--border)}
.vic-loot-row{display:flex;align-items:center;justify-content:space-between;padding:6px 0;gap:8px}
.vic-loot-name{font-size:.95rem;color:var(--text);flex:1}
.vic-loot-desc{font-size:.8rem;color:var(--text3)}
.vic-take-btn{min-width:60px;min-height:36px;background:transparent;border:1px solid var(--gold);border-radius:4px;color:var(--gold);font-family:var(--fn);font-size:.85rem;cursor:pointer;padding:4px 10px;transition:background .15s}
.vic-take-btn:hover{background:rgba(201,168,76,.06)}
.vic-take-btn[disabled]{opacity:.4;cursor:default;border-color:var(--red);color:var(--red)}
.vic-leave{background:none;border:none;color:var(--text3);font-family:var(--fn);font-size:.85rem;cursor:pointer;padding:8px 0;margin-top:4px}
.vic-leave:hover{color:var(--text2)}
.vic-lvl-h{color:var(--gold-bright);font-size:1rem;font-weight:600;margin:12px 0 8px;padding-top:10px;border-top:1px solid var(--border)}
.vic-lvl-info{font-size:.9rem;color:var(--green);margin-bottom:10px}
.vic-stat-grid{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:6px}
.vic-stat-btn{min-height:44px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:var(--fn);font-size:.85rem;cursor:pointer;padding:6px 4px;text-align:center;transition:border-color .15s}
.vic-stat-btn:hover{border-color:var(--gold)}
.vic-stat-btn span{display:block;font-size:.7rem;color:var(--text3)}
/* Action Sheet */
#action-sheet{display:none;position:fixed;bottom:0;left:0;right:0;z-index:400;max-height:60vh;background:var(--bg2);border-top:1px solid var(--gold);border-radius:12px 12px 0 0;padding:12px 14px;padding-bottom:calc(12px + env(safe-area-inset-bottom,0px));overflow-y:auto;transform:translateY(100%);transition:transform .25s ease}
#action-sheet.vis{display:block;transform:translateY(0)}
#as-backdrop{display:none;position:fixed;inset:0;z-index:399;background:rgba(0,0,0,.4)}
#as-backdrop.vis{display:block}
.as-h{font-size:.7rem;color:var(--gold);font-weight:600;text-transform:uppercase;letter-spacing:.1em;margin-bottom:10px}
.as-btn{display:block;width:100%;min-height:48px;background:var(--bg3);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:var(--fn);font-size:1rem;cursor:pointer;padding:10px 14px;text-align:left;margin-bottom:6px;transition:border-color .15s,background .15s}
.as-btn:hover,.as-btn:active{border-color:var(--gold);background:rgba(201,168,76,.06)}
.as-btn-sub{display:block;font-size:.85rem;color:var(--text2);margin-top:2px}
/* Scene action buttons inline */
.scene-act-btn{background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:10px 16px;color:var(--text);font-family:var(--fn);font-size:.9rem;cursor:pointer;transition:border-color .15s;min-height:44px;margin-top:8px;display:inline-block;margin-right:8px}
.scene-act-btn:hover{border-color:var(--gold)}
/* CC crossfade */
.ccs{transition:opacity .2s ease}
</style>
</head>
<body>
<div id="landing">
<canvas id="particles"></canvas>
<div id="landing-content">
<h1 id="landing-title">Minute Adventurer</h1>
<p id="landing-sub">Welcome, Adventurer</p>
<div id="landing-buttons"></div>
</div>
<div id="landing-version">v1.0 &middot; A text adventure</div>
</div>
<div id="app" role="application" aria-label="The Muddy Trail text adventure game">
<header id="hud" role="banner" aria-label="Character status">
<div id="hud-l">
<canvas id="hud-portrait" width="32" height="32" aria-label="Character portrait"></canvas>
<div id="hud-info"><div id="hud-nc" aria-live="polite"></div>
<div id="hud-bars">
<div class="bar-row"><div class="bar-o" id="hp-bar-o" role="progressbar" aria-label="Hit points" aria-valuemin="0"><div class="bar-i bar-hp" id="hp-bar-i" style="width:100%"></div></div><span class="bar-txt" id="hp-txt" aria-live="polite">20/20 HP</span></div>
<div class="bar-row"><div class="bar-o" id="mp-bar-o" role="progressbar" aria-label="Mana points" aria-valuemin="0"><div class="bar-i bar-mp" id="mp-bar-i" style="width:100%"></div></div><span class="bar-txt" id="mp-txt" aria-live="polite">20/20 MP</span></div>
<span class="bar-txt" id="gold-txt" aria-label="Gold" aria-live="polite" style="color:var(--gold);font-size:.75rem">0g</span>
</div></div></div>
<div id="hud-r">
<div id="hud-explore">
<button class="hbtn" id="b-char" aria-label="Open character sheet" title="Character"><canvas width="20" height="20" aria-hidden="true"></canvas><span>Char</span></button>
<button class="hbtn" id="b-jrn" aria-label="Journal locked" title="Journal" disabled><canvas width="20" height="20" aria-hidden="true"></canvas><span>Jrnl</span></button>
<button class="hbtn" id="b-menu" aria-label="Open menu" title="Menu"><canvas width="20" height="20" aria-hidden="true"></canvas><span>Menu</span></button>
</div>
<div id="hud-combat">
<button class="hbtn" id="b-atk" aria-label="Attack"><canvas width="20" height="20" aria-hidden="true"></canvas><span id="atk-lbl">Atk</span></button>
<button class="hbtn" id="b-def" aria-label="Block"><canvas width="20" height="20" aria-hidden="true"></canvas><span>Block</span></button>
<button class="hbtn" id="b-item" aria-label="Use item"><canvas width="20" height="20" aria-hidden="true"></canvas><span>Item</span></button>
</div>
</div></header>
<main id="cc" role="main" aria-label="Character creation">
<h1>The Muddy Trail</h1><p class="sub">A Text Adventure</p>
<div class="cc-step" id="cc-step"></div>
<div class="ccs act" id="ccs1" aria-label="Step 1: Name"><h2>What is your name, traveler?</h2><input type="text" id="ninp" maxlength="20" placeholder="Enter name..." aria-label="Character name" autocomplete="off"></div>
<div class="ccs" id="ccs2" aria-label="Step 2: Species"><h2>Choose Your Heritage</h2><div class="ccds" id="sp-cards" role="radiogroup" aria-label="Species"></div></div>
<div class="ccs" id="ccs3" aria-label="Step 3: Subspecies"><h2>Choose Your Lineage</h2><div class="ccds" id="subsp-cards" role="radiogroup" aria-label="Subspecies"></div></div>
<div class="ccs" id="ccs4" aria-label="Step 4: Bonus Stats"><h2>Your Adaptable Heritage</h2><p class="sub" style="margin-bottom:10px">Assign +1 to two different stats.</p><div class="hb-pts" id="hb-pts">Points remaining: 2</div><div id="hb-list"></div></div>
<div class="ccs" id="ccs5" aria-label="Step 5: Class"><h2>Choose Your Path</h2><div class="ccds" id="cl-cards" role="radiogroup" aria-label="Class"></div></div>
<div class="ccs" id="ccs6" aria-label="Step 6: Confirm"><h2>Your Character</h2><div class="csum" id="cc-sum"></div></div>
<div class="ccnv" id="cc-nav"><button class="ccnb" id="cc-bk" aria-label="Go back" style="display:none">Back</button><button class="ccnb pri" id="cc-nx" aria-label="Continue">Continue</button></div>
</main>
<div id="game" style="display:none;flex:1;flex-direction:column;overflow:hidden">
<div id="zone-display" aria-label="Combat zone">
<div class="zone-labels">
<button class="zone-lbl" data-zone="close">CLOSE</button>
<button class="zone-lbl" data-zone="mid">MID</button>
<button class="zone-lbl" data-zone="far">FAR</button>
</div>
<span id="zone-enemy-info"></span>
<div id="enemy-hp-wrap">
<div id="enemy-hp-name"></div>
<div class="enemy-hp-bar"><div class="enemy-hp-fill ehp-high" id="enemy-hp-fill"></div></div>
<div id="enemy-hp-text"></div>
</div>
</div>
<div id="hit-flash"></div>
<div id="narr-w" role="log" aria-label="Story narrative" aria-live="polite" tabindex="-1"><div id="narr-log"></div></div>
</div>
<div id="bbar" aria-label="Actions and input">
<div id="explore-bar">
<button class="acts-btn" id="b-acts" aria-label="Choose an action">Actions</button>
</div>
<div id="combat-bar">
    <button class="cbtn" id="cb-atk">Attack<span class="pct" id="cb-atk-pct"></span></button>
    <button class="cbtn" id="cb-ability" style="display:none"><span id="cb-ability-name">Ability</span><span class="pct" id="cb-ability-cost"></span></button>
    <button class="cbtn" id="cb-move">Move</button>
    <button class="cbtn" id="cb-block">Block</button>
    <button class="cbtn" id="cb-flee">Flee<span class="pct" id="cb-flee-pct"></span></button>
    <button class="cbtn" id="cb-item">Item</button>
</div>
</div></div>
<div class="mo" id="m-act" role="dialog" aria-label="Actions" aria-modal="true"><div class="mc"><div class="mh"><h2 class="mt">Actions</h2><button class="mx" aria-label="Close">&times;</button></div><div class="mb" id="m-act-b"></div></div></div>
<div class="mo" id="m-char" role="dialog" aria-label="Character" aria-modal="true"><div class="mc"><div class="mh"><h2 class="mt">Character</h2><button class="mx" aria-label="Close">&times;</button></div><div class="mb" id="m-char-b"></div></div></div>
<div class="mo" id="m-jrn" role="dialog" aria-label="Journal" aria-modal="true"><div class="mc"><div class="mh"><h2 class="mt">Player's Guide</h2><button class="mx" aria-label="Close">&times;</button></div><div class="mb" id="m-jrn-b"></div></div></div>
<div class="mo" id="m-menu" role="dialog" aria-label="Menu" aria-modal="true"><div class="mc"><div class="mh"><h2 class="mt">Menu</h2><button class="mx" aria-label="Close">&times;</button></div><div class="mb" id="m-menu-b"></div></div></div>
<div class="mo" id="m-dlg" role="dialog" aria-label="Dialogue" aria-modal="true"><div class="mc"><div class="mh"><h2 class="mt" id="dlg-t">NPC</h2><span></span></div><div class="mb" id="m-dlg-b"></div></div></div>
<div class="mo" id="m-lvl" role="dialog" aria-label="Level Up" aria-modal="true"><div class="mc"><div class="mh"><h2 class="mt">Level Up!</h2><span></span></div><div class="mb" id="m-lvl-b"></div></div></div>
<div id="title-card" aria-live="assertive"><h2 id="tc-name"></h2><p id="tc-sub"></p></div>
<div id="death-screen" aria-live="assertive"><h2>YOU HAVE FALLEN</h2><p class="dq" id="death-quote"></p><button class="ds-btn" id="ds-load">Load Last Save</button><button class="ds-btn" id="ds-new">New Adventure</button><button class="ds-btn" id="ds-title">Return to Title</button></div>
<div id="as-backdrop"></div>
<div id="action-sheet" role="dialog" aria-label="Actions"><div class="as-h">Actions</div><div id="as-list"></div></div>
<script src="data.js"></script>
<script>
/* =====================================================================
   THE MUDDY TRAIL â€” Complete Game Engine v2
   8-stat system, 5 species, subspecies, percentage combat, mana, weight
   ===================================================================== */

// === PIXEL ART SYSTEM ===
const PA={
draw(ctx,d,sz){const p=sz/d.length;for(let y=0;y<d.length;y++)for(let x=0;x<d[y].length;x++)if(d[y][x]){ctx.fillStyle=d[y][x];ctx.fillRect(Math.floor(x*p),Math.floor(y*p),Math.ceil(p),Math.ceil(p))}},
C:{sk:'#e0b088',skD:'#c89868',skG:'#a0c890',skR:'#d4a574',hr:'#4a3520',hrL:'#c8a060',hrC:'#8b6840',
ey:'#446688',eyD:'#223344',mt:'#a0a0b0',mtD:'#707080',mtL:'#c8c8d8',
lt:'#8b6840',ltD:'#6b4820',cl:'#404060',clL:'#606080',
gd:'#c9a84c',gn:'#4a7c59',gnD:'#385c44',rd:'#8b2635',
wh:'#e8e8f0',bk:'#1a1a2e',gy:'#6b6b7b',tk:'#d8d0c0'},
species:{
human(){const o='#1a1a2e',s='#e0b088',h='#4a3520',e='#446688',r='#8b2635',c='#404060',_=null;return[
[_,_,_,_,o,h,h,h,h,h,o,_,_,_,_,_],
[_,_,_,o,h,h,h,h,h,h,h,o,_,_,_,_],
[_,_,o,h,h,h,h,h,h,h,h,h,o,_,_,_],
[_,_,o,s,s,s,s,s,s,s,s,s,o,_,_,_],
[_,o,s,s,s,s,s,s,s,s,s,s,s,o,_,_],
[_,o,s,s,e,o,s,s,s,e,o,s,s,o,_,_],
[_,o,s,s,s,s,s,s,s,s,s,s,s,o,_,_],
[_,_,o,s,s,s,s,s,s,s,s,s,o,_,_,_],
[_,_,o,s,s,s,s,s,s,s,s,s,o,_,_,_],
[_,_,_,o,s,s,s,s,s,s,s,o,_,_,_,_],
[_,_,_,o,s,s,r,r,r,s,s,o,_,_,_,_],
[_,_,_,_,o,s,s,s,s,s,o,_,_,_,_,_],
[_,_,_,_,_,o,s,s,s,o,_,_,_,_,_,_],
[_,_,_,_,o,c,c,c,c,c,o,_,_,_,_,_],
[_,_,_,o,c,c,c,c,c,c,c,o,_,_,_,_],
[_,_,_,o,c,c,c,c,c,c,c,o,_,_,_,_]]},
elf(){const o='#1a1a2e',s='#e0b088',h='#c8a060',e='#5a9c6a',g='#385c44',_=null;return[
[_,_,_,_,o,h,h,h,h,h,o,_,_,_,_,_],
[_,_,_,o,h,h,h,h,h,h,h,o,_,_,_,_],
[_,_,o,h,h,h,h,h,h,h,h,h,o,_,_,_],
[_,o,s,s,s,s,s,s,s,s,s,s,s,o,_,_],
[o,s,s,s,s,s,s,s,s,s,s,s,s,s,o,_],
[_,o,s,s,e,o,s,s,s,e,o,s,s,o,_,_],
[_,o,s,s,s,s,s,s,s,s,s,s,s,o,_,_],
[_,_,o,s,s,s,s,s,s,s,s,s,o,_,_,_],
[_,_,o,s,s,s,s,s,s,s,s,s,o,_,_,_],
[_,_,_,o,s,s,s,s,s,s,s,o,_,_,_,_],
[_,_,_,o,s,s,s,s,s,s,s,o,_,_,_,_],
[_,_,_,_,o,s,s,s,s,s,o,_,_,_,_,_],
[_,_,_,_,_,o,s,s,s,o,_,_,_,_,_,_],
[_,_,_,_,o,g,g,g,g,g,o,_,_,_,_,_],
[_,_,_,o,g,e,g,g,g,e,g,o,_,_,_,_],
[_,_,_,o,g,g,g,g,g,g,g,o,_,_,_,_]]},
orc(){const o='#1a1a2e',s='#a0c890',h='#4a3520',r='#8b2635',g='#c9a84c',t='#d8d0c0',l='#8b6840',_=null;return[
[_,_,_,_,o,h,h,h,h,h,o,_,_,_,_,_],
[_,_,_,o,h,h,h,h,h,h,h,o,_,_,_,_],
[_,_,o,s,s,s,s,s,s,s,s,s,o,_,_,_],
[_,o,s,s,s,s,s,s,s,s,s,s,s,o,_,_],
[o,s,s,s,s,s,s,s,s,s,s,s,s,s,o,_],
[o,s,s,s,r,g,s,s,s,r,g,s,s,s,o,_],
[o,s,s,s,s,s,s,s,s,s,s,s,s,s,o,_],
[_,o,s,s,s,s,s,o,s,s,s,s,s,o,_,_],
[_,o,s,s,s,s,o,o,o,s,s,s,s,o,_,_],
[_,_,o,s,s,t,s,s,s,t,s,s,o,_,_,_],
[_,_,o,s,t,s,o,o,o,s,t,s,o,_,_,_],
[_,_,_,o,s,s,s,s,s,s,s,o,_,_,_,_],
[_,_,_,_,o,s,s,s,s,s,o,_,_,_,_,_],
[_,_,_,o,l,l,l,l,l,l,l,o,_,_,_,_],
[_,_,o,l,l,o,l,l,l,o,l,l,o,_,_,_],
[_,_,o,l,l,l,l,l,l,l,l,l,o,_,_,_]]},
dwarf(){const o='#1a1a2e',s='#d4a574',h='#4a3520',e='#446688',m='#a0a0b0',g='#c9a84c',_=null;return[
[_,_,_,o,h,h,h,h,h,h,h,h,o,_,_,_],
[_,_,o,h,h,h,h,h,h,h,h,h,h,o,_,_],
[_,o,s,s,s,s,s,s,s,s,s,s,s,s,o,_],
[_,o,s,s,s,s,s,s,s,s,s,s,s,s,o,_],
[_,o,s,s,e,o,s,s,s,e,o,s,s,s,o,_],
[_,o,s,s,s,s,s,o,s,s,s,s,s,s,o,_],
[_,_,o,s,h,h,s,h,h,h,s,h,h,o,_,_],
[_,_,o,s,h,h,h,h,h,h,h,h,s,o,_,_],
[_,_,_,o,h,h,h,h,h,h,h,o,_,_,_,_],
[_,_,_,_,o,h,h,h,h,h,o,_,_,_,_,_],
[_,_,_,_,_,o,h,h,h,o,_,_,_,_,_,_],
[_,_,_,_,_,_,o,h,o,_,_,_,_,_,_,_],
[_,_,_,o,m,m,m,m,m,m,m,m,m,o,_,_],
[_,_,o,m,m,o,m,m,m,o,m,m,m,o,_,_],
[_,_,o,m,m,m,m,g,g,m,m,m,m,o,_,_],
[_,_,o,m,m,m,m,m,m,m,m,m,m,o,_,_]]},
halfling(){const o='#1a1a2e',s='#e0b088',h='#8b6840',e='#5a9c6a',r='#8b2635',g='#385c44',_=null;return[
[_,_,_,_,_,o,h,h,h,h,o,_,_,_,_,_],
[_,_,_,_,o,h,h,h,h,h,h,o,_,_,_,_],
[_,_,_,o,h,h,h,h,h,h,h,h,o,_,_,_],
[_,_,_,o,s,s,s,s,s,s,s,s,o,_,_,_],
[_,_,o,s,s,s,s,s,s,s,s,s,s,o,_,_],
[_,_,o,s,e,e,s,s,s,e,e,s,s,o,_,_],
[_,_,o,s,o,e,s,s,s,o,e,s,s,o,_,_],
[_,_,o,s,s,s,s,o,s,s,s,s,s,o,_,_],
[_,_,_,o,s,s,s,s,s,s,s,s,o,_,_,_],
[_,_,_,o,s,s,o,o,o,s,s,o,_,_,_,_],
[_,_,_,_,o,s,r,r,r,s,o,_,_,_,_,_],
[_,_,_,_,_,o,s,s,s,o,_,_,_,_,_,_],
[_,_,_,_,_,o,s,s,o,_,_,_,_,_,_,_],
[_,_,_,_,o,g,g,g,g,g,o,_,_,_,_,_],
[_,_,_,o,g,e,g,g,e,g,g,o,_,_,_,_],
[_,_,_,o,g,g,g,g,g,g,g,o,_,_,_,_]]}
},
icons:{
pack(){const c=PA.C,_=null;return[[_,_,c.lt,c.lt,c.lt,c.lt,_,_],[_,c.lt,c.ltD,c.ltD,c.ltD,c.ltD,c.lt,_],[c.lt,c.ltD,c.lt,c.lt,c.lt,c.lt,c.ltD,c.lt],[c.lt,c.ltD,c.lt,c.gd,c.gd,c.lt,c.ltD,c.lt],[c.lt,c.ltD,c.lt,c.lt,c.lt,c.lt,c.ltD,c.lt],[c.lt,c.ltD,c.ltD,c.ltD,c.ltD,c.ltD,c.ltD,c.lt],[_,c.lt,c.lt,c.lt,c.lt,c.lt,c.lt,_],[_,_,c.lt,c.lt,c.lt,c.lt,_,_]]},
save(){const c=PA.C;return[[c.mt,c.mt,c.mt,c.mt,c.mt,c.mt,c.mt,c.mt],[c.mt,c.mtD,c.mtD,c.mtD,c.mtD,c.mtD,c.mt,c.mt],[c.mt,c.mtD,c.mtD,c.mtD,c.mtD,c.mtD,c.mt,c.mt],[c.mt,c.mtD,c.mtD,c.mtD,c.mtD,c.mtD,c.mt,c.mt],[c.mt,c.mt,c.mt,c.mt,c.mt,c.mt,c.mt,c.mt],[c.mt,c.mtL,c.mt,c.mtL,c.mtL,c.mt,c.mtL,c.mt],[c.mt,c.mtL,c.mt,c.mtL,c.mtL,c.mt,c.mtL,c.mt],[c.mt,c.mt,c.mt,c.mt,c.mt,c.mt,c.mt,c.mt]]},
person(){const t='#a89f8c',_=null;return[
[_,_,_,t,t,_,_,_],
[_,_,t,t,t,t,_,_],
[_,_,_,t,t,_,_,_],
[_,_,_,t,_,_,_,_],
[_,_,t,t,t,_,_,_],
[_,t,_,t,_,t,_,_],
[_,_,_,t,t,_,_,_],
[_,_,t,_,_,t,_,_]]},
book(){const t='#a89f8c',g='#c9a84c',_=null;return[
[_,t,t,t,t,t,t,_],
[t,t,g,g,t,t,t,t],
[t,t,_,_,t,t,_,t],
[t,t,g,g,t,t,g,t],
[t,t,_,_,t,t,_,t],
[t,t,g,g,t,t,g,t],
[t,t,t,t,t,t,t,t],
[_,t,t,t,t,t,t,_]]},
menu(){const t='#a89f8c',_=null;return[
[_,_,_,_,_,_,_,_],
[_,t,t,t,t,t,t,_],
[_,_,_,_,_,_,_,_],
[_,t,t,t,t,t,t,_],
[_,_,_,_,_,_,_,_],
[_,t,t,t,t,t,t,_],
[_,_,_,_,_,_,_,_],
[_,_,_,_,_,_,_,_]]},
sword(){const t='#a89f8c',g='#c9a84c',w='#e8e8f0',_=null;return[
[_,_,_,_,_,_,w,_],
[_,_,_,_,_,w,t,_],
[_,_,_,_,w,t,_,_],
[_,_,_,w,t,_,_,_],
[_,_,g,w,g,_,_,_],
[_,_,_,g,_,_,_,_],
[_,_,g,_,_,_,_,_],
[_,_,_,_,_,_,_,_]]},
shield(){const t='#a89f8c',g='#c9a84c',_=null;return[
[_,t,t,t,t,t,t,_],
[t,t,t,g,g,t,t,t],
[t,t,g,g,g,g,t,t],
[t,t,t,g,g,t,t,t],
[_,t,t,t,t,t,t,_],
[_,_,t,t,t,t,_,_],
[_,_,_,t,t,_,_,_],
[_,_,_,_,_,_,_,_]]},
potion(){const t='#a89f8c',r='#c44054',w='#e8e8f0',_=null;return[
[_,_,_,t,t,_,_,_],
[_,_,_,t,t,_,_,_],
[_,_,t,_,_,t,_,_],
[_,t,r,r,r,r,t,_],
[_,t,r,w,r,r,t,_],
[_,t,r,r,r,r,t,_],
[_,t,r,r,r,r,t,_],
[_,_,t,t,t,t,_,_]]}
},
classIcons:{
fighter(){const t='#a0a0b4',g='#c9a84c',_=null;return[
[_,_,_,_,_,_,_,_,_,_,_,_,t,t,_,_],
[_,_,_,_,_,_,_,_,_,_,_,t,t,t,_,_],
[_,_,_,_,_,_,_,_,_,_,t,t,_,_,_,_],
[_,_,_,_,_,_,_,_,_,t,t,_,_,_,_,_],
[_,_,_,_,_,_,_,_,t,t,_,_,_,_,_,_],
[_,_,_,_,_,_,_,t,t,_,_,_,_,_,_,_],
[_,_,_,_,_,g,t,g,_,_,_,_,_,_,_,_],
[_,_,_,_,g,_,g,_,_,_,_,_,_,_,_,_],
[_,_,_,g,_,_,_,_,t,t,_,_,_,_,_,_],
[_,_,_,_,_,_,_,t,t,t,t,_,_,_,_,_],
[_,_,_,_,_,_,t,t,g,g,t,t,_,_,_,_],
[_,_,_,_,_,_,t,t,g,g,t,t,_,_,_,_],
[_,_,_,_,_,_,_,t,t,t,t,_,_,_,_,_],
[_,_,_,_,_,_,_,_,t,t,_,_,_,_,_,_],
[_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
[_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_]]},
paladin(){const t='#a0a0b4',g='#c9a84c',_=null;return[
[_,_,_,_,_,t,t,t,t,t,t,_,_,_,_,_],
[_,_,_,_,t,t,t,t,t,t,t,t,_,_,_,_],
[_,_,_,t,t,t,t,g,g,t,t,t,t,_,_,_],
[_,_,t,t,t,t,g,g,g,g,t,t,t,t,_,_],
[_,_,t,t,t,t,t,g,g,t,t,t,t,t,_,_],
[_,_,t,t,t,t,t,g,g,t,t,t,t,t,_,_],
[_,_,t,t,t,t,t,t,t,t,t,t,t,t,_,_],
[_,_,t,t,t,t,t,t,t,t,t,t,t,t,_,_],
[_,_,_,t,t,t,t,t,t,t,t,t,t,_,_,_],
[_,_,_,_,t,t,t,t,t,t,t,t,_,_,_,_],
[_,_,_,_,_,t,t,t,t,t,t,_,_,_,_,_],
[_,_,_,_,_,_,t,t,t,t,_,_,_,_,_,_],
[_,_,_,_,_,_,_,t,t,_,_,_,_,_,_,_],
[_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
[_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
[_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_]]},
ranger(){const t='#a0a0b4',g='#c9a84c',_=null;return[
[_,_,_,_,_,_,_,_,_,_,_,_,_,t,_,_],
[_,_,_,_,_,_,_,_,_,_,_,_,t,_,_,_],
[_,_,_,t,_,_,_,_,_,_,_,t,_,_,_,_],
[_,_,t,_,_,_,_,_,_,_,t,_,_,_,_,_],
[_,t,_,_,_,_,_,_,_,t,_,_,_,_,_,_],
[_,t,_,_,_,_,_,_,t,_,_,_,_,_,_,_],
[_,t,_,_,_,_,_,t,_,_,_,_,_,_,_,_],
[_,t,_,_,_,_,t,_,_,_,_,_,_,_,_,_],
[_,t,_,_,_,t,_,_,_,_,_,_,_,_,_,_],
[_,_,t,_,t,_,_,_,_,_,_,_,_,_,_,_],
[_,_,_,t,t,_,_,_,_,_,_,_,_,_,_,_],
[_,_,_,t,_,_,_,_,_,_,_,_,_,_,_,_],
[_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
[_,g,g,g,g,g,g,g,g,g,g,g,g,g,g,_],
[_,_,_,_,_,_,_,_,_,_,_,_,_,g,_,_],
[_,_,_,_,_,_,_,_,_,_,_,_,_,_,g,_]]},
rogue(){const t='#a0a0b4',r='#c44054',_=null;return[
[_,_,_,_,_,_,_,_,_,_,_,t,t,_,_,_],
[_,_,_,_,_,_,_,_,_,_,t,t,_,_,_,_],
[_,_,_,_,_,_,_,_,_,t,t,_,_,_,_,_],
[_,_,_,_,_,_,_,_,t,t,_,_,_,_,_,_],
[_,_,_,_,_,_,_,t,t,_,_,_,_,_,_,_],
[_,_,_,_,_,_,t,t,_,_,_,_,_,_,_,_],
[_,_,_,_,_,t,t,_,_,_,_,_,_,_,_,_],
[_,_,_,_,t,t,_,_,_,_,_,_,_,_,_,_],
[_,_,_,t,t,t,t,_,_,_,_,_,_,_,_,_],
[_,_,t,t,_,_,t,t,_,_,_,_,_,_,_,_],
[_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
[_,_,_,_,_,_,_,_,r,_,_,_,_,_,_,_],
[_,_,_,_,_,_,_,_,_,r,_,_,_,_,_,_],
[_,_,_,_,_,_,_,_,_,_,r,_,_,_,_,_],
[_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
[_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_]]},
wizard(){const t='#a0a0b4',g='#c9a84c',_=null;return[
[_,_,_,_,_,_,_,g,_,_,_,_,_,_,_,_],
[_,_,_,_,_,_,t,g,t,_,_,_,_,_,_,_],
[_,_,_,_,_,t,t,t,t,t,_,_,_,_,_,_],
[_,_,_,_,t,t,t,g,t,t,t,_,_,_,_,_],
[_,_,_,t,t,t,g,t,g,t,t,t,_,_,_,_],
[_,_,t,t,t,t,t,t,t,t,t,t,t,_,_,_],
[_,t,t,t,t,t,t,t,t,t,t,t,t,t,_,_],
[t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,_],
[_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
[_,_,_,_,_,g,_,_,_,_,g,_,_,_,_,_],
[_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
[_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
[_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
[_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
[_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
[_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_]]},
berserker(){const t='#a0a0b4',r='#c44054',_=null;return[
[_,_,_,t,_,_,_,_,_,_,_,_,t,_,_,_],
[_,_,t,t,_,_,_,_,_,_,_,_,t,t,_,_],
[_,_,t,_,_,_,_,_,_,_,_,_,_,t,_,_],
[_,_,_,_,_,t,t,t,t,t,t,_,_,_,_,_],
[_,_,_,_,t,t,t,t,t,t,t,t,_,_,_,_],
[_,_,_,t,t,r,t,t,t,t,r,t,t,_,_,_],
[_,_,_,t,t,t,r,t,t,r,t,t,t,_,_,_],
[_,_,_,t,t,t,t,t,t,t,t,t,t,_,_,_],
[_,_,_,t,t,t,t,t,t,t,t,t,t,_,_,_],
[_,_,_,_,t,t,t,_,t,t,t,_,_,_,_,_],
[_,_,_,_,_,t,t,_,t,t,_,_,_,_,_,_],
[_,_,_,_,_,_,t,t,t,_,_,_,_,_,_,_],
[_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
[_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
[_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_],
[_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_]]}
},
renderIcon(cv,fn){const x=cv.getContext('2d');x.clearRect(0,0,cv.width,cv.height);this.draw(x,fn(),cv.width)},
renderClassIcon(cv,k){const x=cv.getContext('2d');x.clearRect(0,0,cv.width,cv.height);const fn=this.classIcons[k];if(fn)this.draw(x,fn(),cv.width)},
renderPortrait(cv,k){const x=cv.getContext('2d');x.clearRect(0,0,cv.width,cv.height);const fn=this.species[k];if(fn)this.draw(x,fn(),cv.width)}
};

// === SPECIES DATA ===
const STAT_NAMES=['health','mana','melee','ranged','speech','sight','smarts','movement'];
const STAT_LABELS={health:'Health',mana:'Mana',melee:'Melee',ranged:'Ranged',speech:'Speech',sight:'Sight',smarts:'Smarts',movement:'Movement'};
const SP={
human:{name:'Human',desc:'Versatile and driven. What humans lack in specialization, they make up for in sheer determination.',
  trait:'Adaptable',traitDesc:'+1 to any two different stats during creation.',
  stats:{health:5,mana:5,melee:5,ranged:5,speech:5,sight:5,smarts:5,movement:5},subspecies:null},
elf:{name:'Elf',desc:'Ancient and attuned. Elves see what others miss and channel magic as naturally as breathing.',
  stats:{health:3,mana:7,melee:4,ranged:7,speech:5,sight:6,smarts:5,movement:5},
  subspecies:{
    duskelf:{name:'Duskelf',desc:'Where light fails, Duskelves thrive. Their eyes pierce shadow, their arrows find throats.',
      trait:'Twilight Instinct',traitDesc:'+1 Sight checks. First attack each combat has advantage. Cannot be ambushed.'},
    brightelf:{name:'Brightelf',desc:'Brightelves burn with arcane fire \u2014 scholars and channelers bending raw magic to their will.',
      trait:'Arcane Attunement',traitDesc:'+4 bonus max MP. +1 extra MP regen per scene transition.'}}},
orc:{name:'Orc',desc:'Born to fight. Orcs are walking siege engines \u2014 massive, terrifying, and relentless.',
  stats:{health:8,mana:2,melee:7,ranged:3,speech:3,sight:5,smarts:4,movement:6},
  subspecies:{
    bloodborn:{name:'Bloodborn',desc:'Bloodborn orcs honor the ancient traditions of violence. Every scar is a badge.',
      trait:'Bloodrage',traitDesc:'+1 melee damage. +2 melee damage when HP below 40%.'},
    ashborn:{name:'Ashborn',desc:'Ashborn orcs walked out of the tribal fires and into civilization. Books instead of skulls.',
      trait:'Civilized Mind',traitDesc:'+4 bonus max MP. +1 to Speech and Smarts checks.'}}},
dwarf:{name:'Dwarf',desc:'Stubborn as stone. Dwarves endure what would break others. Slow to trust, impossible to put down.',
  stats:{health:7,mana:4,melee:6,ranged:4,speech:4,sight:6,smarts:5,movement:3},
  subspecies:{
    stoneblood:{name:'Stoneblood',desc:'Stoneblood dwarves are the mountain given flesh. They don\u2019t dodge. They just keep coming.',
      trait:'Stone Skin',traitDesc:'Reduce all incoming damage by 1 (min 1). Immune to poison.'},
    fireblood:{name:'Fireblood',desc:'Fireblood dwarves channel volcanic fury. They hit harder than anything their size should.',
      trait:'Volcanic Fury',traitDesc:'+2 bonus melee damage. Take +1 extra incoming damage.'}}},
halfling:{name:'Halfling',desc:'Small, fast, and dangerously resourceful. Halflings don\u2019t fight fair \u2014 they fight smart.',
  stats:{health:3,mana:6,melee:3,ranged:6,speech:7,sight:6,smarts:5,movement:6},
  subspecies:{
    quickfoot:{name:'Quickfoot',desc:'Quickfoot halflings are impossible to corner. They dart between legs and never stop moving.',
      trait:'Nimble Escape',traitDesc:'+2 effective Movement in combat (after weight penalties).'},
    shadowstep:{name:'Shadowstep',desc:'Shadowstep halflings are patient killers. They wait in the dark and strike once \u2014 devastatingly.',
      trait:'Vanish',traitDesc:'Once per combat: spend 2 MP to hide. Next attack deals double damage.'}}}
};

// === CLASS DATA ===
const WT_NAMES=['Light','Medium','Heavy'];
const CL={
fighter:{name:'Fighter',desc:'No tricks, no magic. Just steel and the skill to use it.',
  abilities:[
    {name:'Power Strike',desc:'Next melee attack deals double damage.',cost:4,type:'buff',trigger:'melee_hit',effect:{dmgMult:2},requirement:'close_zone',unlockLevel:1},
    {name:'Shield Bash',desc:'Melee attack with 30% stun chance.',cost:3,type:'attack',effect:{dmgDice:[6],statusChance:30,status:'stun',statusDuration:1},requirement:'close_zone',unlockLevel:4},
    {name:'Battle Cry',desc:'+1 dmg, +5% hit for 4 turns.',cost:6,type:'buff',trigger:'sustained',effect:{dmgBonus:1,hitBonus:5,duration:4},requirement:null,unlockLevel:8}],
  wpn:{name:'Sword',t:'melee',wt:1,dD:8,dB:0,desc:'Melee, 1d8'},oh:null,
  arm:{name:'Chainmail',dB:2,wt:1,desc:'+2 defense (Medium)'},bp:[]},
paladin:{name:'Paladin',desc:'Faith is my shield. Duty is my blade.',
  abilities:[
    {name:'Holy Light',desc:'Heal self for 8 HP.',cost:5,type:'heal',effect:{healAmt:8},requirement:null,unlockLevel:1},
    {name:'Smite',desc:'2d8 holy damage, +50% vs undead.',cost:5,type:'attack',effect:{dmgDice:[8,8],bonusVsTag:'undead',bonusMult:1.5},requirement:'close_zone',unlockLevel:4},
    {name:'Divine Shield',desc:'Immune to damage for 1 turn.',cost:8,type:'buff',trigger:'sustained',effect:{dmgImmunity:true,duration:1},requirement:null,unlockLevel:8}],
  wpn:{name:'Sword',t:'melee',wt:1,dD:8,dB:0,desc:'Melee, 1d8'},
  oh:{name:'Wooden Shield',t:'shield',wt:1,blk:2,desc:'+2 block (Medium)'},
  arm:{name:'Chainmail',dB:2,wt:1,desc:'+2 defense (Medium)'},bp:[]},
ranger:{name:'Ranger',desc:'One arrow. One kill. That\'s all it takes if you\'re patient.',
  abilities:[
    {name:'Aimed Shot',desc:'Next ranged attack gains +20% hit, ignores zone penalties.',cost:3,type:'buff',trigger:'ranged_hit',effect:{hitBonus:20,ignoreZonePenalty:true},requirement:'mid_or_far_zone',unlockLevel:1},
    {name:'Multi-Shot',desc:'Two attacks at -15% accuracy each.',cost:4,type:'attack',effect:{dmgDice:[6],multiHit:2,hitPenalty:-15},requirement:null,unlockLevel:4},
    {name:'Track',desc:'+25% hit on next attack.',cost:2,type:'buff',trigger:'any_hit',effect:{hitBonus:25},requirement:null,unlockLevel:8}],
  wpn:{name:'Shortbow',t:'ranged',wt:0,dD:6,dB:0,desc:'Ranged, 1d6',ammo:10},
  oh:{name:'Quiver',t:'quiver',wt:0,desc:'10 arrows',arrows:10},
  arm:{name:'Leather Armor',dB:1,wt:0,desc:'+1 defense (Light)'},bp:[{name:'Dagger',t:'melee',wt:0,dD:4,dB:2,desc:'Melee, 1d4+2'}]},
rogue:{name:'Rogue',desc:'Fair fights are for people who can\'t plan ahead.',
  abilities:[
    {name:'Backstab',desc:'Triple damage if first turn or moved this turn.',cost:4,type:'buff',trigger:'melee_hit',effect:{dmgMult:3,condDmgMult:1},conditions:['first_turn','moved_this_turn'],requirement:'close_zone',unlockLevel:1},
    {name:'Smoke Bomb',desc:'Guaranteed flee from any range.',cost:3,type:'special',effect:{guaranteedFlee:true},requirement:null,unlockLevel:4},
    {name:'Assassinate',desc:'5x damage if hidden (Vanish).',cost:6,type:'buff',trigger:'melee_hit',effect:{dmgMult:5,condDmgMult:1},conditions:['hidden'],requirement:'close_zone',unlockLevel:8}],
  wpn:{name:'Dagger',t:'melee',wt:0,dD:4,dB:2,desc:'Melee, 1d4+2'},
  oh:{name:'Lantern',t:'light',wt:0,desc:'Illuminates dark areas'},
  arm:{name:'Leather Armor',dB:1,wt:0,desc:'+1 defense (Light)'},bp:[]},
wizard:{name:'Wizard',desc:'While you were learning to swing a sword, I was reading. And reading wins.',
  abilities:[
    {name:'Arcane Bolt',desc:'Ranged magic attack: 2d6 damage, uses Smarts to hit.',cost:3,type:'attack',effect:{dmgDice:[6,6],statOverride:'smarts'},requirement:'spellbook_equipped',unlockLevel:1},
    {name:'Fireball',desc:'3d6 fire damage. Burns the enemy.',cost:6,type:'attack',effect:{dmgDice:[6,6,6],statusChance:50,status:'burn',statusDuration:3,statusDmg:2},requirement:'spellbook_equipped',unlockLevel:4},
    {name:'Mana Shield',desc:'Absorb damage with MP for 3 turns.',cost:4,type:'buff',trigger:'sustained',effect:{manaShield:true,duration:3},requirement:null,unlockLevel:8}],
  wpn:{name:'Staff',t:'melee',wt:0,dD:4,dB:0,desc:'Melee, 1d4'},
  oh:{name:'Spellbook',t:'spellbook',wt:0,desc:'Required for spell abilities'},
  arm:{name:'Robes',dB:0,wt:0,desc:'+0 defense (Light)'},bp:[]},
berserker:{name:'Berserker',desc:'You think pain stops me? Pain makes me STRONGER.',
  abilities:[
    {name:'Aggro',desc:'+2 melee dmg, +10% hit, +1 incoming dmg for 3 turns.',cost:5,type:'buff',trigger:'sustained',effect:{dmgBonus:2,hitBonus:10,incomingDmgBonus:1,duration:3},requirement:null,unlockLevel:1},
    {name:'Rampage',desc:'Attack twice this turn.',cost:5,type:'attack',effect:{multiHit:2,dmgDice:null,useWeapon:true},requirement:'close_zone',unlockLevel:4},
    {name:'Undying Rage',desc:'Survive lethal damage once (1 HP). Lasts until triggered.',cost:7,type:'buff',trigger:'sustained',effect:{undying:true,duration:99},requirement:null,unlockLevel:8}],
  wpn:{name:'Greataxe',t:'melee',wt:2,dD:10,dB:0,desc:'Melee, 1d10',twoHand:true},
  oh:null,
  arm:{name:'Leather Armor',dB:1,wt:0,desc:'+1 defense (Light)'},bp:[]}
};
// ENEMIES, ITEMS, NPCS, SCENE_DATA, DEATH_QUOTES loaded from data.js
const TIER_LABELS=['','Common','Uncommon','Dangerous','Elite','Boss'];
function getAbilities(r){
  const clDef=CL[r.classes[0]];if(!clDef)return[];
  if(clDef.abilities)return clDef.abilities.filter(a=>!a.unlockLevel||r.level>=a.unlockLevel);
  if(clDef.ability)return[clDef.ability];
  return[];
}
const REDUCED_MOTION=window.matchMedia('(prefers-reduced-motion: reduce)').matches;

// === CALC MODULE ===
const CALC={
clamp(v,lo,hi){return Math.max(lo,Math.min(hi,v))},
pct(v){return this.clamp(Math.round(v),5,95)},
maxHP(r){return r.stats.health*4},
maxMP(r){let b=r.stats.mana*4;if(r.subspecies==='brightelf'||r.subspecies==='ashborn')b+=4;return b},
totalWt(r){return(r.wpn?r.wpn.wt||0:0)+(r.oh?r.oh.wt||0:0)+(r.arm?r.arm.wt||0:0)},
effMov(r){let m=r.stats.movement-this.totalWt(r);if(r.subspecies==='quickfoot')m+=2;return Math.max(1,m)},
combatMove(r){return this.effMov(r)*2},
ZONES:['close','mid','far'],
zoneHitMod(zone,wpnType){
  if(wpnType==='ranged'){if(zone==='close')return -15;if(zone==='far')return -10}
  return 0},
meleeHit(r,eDef,zone){
  let h=55+(r.stats.melee-5)*5-eDef*3;
  if(r.debuffs){r.debuffs.forEach(d=>{if(d.type==='curse')h-=10;if(d.type==='blind')h-=20})}
  return this.pct(h)},
rangedHit(r,eDef,zone){
  let h=55+(r.stats.ranged-5)*5-eDef*3+this.zoneHitMod(zone||'mid','ranged');
  if(r.debuffs){r.debuffs.forEach(d=>{if(d.type==='curse')h-=10;if(d.type==='blind')h-=20})}
  return this.pct(h)},
enemyHit(eAtk,pDef){return this.pct(55+(eAtk-5)*5-pDef*3)},
playerDef(r){return r.arm?r.arm.dB:0},
flee(r){return this.pct(30+(this.effMov(r)-5)*5)},
search(r,diff){return this.pct(50+(r.stats.sight-5)*7+(diff||0))},
speech(r,diff){return this.pct(50+(r.stats.speech-5)*7+(diff||0))},
smarts(r,diff){return this.pct(50+(r.stats.smarts-5)*7+(diff||0))},
meleeDmgMod(r){let d=r.stats.melee-5;
  if(r.subspecies==='bloodborn'){d+=1;if(r.hp<CALC.maxHP(r)*0.4)d+=1}
  if(r.subspecies==='fireblood')d+=2;return d},
rangedDmgMod(r){return r.stats.ranged-5},
abilityCost(r,ability){let c=ability.cost;if(r.stats.smarts>=7)c=Math.max(1,c-1);return c},
arcaneBoltHit(r,eDef){let h=55+(r.stats.smarts-5)*5-eDef*3;if(r.debuffs){r.debuffs.forEach(d=>{if(d.type==='curse')h-=10;if(d.type==='blind')h-=20})}return this.pct(h)},
roll100(){return Math.floor(Math.random()*100)+1},
rollDice(sides){return Math.floor(Math.random()*sides)+1},
safeDmg(d){return isFinite(d)&&d>0?Math.floor(d):1}
};

// === GAME STATE ===
const GS={
run:null,
newRun(nm,sp,subsp,cl,humanBonus){
  const s=SP[sp],c=CL[cl];
  const stats={};STAT_NAMES.forEach(k=>{stats[k]=s.stats[k]||5});
  if(sp==='human'&&humanBonus){humanBonus.forEach(k=>{if(stats[k]!==undefined)stats[k]++})}
  const mHP=CALC.maxHP({stats}),mMP=CALC.maxMP({stats,subspecies:subsp});
  this.run={name:nm,species:sp,subspecies:subsp||'none',classes:[cl],classPoints:{[cl]:0},
    level:1,xp:0,prestigeLevel:0,
    stats,hp:mHP,mp:mMP,mHP,mMP,
    wpn:c.wpn?{...c.wpn}:null,oh:c.oh?{...c.oh}:null,arm:c.arm?{...c.arm}:null,
    bp:c.bp.map(i=>({...i})),gold:0,adventure:'muddy_trail',scene:'trailhead',ss:{},cs:null,
    nlog:[],traitState:{},jrnUnlk:false,hbFound:false,bSeen:{},bDef:{},srch:{},debuffs:[],
    activeBounty:null,bountyBoard:null,activeQuests:[],completedQuests:{},questProgress:{}};
  this.run.mHP=CALC.maxHP(this.run);this.run.mMP=CALC.maxMP(this.run);
  this.run.hp=this.run.mHP;this.run.mp=this.run.mMP;
  this.saveA();return this.run;
},
recalcDerived(){if(!this.run)return;this.run.mHP=CALC.maxHP(this.run);this.run.mMP=CALC.maxMP(this.run);if(this.run.hp>this.run.mHP)this.run.hp=this.run.mHP;if(this.run.mp>this.run.mMP)this.run.mp=this.run.mMP},
_saveFail:false,
_validateSave(p){if(!(p&&typeof p==='object'&&p.name&&p.species&&p.stats&&typeof p.level==='number'&&typeof p.hp==='number'&&typeof p.mHP==='number'))return false;
  if(!p.activeQuests)p.activeQuests=[];if(!p.completedQuests)p.completedQuests={};if(!p.questProgress)p.questProgress={};
  if(!p.activeBounty)p.activeBounty=null;if(!p.bountyBoard)p.bountyBoard=null;return true},
saveA(){if(this.run)try{localStorage.setItem('activeRun',JSON.stringify(this.run));this._saveFail=false}catch(e){if(!this._saveFail){this._saveFail=true;console.warn('Auto-save failed:',e);
  if(e.name==='QuotaExceededError')showToast('Save failed \u2014 storage may be full.','error');else showToast('Auto-save failed.','error')}}},
loadA(){try{const d=localStorage.getItem('activeRun');if(d){const p=JSON.parse(d);if(!this._validateSave(p))return'incompatible';this.run=p;return true}}catch(e){showToast('Save data corrupted. Starting fresh.','error')}return false},
clearA(){this.run=null;try{localStorage.removeItem('activeRun')}catch(e){}},
mSave(s){if(!this.run)return false;try{let sv=JSON.parse(localStorage.getItem('manualSaves')||'["","",""]');sv[s]=JSON.stringify({...this.run,savedAt:new Date().toISOString()});localStorage.setItem('manualSaves',JSON.stringify(sv));return true}catch(e){if(e.name==='QuotaExceededError')showToast('Save failed \u2014 storage full.','error');return false}},
mLoad(s){try{let sv=JSON.parse(localStorage.getItem('manualSaves')||'["","",""]');if(sv[s]){const p=JSON.parse(sv[s]);if(!this._validateSave(p))return'incompatible';this.run=p;this.saveA();return true}}catch(e){showToast('Save slot corrupted.','error')}return false},
getMSaves(){try{let sv=JSON.parse(localStorage.getItem('manualSaves')||'["","",""]');return sv.map(s=>{if(!s)return null;try{const p=JSON.parse(s);return p&&p.stats?p:null}catch(e){return null}})}catch(e){return[null,null,null]}},
qSave(){if(!this.run)return false;try{localStorage.setItem('quickSave',JSON.stringify({...this.run,savedAt:new Date().toISOString()}));return true}catch(e){if(e.name==='QuotaExceededError')showToast('Quick save failed \u2014 storage full.','error');return false}},
qLoad(){try{const d=localStorage.getItem('quickSave');if(d){const p=JSON.parse(d);if(!this._validateSave(p))return'incompatible';this.run=p;this.saveA();return true}}catch(e){showToast('Quick save corrupted.','error')}return false},
getQS(){try{const d=localStorage.getItem('quickSave');if(!d)return null;const p=JSON.parse(d);return this._validateSave(p)?p:null}catch(e){return null}},
getJM(){try{return JSON.parse(localStorage.getItem('journalMeta')||'{}')}catch(e){return{}}},
setJM(u){const m=this.getJM();Object.assign(m,u);try{localStorage.setItem('journalMeta',JSON.stringify(m))}catch(e){}},
getSettings(){try{return JSON.parse(localStorage.getItem('gameSettings')||'{}')}catch(e){return{}}},
setSettings(s){try{localStorage.setItem('gameSettings',JSON.stringify(s));const root=document.documentElement;root.classList.toggle('settings-high-contrast',!!s.highContrast);root.classList.toggle('settings-large-text',!!s.largeText)}catch(e){}},
recEnc(id){if(!this.run)return;this.run.bSeen[id]=(this.run.bSeen[id]||0)+1;
  const m=this.getJM();if(!m.bestiary)m.bestiary={};
  if(!m.bestiary[id]){const e=ENEMIES[id];m.bestiary[id]={name:e.name,lore:e.lore,hp:e.mHP,atk:e.atk,def:e.def,dmg:`1d${e.dD}+${e.dB}`,zone:e.preferredZone||'close'}}
  try{localStorage.setItem('journalMeta',JSON.stringify(m))}catch(e){}this.saveA()},
recDef(id){if(!this.run)return;this.run.bDef[id]=(this.run.bDef[id]||0)+1;this.saveA()},
addXP(amt){if(!this.run)return{};this.run.xp+=amt;let lv=false,lvls=[];
  while(this.run.level<25&&this.run.xp>=this.run.level*100){this.run.level++;lv=true;lvls.push(this.run.level);
    this.run.stats.health++;this.recalcDerived();this.run.hp=this.run.mHP;this.run.mp=this.run.mMP}
  this.saveA();return{gained:amt,leveled:lv,level:this.run.level,lvls}}
};

// === COMBAT ===
const CMB={
start(ek){
  const t=ENEMIES[ek];
  if(!t){console.error('Missing enemy:',ek);showToast('Combat error: unknown enemy.','error');return null}
  const e={...t,hp:t.mHP};
  GS.run.cs={enemy:e,playerZone:'mid',turnCount:0,fled:false,over:false,won:false,
    movedThisTurn:false,freeMovedThisCombat:false,activeBuff:null,blocking:false,pBlk:0};
  GS.run.traitState.advantageUsed=false;GS.run.traitState.vanishUsed=false;GS.run.traitState.hidden=false;
  GS.recEnc(ek);GS.saveA();return GS.run.cs},
gs(){return GS.run?GS.run.cs:null},
_validZone(z){return z==='close'||z==='mid'||z==='far'},
hasFreeMove(r,cs){
  if(r.debuffs&&r.debuffs.find(d=>d.type==='slow'))return false;
  if(r.subspecies==='quickfoot')return true;
  if(r.classes&&r.classes[0]==='rogue')return 'toward_close';
  if(CALC.effMov(r)>=7&&!cs.freeMovedThisCombat)return 'once';
  return false},
moveZone(dir){
  const cs=this.gs();if(!cs||cs.over)return{ms:[],costAction:true};
  if(!this._validZone(cs.playerZone)){cs.playerZone='mid';console.warn('Invalid zone reset to mid')}
  const r=GS.run,ms=[],zones=CALC.ZONES,zi=zones.indexOf(cs.playerZone);
  const fm=this.hasFreeMove(r,cs);
  const isFree=fm===true||(fm==='toward_close'&&dir==='closer')||(fm==='once');
  if(dir==='closer'){
    if(zi<=0){ms.push({t:'Already at Close range!',c:'y'});return{ms,costAction:false}}
    cs.playerZone=zones[zi-1];
    ms.push({t:`You advance to ${cs.playerZone.toUpperCase()} range.`,c:'c'})}
  else{
    if(zi>=zones.length-1){ms.push({t:"Can't retreat further!",c:'y'});return{ms,costAction:false}}
    cs.playerZone=zones[zi+1];
    ms.push({t:`You fall back to ${cs.playerZone.toUpperCase()} range.`,c:'c'})}
  cs.movedThisTurn=true;
  if(fm==='once')cs.freeMovedThisCombat=true;
  if(!isFree)ms.push({t:'(Movement costs your action)',c:'y'});
  GS.saveA();return{ms,costAction:!isFree}},
pAct(act){
  const cs=this.gs();if(!cs||cs.over)return[];const r=GS.run,ms=[];let eActs=true;
  if(!this._validZone(cs.playerZone)){cs.playerZone='mid';console.warn('Invalid zone reset to mid')}
  if(cs.enemy.hp<=0){cs.over=true;cs.won=true;GS.saveA();return ms}
  if(r.hp<=0){cs.over=true;cs.won=false;GS.saveA();return ms}
  if(!r.debuffs)r.debuffs=[];
  cs.turnCount++;
  ms.push({t:`â€” Turn ${cs.turnCount} â€”`,c:'y'});
  cs.blocking=false;
  for(let i=r.debuffs.length-1;i>=0;i--){const d=r.debuffs[i];
    const label=d.type.charAt(0).toUpperCase()+d.type.slice(1);
    if(d.dmg>0){const dd=CALC.safeDmg(d.dmg);r.hp=Math.max(0,r.hp-dd);ms.push({t:`${label} deals ${dd} damage! (${r.hp}/${r.mHP} HP)`,c:'d'})}
    else if(d.type!=='stun'){ms.push({t:`${label} afflicts you.`,c:'y'})}
    d.remaining=Math.max(0,d.remaining-1);
    if(d.remaining<=0){r.debuffs.splice(i,1);ms.push({t:`The ${d.type} fades.`,c:'y'})}
    else ms.push({t:`${label}: ${d.remaining} turn${d.remaining!==1?'s':''} remaining.`,c:'y'})}
  if(r.hp<=0){cs.over=true;cs.won=false;ms.push({t:'Everything fades to black\u2026',c:'d'});GS.saveA();return ms}
  const stunIdx=r.debuffs.findIndex(d=>d.type==='stun');
  if(stunIdx!==-1){r.debuffs.splice(stunIdx,1);ms.push({t:'You are stunned! Your action is lost!',c:'d'});
    const eMs=this.eTurn();ms.push(...eMs);GS.saveA();return ms}
  const clDef=CL[r.classes[0]];const abilities=getAbilities(r);
  const zone=cs.playerZone;
  let abilityIdx=0;if(typeof act==='string'&&act.startsWith('ability_')){abilityIdx=parseInt(act.split('_')[1])||0;act='ability'}
  switch(act){
  case'move_closer':case'move_further':{
    const dir=act==='move_closer'?'closer':'further';
    const res=this.moveZone(dir);
    ms.push(...res.ms);
    if(res.costAction){
      if(cs.enemy.hp<=0){cs.over=true;cs.won=true;eActs=false;ms.push({t:`The ${cs.enemy.name} falls! Victory!`,c:'s'});GS.recDef(cs.enemy.id);cs.activeBuff=null}
      if(eActs&&!cs.over){ms.push(...this.eTurn());this._tickBuff(cs,ms)}
      if(r.hp<=0){cs.over=true;cs.won=false;ms.push({t:'Everything fades to black\u2026',c:'d'})}
      cs.pBlk=0;GS.saveA();return ms}
    break}
  case'attack':{
    const w=r.wpn;if(!w){ms.push({t:'You have no weapon equipped!',c:'d'});GS.saveA();return ms}
    const isMelee=w.t==='melee';
    if(isMelee&&zone!=='close'){ms.push({t:`Must be at CLOSE range for ${w.name}!`,c:'y'});GS.saveA();return ms}
    if(w.t==='ranged'&&w.ammo!==undefined&&w.ammo<=0){ms.push({t:'No arrows remain!',c:'d'});GS.saveA();return ms}
    if(w.t==='ranged'&&w.ammo!==undefined){w.ammo--;if(r.oh&&r.oh.t==='quiver'){r.oh.arrows=w.ammo;r.oh.desc=w.ammo+' arrow'+(w.ammo!==1?'s':'')}}
    let hitPct=isMelee?CALC.meleeHit(r,cs.enemy.def,zone):CALC.rangedHit(r,cs.enemy.def,zone);
    const buff=cs.activeBuff;
    if(buff&&buff.trigger==='ranged_hit'&&!isMelee&&buff.effect.hitBonus){
      hitPct=CALC.pct(hitPct+buff.effect.hitBonus);
      if(buff.effect.ignoreZonePenalty){const pen=CALC.zoneHitMod(zone,'ranged');
        if(pen<0){hitPct=CALC.pct(hitPct-pen);ms.push({t:'Aimed Shot negates zone penalty!',c:'s'})}}}
    if(buff&&buff.trigger==='sustained'&&buff.effect.hitBonus&&isMelee)hitPct=CALC.pct(hitPct+buff.effect.hitBonus);
    let roll=CALC.roll100();
    if(r.subspecies==='duskelf'&&!r.traitState.advantageUsed){
      const roll2=CALC.roll100();ms.push({t:'Twilight Instinct! Rolling twice: '+roll+', '+roll2,c:'y'});
      roll=Math.min(roll,roll2);r.traitState.advantageUsed=true}
    if(r.traitState.hidden){ms.push({t:'You strike from the shadows!',c:'s'});r.traitState.hidden=false}
    if(roll<=hitPct){
      let dmg=CALC.rollDice(w.dD)+(w.dB||0)+(isMelee?CALC.meleeDmgMod(r):CALC.rangedDmgMod(r));
      if(buff&&buff.trigger==='sustained'&&buff.effect.dmgBonus&&isMelee){dmg+=buff.effect.dmgBonus;ms.push({t:`Aggro: +${buff.effect.dmgBonus} damage!`,c:'s'})}
      if(buff&&buff.trigger==='melee_hit'&&isMelee&&buff.effect.dmgMult&&!buff.conditions){
        dmg*=buff.effect.dmgMult;ms.push({t:`Power Strike! ${buff.effect.dmgMult}\u00d7 damage!`,c:'s'});cs.activeBuff=null}
      if(buff&&buff.trigger==='melee_hit'&&isMelee&&buff.conditions){
        const condMet=cs.turnCount<=1||cs.movedThisTurn;
        if(condMet){dmg*=buff.effect.dmgMult;ms.push({t:`Backstab! ${buff.effect.dmgMult}\u00d7 damage!`,c:'s'})}
        else{ms.push({t:'Backstab conditions not met \u2014 normal damage.',c:'y'})}
        cs.activeBuff=null}
      if(buff&&buff.trigger==='ranged_hit'&&!isMelee){ms.push({t:'Aimed Shot strikes true!',c:'s'});cs.activeBuff=null}
      if(r.traitState.hidden===false&&GS.run.traitState._wasHidden){dmg*=2;delete GS.run.traitState._wasHidden;ms.push({t:'Double damage from Vanish!',c:'s'})}
      if(r.debuffs&&r.debuffs.find(d=>d.type==='weaken'))dmg=Math.max(1,dmg-1);
      dmg=CALC.safeDmg(dmg);cs.enemy.hp=Math.max(0,cs.enemy.hp-dmg);
      ms.push({t:`You swing your ${w.name}. ${hitPct}% \u2192 HIT. ${dmg} damage \u2192 ${cs.enemy.name} (${cs.enemy.hp} HP).`,c:'s'});
      if(w.t==='ranged'&&w.ammo!==undefined)ms.push({t:`(${w.ammo} arrows left)`,c:'y'})
    }else{ms.push({t:`Your ${w.name} misses! ${hitPct}% \u2192 MISS`,c:'d'});
      if(buff&&buff.trigger!=='sustained')cs.activeBuff=null}
    break}
  case'ability':{
    const ab=abilities[abilityIdx]||null;
    if(!ab){ms.push({t:'You have no class ability.',c:'y'});GS.saveA();return ms}
    const cost=CALC.abilityCost(r,ab);
    if(r.mp<cost){ms.push({t:`Not enough MP! Need ${cost} MP for ${ab.name}.`,c:'y'});GS.saveA();return ms}
    if(ab.requirement==='close_zone'&&zone!=='close'){ms.push({t:`Must be at CLOSE range for ${ab.name}.`,c:'y'});GS.saveA();return ms}
    if(ab.requirement==='mid_or_far_zone'&&zone==='close'){ms.push({t:`Must be at MID or FAR range for ${ab.name}.`,c:'y'});GS.saveA();return ms}
    if(ab.requirement==='ranged_equipped'&&(!r.wpn||r.wpn.t!=='ranged')){ms.push({t:`Need a ranged weapon for ${ab.name}.`,c:'y'});GS.saveA();return ms}
    if(ab.requirement==='spellbook_equipped'&&(!r.oh||r.oh.t!=='spellbook')){ms.push({t:`Need a Spellbook equipped for ${ab.name}.`,c:'y'});GS.saveA();return ms}
    r.mp-=cost;
    if(ab.type==='special'&&ab.effect.guaranteedFlee){
      ms.push({t:`${ab.name}! Smoke fills the air! (${cost} MP)`,c:'s'});cs.fled=true;cs.over=true;eActs=false;break}
    if(ab.type==='buff'){
      if(ab.trigger==='sustained'){
        cs.activeBuff={name:ab.name,trigger:ab.trigger,effect:{...ab.effect},turnsLeft:ab.effect.duration};
        ms.push({t:`${ab.name} activated! (${cost} MP)`,c:'s'});
        if(ab.effect.duration<50)ms.push({t:`${ab.name}: ${ab.effect.duration} turns remaining.`,c:'y'})}
      else{
        cs.activeBuff={name:ab.name,trigger:ab.trigger,effect:{...ab.effect},conditions:ab.conditions||null};
        let lbl=ab.name;
        if(ab.conditions){
          const condMet=ab.conditions.includes('hidden')?r.traitState.hidden:(cs.turnCount<=1||cs.movedThisTurn);
          lbl+=condMet?' ('+ab.effect.dmgMult+'\u00d7)':' (1\u00d7)'}
        ms.push({t:`${lbl} ready! (${cost} MP)`,c:'s'})}
      break}
    if(ab.type==='attack'){
      const eff=ab.effect;
      const hits=eff.multiHit||1;
      if(eff.useWeapon&&r.wpn){
        const w=r.wpn,isMelee=w.t==='melee';
        for(let hi=0;hi<hits;hi++){
          let hitPct=isMelee?CALC.meleeHit(r,cs.enemy.def,zone):CALC.rangedHit(r,cs.enemy.def,zone);
          const roll=CALC.roll100();
          if(roll<=hitPct){let dmg=CALC.rollDice(w.dD)+(w.dB||0)+(isMelee?CALC.meleeDmgMod(r):CALC.rangedDmgMod(r));
            dmg=CALC.safeDmg(dmg);cs.enemy.hp=Math.max(0,cs.enemy.hp-dmg);
            ms.push({t:`${ab.name}! ${w.name} hits for ${dmg}! (${cs.enemy.hp} HP)`,c:'s'})}
          else ms.push({t:`${ab.name} swing misses! (${hitPct}%)`,c:'d'})}
        break}
      for(let hi=0;hi<hits;hi++){
        let hitPct=eff.statOverride==='smarts'?CALC.arcaneBoltHit(r,cs.enemy.def):CALC.meleeHit(r,cs.enemy.def,zone);
        if(eff.hitPenalty)hitPct=CALC.pct(hitPct+eff.hitPenalty);
        const roll=CALC.roll100();
        if(r.subspecies==='duskelf'&&!r.traitState.advantageUsed){
          const roll2=CALC.roll100();ms.push({t:'Twilight Instinct! Rolling twice: '+roll+', '+roll2,c:'y'});
          r.traitState.advantageUsed=true}
        if(roll<=hitPct){
          let dmg=0;if(eff.dmgDice)for(const d of eff.dmgDice)dmg+=CALC.rollDice(d);
          if(eff.bonusVsTag&&cs.enemy.tags&&cs.enemy.tags.includes(eff.bonusVsTag))dmg=Math.floor(dmg*eff.bonusMult);
          dmg=CALC.safeDmg(dmg);cs.enemy.hp=Math.max(0,cs.enemy.hp-dmg);
          ms.push({t:`${ab.name} strikes the ${cs.enemy.name} for ${dmg} damage! (${hitPct}%)`,c:'s'});
          if(eff.statusChance&&CALC.roll100()<=eff.statusChance){
            if(!r.debuffs)r.debuffs=[];
            const existing=cs.enemy.debuffs||(cs.enemy.debuffs=[]);
            ms.push({t:`${cs.enemy.name} is afflicted with ${eff.status}!`,c:'s'});
            if(!r.debuffs.find(d=>d.type===eff.status)){}
          }}
        else ms.push({t:`${ab.name} misses the ${cs.enemy.name}! (${hitPct}%)`,c:'d'})}
      break}
    if(ab.type==='heal'){
      const h=Math.min(ab.effect.healAmt,r.mHP-r.hp);r.hp+=h;
      ms.push({t:`${ab.name}! Restored ${h} HP. (${r.hp}/${r.mHP} HP, ${cost} MP)`,c:'s'});break}
    break}
  case'block':{
    cs.blocking=true;
    const oh=r.oh;
    if(oh&&oh.t==='shield'){ms.push({t:`You raise your ${oh.name}. Incoming damage halved!`,c:'c'})}
    else{ms.push({t:'You brace yourself. Incoming damage halved!',c:'c'})}
    break}
  case'use_potion':case'use_hpot':case'use_mpot':case'use_antidote':case'use_item':{
    let it=null;
    if(act==='use_hpot')it=r.bp.find(i=>i.t==='consumable'&&i.heal);
    else if(act==='use_mpot')it=r.bp.find(i=>i.t==='consumable'&&i.mana);
    else if(act==='use_antidote')it=r.bp.find(i=>i.t==='consumable'&&i.cure);
    else it=r.bp.find(i=>i.t==='consumable'&&(i.heal||i.mana||i.cure));
    if(!it){ms.push({t:'No usable items!',c:'y'});GS.saveA();return ms}
    const msg=useConsumable(it,r);ms.push({t:msg,c:'s'});break}
  case'flee':{
    if(zone==='close'&&r.subspecies!=='quickfoot'){ms.push({t:'Too close to flee! Move to MID or FAR first.',c:'y'});GS.saveA();return ms}
    const fleePct=CALC.flee(r);const roll=CALC.roll100();
    if(roll<=fleePct){ms.push({t:`You turn and run! (${fleePct}% \u2192 rolled ${roll})`,c:'s'});cs.fled=true;cs.over=true;eActs=false}
    else{ms.push({t:`You try to flee but can't escape! (${fleePct}% \u2192 rolled ${roll})`,c:'d'});
      ms.push({t:'The enemy gets a free attack!',c:'d'});ms.push(...this._enemyAttack(cs,r))}
    break}
  case'vanish':{
    if(r.subspecies!=='shadowstep'){ms.push({t:'You can\u2019t do that.',c:'y'});GS.saveA();return ms}
    if(r.traitState.vanishUsed){ms.push({t:'Vanish already used this combat!',c:'y'});GS.saveA();return ms}
    if(r.mp<2){ms.push({t:'Not enough MP! Need 2 MP.',c:'y'});GS.saveA();return ms}
    r.mp-=2;r.traitState.vanishUsed=true;r.traitState.hidden=true;GS.run.traitState._wasHidden=true;
    ms.push({t:'You melt into the shadows... (2 MP spent)',c:'s'});ms.push({t:'Your next attack will deal double damage!',c:'y'});break}
  default:ms.push({t:'You hesitate.',c:'d'})}
  if(cs.enemy.hp<=0){cs.over=true;cs.won=true;eActs=false;
    ms.push({t:`The ${cs.enemy.name} falls! Victory!`,c:'s'});GS.recDef(cs.enemy.id);cs.activeBuff=null}
  if(eActs&&!cs.over){ms.push(...this.eTurn());this._tickBuff(cs,ms)}
  if(r.hp<=0){cs.over=true;cs.won=false;ms.push({t:'Everything fades to black\u2026',c:'d'})}
  cs.pBlk=0;cs.movedThisTurn=false;GS.saveA();return ms},
_tickBuff(cs,ms){
  if(cs.activeBuff&&cs.activeBuff.trigger==='sustained'){
    cs.activeBuff.turnsLeft--;
    if(cs.activeBuff.turnsLeft<=0){ms.push({t:'The red haze fades from your vision.',c:'y'});cs.activeBuff=null}
    else ms.push({t:`${cs.activeBuff.name}: ${cs.activeBuff.turnsLeft} turn${cs.activeBuff.turnsLeft!==1?'s':''} remaining.`,c:'y'})}},
_enemyAttack(cs,r){
  const e=cs.enemy,ms=[];
  if(e.hp<=0||r.hp<=0)return ms;
  const pDef=CALC.playerDef(r);
  const hitPct=CALC.enemyHit(e.atk,pDef);const roll=CALC.roll100();
  if(roll<=hitPct){
    let d=CALC.safeDmg(CALC.rollDice(e.dD)+(e.dB||0));
    if(cs.blocking){d=Math.max(1,Math.floor(d/2));ms.push({t:`Block halves the blow! ${d} damage.`,c:'d'})}
    else ms.push({t:`The ${e.name} lashes out for ${d} damage!`,c:'d'});
    if(cs.activeBuff&&cs.activeBuff.trigger==='sustained'&&cs.activeBuff.effect.incomingDmgBonus){
      d+=cs.activeBuff.effect.incomingDmgBonus;ms.push({t:`Aggro: +${cs.activeBuff.effect.incomingDmgBonus} incoming damage!`,c:'y'})}
    if(r.subspecies==='stoneblood'&&d>1){d--;ms.push({t:'Stone Skin absorbs 1 damage!',c:'y'})}
    if(r.subspecies==='fireblood'){d++;ms.push({t:'Volcanic Fury: you take 1 extra damage!',c:'y'})}
    if(r.traitState.hidden){r.traitState.hidden=false;delete GS.run.traitState._wasHidden;ms.push({t:'You are revealed by the attack!',c:'y'})}
    d=CALC.safeDmg(d);r.hp=Math.max(0,r.hp-d);
    if(r.hp<=0&&cs.activeBuff&&cs.activeBuff.effect.undying){r.hp=1;cs.activeBuff=null;ms.push({t:'Undying Rage! You refuse to fall! (1 HP)',c:'s'})}
    if(cs.activeBuff&&cs.activeBuff.effect.dmgImmunity){d=0;r.hp=Math.min(r.hp+d,r.mHP);ms.push({t:'Divine Shield absorbs all damage!',c:'s'})}
    if(cs.activeBuff&&cs.activeBuff.effect.manaShield&&r.mp>0){const absorbed=Math.min(d,r.mp);r.mp-=absorbed;r.hp=Math.min(r.hp+absorbed,r.mHP);ms.push({t:`Mana Shield absorbs ${absorbed} damage! (${r.mp} MP left)`,c:'s'})}
    if(e.onHit){if(!r.debuffs)r.debuffs=[];
      const oh=e.onHit;if(CALC.roll100()<=oh.chance&&r.subspecies!=='stoneblood'){
        const elabel=oh.effect.charAt(0).toUpperCase()+oh.effect.slice(1);
        const existing=r.debuffs.find(db=>db.type===oh.effect);
        if(!existing){r.debuffs.push({type:oh.effect,dmg:oh.dmg,remaining:Math.max(0,oh.duration)});
          ms.push({t:`You are afflicted with ${oh.effect}! (${oh.duration} turns${oh.dmg>0?', '+oh.dmg+' dmg/turn':''})`,c:'d'})}
        else{existing.remaining=Math.max(0,oh.duration);ms.push({t:`${elabel} refreshed!`,c:'d'})}}}}
  else ms.push({t:`The ${e.name} lunges but misses!`,c:'d'});
  return ms},
eTurn(){const cs=this.gs(),r=GS.run,e=cs.enemy,ms=[];
  if(e.hp<=0||r.hp<=0)return ms;
  const zone=cs.playerZone;const pref=e.preferredZone||'close';
  const zones=CALC.ZONES,zi=zones.indexOf(zone);
  if(pref==='close'&&zone!=='close'){
    cs.playerZone=zones[Math.max(0,zi-1)];
    ms.push({t:`The ${e.name} closes in! Now at ${cs.playerZone.toUpperCase()} range.`,c:'d'});
    return ms}
  if(pref==='mid'){
    if(zone==='close'){cs.playerZone='mid';
      ms.push({t:`The ${e.name} pulls back to MID range.`,c:'d'});return ms}
    if(zone==='far'){ms.push(...this._enemyAttack(cs,r));return ms}}
  ms.push(...this._enemyAttack(cs,r));
  return ms}
};

// === TOAST SYSTEM ===
function showToast(message,type){
  let el=document.getElementById('toast');
  if(el)el.remove();
  el=document.createElement('div');el.id='toast';el.className='toast toast-'+type;
  el.textContent=message;el.setAttribute('role','alert');
  document.body.appendChild(el);
  requestAnimationFrame(()=>el.classList.add('show'));
  setTimeout(()=>{el.classList.remove('show');setTimeout(()=>el.remove(),300)},3000)}

// === GLOBAL ERROR BOUNDARY ===
window.onerror=function(msg,url,line,col,error){
  console.error('Game error:',{msg,url,line,col,error});
  showToast('Something went wrong. Progress auto-saved.','error');
  try{if(GS.run)GS.saveA()}catch(e){}
  return true};
window.addEventListener('unhandledrejection',function(event){
  console.error('Unhandled promise:',event.reason);
  showToast('Something went wrong. Progress auto-saved.','error');
  try{if(GS.run)GS.saveA()}catch(e){}});

// === UI CONTROLLER ===
const UI={
el:{},_busy:false,
init(){
  this.el={landing:$('landing'),landBtns:$('landing-buttons'),
    app:$('app'),hud:$('hud'),hp:$('hud-portrait'),hnc:$('hud-nc'),
    hbi:$('hp-bar-i'),hbo:$('hp-bar-o'),htx:$('hp-txt'),
    mbi:$('mp-bar-i'),mbo:$('mp-bar-o'),mtx:$('mp-txt'),gtx:$('gold-txt'),
    bchar:$('b-char'),bj:$('b-jrn'),bmenu:$('b-menu'),
    batk:$('b-atk'),bdef:$('b-def'),bitem:$('b-item'),atkLbl:$('atk-lbl'),
    cc:$('cc'),gm:$('game'),nw:$('narr-w'),nl:$('narr-log'),
    zoneDisplay:$('zone-display'),
    bb:$('bbar'),exploreBar:$('explore-bar'),combatBar:$('combat-bar'),
    bacts:$('b-acts'),
    cbAtk:$('cb-atk'),cbAbility:$('cb-ability'),cbAbilityName:$('cb-ability-name'),cbAbilityCost:$('cb-ability-cost'),
    cbBlock:$('cb-block'),cbFlee:$('cb-flee'),cbItem:$('cb-item'),cbMove:$('cb-move'),
    cbAtkPct:$('cb-atk-pct'),cbFleePct:$('cb-flee-pct'),
    ni:$('ninp'),cbk:$('cc-bk'),cnx:$('cc-nx'),ccStep:$('cc-step'),
    tc:$('title-card'),tcn:$('tc-name'),tcs:$('tc-sub'),
    ds:$('death-screen'),dsq:$('death-quote'),dsl:$('ds-load'),dsn:$('ds-new'),dst:$('ds-title'),
    ash:$('action-sheet'),asl:$('as-list'),asb:$('as-backdrop')};
  this.renderIcons();this.bind();this.vvp();
  const st=GS.getSettings();document.documentElement.classList.toggle('settings-high-contrast',!!st.highContrast);document.documentElement.classList.toggle('settings-large-text',!!st.largeText);
},
renderIcons(){
  const map=[[this.el.bchar,PA.icons.person],[this.el.bj,PA.icons.book],[this.el.bmenu,PA.icons.menu],
    [this.el.batk,PA.icons.sword],[this.el.bdef,PA.icons.shield],[this.el.bitem,PA.icons.potion]];
  map.forEach(([b,fn])=>{const c=b.querySelector('canvas');if(c)PA.renderIcon(c,fn)});
},
bind(){
  this.el.cnx.onclick=()=>CC.next();this.el.cbk.onclick=()=>CC.back();
  this.el.ni.onkeydown=e=>{if(e.key==='Enter')CC.next()};
  this.el.bchar.onclick=()=>ML.openChar();
  this.el.bj.onclick=()=>ML.openJrn();
  this.el.bmenu.onclick=()=>ML.openMenu();
  this.el.bacts.onclick=()=>this.openActionSheet();
  this.el.batk.onclick=()=>SE.doCombatAction('attack');
  this.el.bdef.onclick=()=>SE.doCombatAction('block');
  this.el.bitem.onclick=()=>SE.doCombatAction('use_potion');
  this.el.cbAtk.onclick=()=>SE.doCombatAction('attack');
  this.el.cbAbility.onclick=()=>SE.doCombatAction('ability');
  this.el.cbBlock.onclick=()=>SE.doCombatAction('block');
  this.el.cbFlee.onclick=()=>SE.doCombatAction('flee');
  this.el.cbItem.onclick=()=>SE.doCombatAction('use_potion');
  this.el.cbMove.onclick=()=>SE.doCombatAction('move_closer');
  this.el.asb.onclick=()=>this.closeActionSheet();
  this.el.dsl.onclick=()=>SE.deathLoad();
  this.el.dsn.onclick=()=>SE.deathNewRun();
  this.el.dst.onclick=()=>SE.deathTitle();
  document.onkeydown=e=>{
    if((e.key==='q'||e.key==='Q')&&document.activeElement.tagName!=='INPUT'&&GS.run){if(GS.qSave()){this.addN('Game quick saved.','y');showToast('Quick saved!','success')}else{this.addN('Quick save failed.','d');showToast('Quick save failed!','error')}}
    if(e.key==='Escape'){ML.closeAll();this.closeActionSheet()}};
},
vvp(){if(window.visualViewport){const a=()=>{$('app').style.height=window.visualViewport.height+'px'};window.visualViewport.addEventListener('resize',a);window.visualViewport.addEventListener('scroll',a)}},
showLanding(){this.el.landing.classList.remove('hidden');this.el.app.classList.remove('vis');this.buildLandingButtons();Particles.start()},
buildLandingButtons(){
  const b=this.el.landBtns;b.innerHTML='';
  const res=GS.loadA();
  if(res===true&&GS.run){
    const r=GS.run,clName=CL[r.classes[0]]?CL[r.classes[0]].name:r.classes[0];
    const cont=document.createElement('button');cont.className='lbtn lbtn-primary';
    cont.innerHTML='Continue<div class="lbtn-sub">Continue as '+r.name+' Â· Lv'+r.level+' '+clName+'</div>';
    cont.onclick=async()=>{this.el.landing.classList.add('hidden');Particles.stop();this.el.app.classList.add('vis');this.showGame();this.restoreN();
      const scene=SCENE_DATA[GS.run.scene];if(scene)await this.showTitleCard(scene.name,null,500);
      SE.resume()};
    b.appendChild(cont);
    const nw=document.createElement('button');nw.className='lbtn lbtn-secondary';nw.textContent='New Adventure';
    nw.onclick=()=>{if(!confirm('Start new adventure? Current progress will be lost unless saved.'))return;GS.clearA();this.el.landing.classList.add('hidden');Particles.stop();this.el.app.classList.add('vis');this.showCC()};
    b.appendChild(nw);
    const ld=document.createElement('button');ld.className='lbtn lbtn-link';ld.textContent='Load Game';
    ld.onclick=()=>{this.el.landing.classList.add('hidden');Particles.stop();this.el.app.classList.add('vis');this.showGame();this.restoreN();SE.resume();ML.openMenu()};
    b.appendChild(ld);
  } else {
    if(res==='incompatible')GS.clearA();
    const nw=document.createElement('button');nw.className='lbtn lbtn-primary';nw.textContent='New Adventure';
    nw.onclick=()=>{this.el.landing.classList.add('hidden');Particles.stop();this.el.app.classList.add('vis');this.showCC()};
    b.appendChild(nw);
  }
},
showGame(){this.el.cc.style.display='none';const g=this.el.gm;g.style.display='flex';g.style.flexDirection='column';g.style.flex='1';g.style.overflow='hidden';
  this.el.hud.classList.add('vis');this.el.bb.classList.add('vis');this.setCombatMode(false);this.updateHUD()},
showCC(){this.el.cc.style.display='flex';this.el.gm.style.display='none';this.el.hud.classList.remove('vis');this.el.bb.classList.remove('vis');CC.reset()},
setCombatMode(on){
  if(on){this.el.hud.classList.add('combat-mode');this.el.bb.classList.add('combat-mode');this.updateCombatUI();this.updateZoneDisplay(true)}
  else{this.el.hud.classList.remove('combat-mode');this.el.bb.classList.remove('combat-mode');this.updateZoneDisplay(false)}
},
updateCombatUI(){
  const cs=CMB.gs(),r=GS.run;if(!cs||cs.over)return;
  const zone=cs.playerZone;
  const w=r.wpn;if(w){const isMelee=w.t==='melee';
    let hitPct=isMelee?CALC.meleeHit(r,cs.enemy.def,zone):CALC.rangedHit(r,cs.enemy.def,zone);
    if(cs.activeBuff&&cs.activeBuff.trigger==='ranged_hit'&&!isMelee&&cs.activeBuff.effect.hitBonus)hitPct=CALC.pct(hitPct+cs.activeBuff.effect.hitBonus);
    if(cs.activeBuff&&cs.activeBuff.trigger==='sustained'&&cs.activeBuff.effect.hitBonus&&isMelee)hitPct=CALC.pct(hitPct+cs.activeBuff.effect.hitBonus);
    this.el.atkLbl.textContent=hitPct+'%';this.el.cbAtkPct.textContent=hitPct+'%';
    if(isMelee&&zone!=='close')this.el.cbAtk.disabled=true;else this.el.cbAtk.disabled=false}
  const fleePct=CALC.flee(r);this.el.cbFleePct.textContent=fleePct+'%';
  this.el.cbFlee.disabled=zone==='close'&&r.subspecies!=='quickfoot';
  const zi=CALC.ZONES.indexOf(zone);
  this.el.cbMove.textContent=zi>0?'\u25c4 Closer':'Further \u25ba';
  this.el.cbMove.onclick=()=>SE.doCombatAction(zi>0?'move_closer':'move_further');
  const abilities=getAbilities(r);const ab=abilities[0]||null;
  if(ab){
    const cost=CALC.abilityCost(r,ab);
    let canUse=r.mp>=cost;
    if(ab.requirement==='close_zone'&&zone!=='close')canUse=false;
    if(ab.requirement==='mid_or_far_zone'&&zone==='close')canUse=false;
    if(ab.requirement==='ranged_equipped'&&(!r.wpn||r.wpn.t!=='ranged'))canUse=false;
    if(ab.requirement==='spellbook_equipped'&&(!r.oh||r.oh.t!=='spellbook'))canUse=false;
    this.el.cbAbility.style.display='';
    let btnLabel=ab.name;
    if(ab.conditions){const condMet=cs.turnCount<=1||cs.movedThisTurn;btnLabel+=condMet?' (3\u00d7)':' (1\u00d7)'}
    if(ab.trigger==='sustained'&&cs.activeBuff&&cs.activeBuff.trigger==='sustained')btnLabel+=' ON';
    if(abilities.length>1)btnLabel+=' \u25bc';
    this.el.cbAbilityName.textContent=btnLabel;
    this.el.cbAbilityCost.textContent=cost+'MP';
    this.el.cbAbility.disabled=!canUse;
  }else{this.el.cbAbility.style.display='none'}
  this.updateZoneDisplay(true);
},
updateZoneDisplay(show){
  const zd=this.el.zoneDisplay;if(!zd)return;
  if(!show){zd.classList.remove('vis');return}
  const cs=CMB.gs();if(!cs||cs.over){zd.classList.remove('vis');return}
  zd.classList.add('vis');
  const lbls=zd.querySelectorAll('.zone-lbl');
  lbls.forEach(l=>{const z=l.dataset.zone;l.classList.toggle('active',z===cs.playerZone)});
  const e=cs.enemy,tier=e.tier||1;
  const nameEl=$('enemy-hp-name');
  if(nameEl)nameEl.innerHTML='<span class="tier-badge tier-'+tier+'">'+TIER_LABELS[tier]+'</span>'+e.name;
  const fill=$('enemy-hp-fill');
  if(fill){const pct=Math.max(0,(e.hp/e.mHP)*100);fill.style.width=pct+'%';
    fill.className='enemy-hp-fill '+(pct>50?'ehp-high':pct>25?'ehp-mid':'ehp-low')}
  const txt=$('enemy-hp-text');
  if(txt)txt.textContent=e.hp+' / '+e.mHP+' HP';
},
updateHUD(){const r=GS.run;if(!r)return;
  PA.renderPortrait(this.el.hp,r.species);
  const clName=CL[r.classes[0]]?CL[r.classes[0]].name:r.classes[0];
  this.el.hnc.textContent=r.name+' Â· '+clName+' Lv'+r.level;
  const hpp=Math.max(0,(r.hp/r.mHP)*100);this.el.hbi.style.width=hpp+'%';
  this.el.hbo.setAttribute('aria-valuenow',r.hp);this.el.hbo.setAttribute('aria-valuemax',r.mHP);
  this.el.htx.textContent=r.hp+'/'+r.mHP+' HP';
  const mpp=Math.max(0,(r.mp/r.mMP)*100);this.el.mbi.style.width=mpp+'%';
  this.el.mbo.setAttribute('aria-valuenow',r.mp);this.el.mbo.setAttribute('aria-valuemax',r.mMP);
  this.el.mtx.textContent=r.mp+'/'+r.mMP+' MP';
  this.el.gtx.textContent=(r.gold||0)+'g';
  const m=GS.getJM();
  if(r.jrnUnlk||m.guideFound||m.handbookFound){this.el.bj.disabled=false;this.el.bj.setAttribute('aria-label','Open journal')}
  else{this.el.bj.disabled=true;this.el.bj.setAttribute('aria-label','Journal locked')}
  const cs=CMB.gs();if(cs&&!cs.over)this.setCombatMode(true);else this.setCombatMode(false);
},
addN(text,type=''){const e=document.createElement('div');e.className='ne';
  const cls={h:'ne-h',f:'ne-f',c:'ne-c',s:'ne-s',d:'ne-d',y:'ne-y',g:'ne-g'};
  if(cls[type])e.classList.add(cls[type]);e.textContent=text;
  this.el.nl.appendChild(e);
  if(GS.run){GS.run.nlog.push({t:text,c:type});if(GS.run.nlog.length>200)GS.run.nlog=GS.run.nlog.slice(-200);GS.saveA()}this.scroll()},
clearN(){this.el.nl.innerHTML=''},
restoreN(){this.clearN();if(GS.run&&GS.run.nlog)GS.run.nlog.forEach(n=>{const e=document.createElement('div');e.className='ne';const cls={h:'ne-h',f:'ne-f',c:'ne-c',s:'ne-s',d:'ne-d',y:'ne-y',g:'ne-g'};if(cls[n.c])e.classList.add(cls[n.c]);e.textContent=n.t;this.el.nl.appendChild(e)});this.scroll()},
scroll(){requestAnimationFrame(()=>{this.el.nw.scrollTop=this.el.nw.scrollHeight})},
pulseJ(){this.el.bj.classList.add('pulse');setTimeout(()=>this.el.bj.classList.remove('pulse'),3100)},
_wait(ms){return new Promise(r=>setTimeout(r,REDUCED_MOTION?0:ms))},
addEl(el){this.el.nl.appendChild(el);this.scroll()},

async showTitleCard(name,subtitle,holdMs){
  const tc=this.el.tc,tcn=this.el.tcn,tcs=this.el.tcs;
  tcn.textContent=name;tcs.textContent=subtitle||'';tcs.style.display=subtitle?'':'none';
  tc.classList.add('vis');
  if(REDUCED_MOTION){tc.classList.add('show');await this._wait(holdMs);tc.classList.remove('show','vis');return}
  await this._wait(50);tc.classList.add('show');await this._wait(300+holdMs);
  tc.classList.remove('show');await this._wait(300);tc.classList.remove('vis');
},
showDeathScreen(){
  const qs=GS.getQS(),sv=GS.getMSaves(),hasSave=qs||sv.some(s=>s);
  this.el.dsl.style.display=hasSave?'':'none';
  this.el.dsq.textContent=DEATH_QUOTES[Math.floor(Math.random()*DEATH_QUOTES.length)];
  this.el.ds.classList.add('vis');requestAnimationFrame(()=>this.el.ds.classList.add('show'));
},
hideDeathScreen(){this.el.ds.classList.remove('show','vis')},

renderNPCButtons(sceneId){
  const scene=SCENE_DATA[sceneId];if(!scene||!scene.npcs||!scene.npcs.length)return;
  const wrap=document.createElement('div');wrap.className='npc-btns';
  scene.npcs.forEach(nid=>{const n=NPCS[nid];if(!n)return;
    const b=document.createElement('button');b.className='npc-btn';b.textContent='Talk to '+n.name;
    b.onclick=()=>SE.handleAction('talk_'+nid);wrap.appendChild(b)});
  this.addEl(wrap);
},
renderExits(sceneId){
  const scene=SCENE_DATA[sceneId];if(!scene||!scene.exits)return;
  const r=GS.run,exits=scene.exits;
  const keys=Object.keys(exits).filter(k=>{const ex=exits[k];
    if(ex.scene&&!SCENE_DATA[ex.scene]){console.warn('Exit references missing scene:',ex.scene);return false}
    return ex.discovered||!!r.ss['exit_'+sceneId+'_'+k]});
  if(!keys.length)return;
  const wrap=document.createElement('div');wrap.className='nav-exits';
  wrap.innerHTML='<div class="nav-exits-lbl">Exits</div>';
  const bwrap=document.createElement('div');bwrap.className='nav-btns';
  keys.forEach(k=>{const ex=exits[k];const b=document.createElement('button');b.className='nav-btn';
    const isBack=k==='back';const visited=r.ss['visited_'+ex.scene];
    let label=(isBack?'\u2190 ':'')+ex.label+(!isBack?' \u2192':'');
    if(!visited)label+='<span class="nav-tag"> (unexplored)</span>';
    b.innerHTML=label;b.onclick=()=>SE.enter(ex.scene);bwrap.appendChild(b)});
  wrap.appendChild(bwrap);this.addEl(wrap);
},
renderSceneActions(sceneId){
  const scene=SCENE_DATA[sceneId];if(!scene||!scene.actions)return;
  const r=GS.run;
  scene.actions.forEach(act=>{if(act.condition&&!act.condition(r))return;
    const b=document.createElement('button');b.className='scene-act-btn';b.textContent=act.label;
    b.onclick=()=>SE.handleAction(act.id);this.addEl(b)});
},

openActionSheet(){
  const cs=CMB.gs(),r=GS.run;this.el.asl.innerHTML='';
  if(cs&&!cs.over){
    const zone=cs.playerZone;
    const w=r.wpn;let atkDesc='No weapon';
    if(w){const isMelee=w.t==='melee';const hitPct=isMelee?CALC.meleeHit(r,cs.enemy.def,zone):CALC.rangedHit(r,cs.enemy.def,zone);
      atkDesc=w.name+' \u2014 '+hitPct+'% to hit'+(isMelee&&zone!=='close'?' (need CLOSE)':'')}
    const zi=CALC.ZONES.indexOf(zone);
    const acts=[{l:'Attack \u2014 '+atkDesc,cmd:'attack'},
      {l:'Move Closer',sub:'Advance one zone',cmd:'move_closer',dis:zi<=0},
      {l:'Move Further',sub:'Fall back one zone',cmd:'move_further',dis:zi>=2},
      {l:'Block',sub:'Halve incoming damage this turn',cmd:'block'},
      {l:'Flee \u2014 '+CALC.flee(r)+'%',sub:zone==='close'?'(need MID or FAR)':'',cmd:'flee',dis:zone==='close'&&r.subspecies!=='quickfoot'}];
    const hpot=r.bp.find(i=>i.t==='consumable'&&i.heal);if(hpot)acts.push({l:'Use '+hpot.name,cmd:'use_hpot'});
    const mpot=r.bp.find(i=>i.t==='consumable'&&i.mana);if(mpot)acts.push({l:'Use '+mpot.name,cmd:'use_mpot'});
    const anti=r.bp.find(i=>i.t==='consumable'&&i.cure);if(anti)acts.push({l:'Use '+anti.name,sub:'Cures '+anti.cure,cmd:'use_antidote'});
    const abilities=getAbilities(r);
    abilities.forEach((ab,ai)=>{const cost=CALC.abilityCost(r,ab);acts.splice(1+ai,0,{l:ab.name+' \u2014 '+cost+' MP',sub:ab.desc,cmd:ai===0?'ability':'ability_'+ai})})
    if(r.subspecies==='shadowstep'&&!r.traitState.vanishUsed&&!r.traitState.hidden)
      acts.push({l:'Vanish \u2014 2 MP',sub:'Hide, next attack deals double',cmd:'vanish'});
    acts.forEach(a=>{const b=document.createElement('button');b.className='as-btn';
      b.innerHTML=a.l+(a.sub?'<span class="as-btn-sub">'+a.sub+'</span>':'');
      if(a.dis)b.disabled=true;
      b.onclick=()=>{this.closeActionSheet();SE.doCombatAction(a.cmd)};this.el.asl.appendChild(b)});
  } else {
    const mkA=(label,fn)=>{const b=document.createElement('button');b.className='as-btn';b.textContent=label;
      b.onclick=()=>{this.closeActionSheet();fn()};this.el.asl.appendChild(b)};
    const actions=SE.getActions();
    actions.forEach(a=>{
      const b=document.createElement('button');b.className='as-btn';
      b.textContent=a.d?a.l+' \u2014 '+a.d:a.l;
      b.onclick=()=>{this.closeActionSheet();
        if(a.cmd.startsWith('go_'))SE.enter(a.cmd.slice(3));
        else SE.handleAction(a.cmd)};
      this.el.asl.appendChild(b);
    });
    mkA('Check inventory',()=>ML.openChar('bp'));
    r.bp.forEach(it=>{if(it.t==='consumable')mkA('Use '+it.name,()=>{
      const msg=useConsumable(it,r);if(msg)UI.addN(msg,'s')})});
    const clDef2=CL[r.classes[0]],ab2=clDef2?clDef2.ability:null;
    if(ab2&&ab2.type==='heal'&&r.hp<r.mHP){const cost2=CALC.abilityCost(r,ab2);
      if(r.mp>=cost2)mkA(ab2.name+' ('+cost2+' MP)',()=>{r.mp-=cost2;const h=Math.min(ab2.effect.healAmt,r.mHP-r.hp);r.hp+=h;GS.saveA();
        UI.addN(ab2.name+'! Restored '+h+' HP. ('+r.hp+'/'+r.mHP+' HP)','s');UI.updateHUD()})}
    mkA('Save game',()=>{if(GS.qSave())UI.addN('Game quick saved.','y');else UI.addN('Quick save failed.','d')});
  }
  this.el.asb.classList.add('vis');this.el.ash.classList.add('vis');
},
closeActionSheet(){this.el.ash.classList.remove('vis');this.el.asb.classList.remove('vis')},

setCombatBusy(busy){
  this._busy=busy;
  [this.el.cbAtk,this.el.cbAbility,this.el.cbBlock,this.el.cbFlee,this.el.cbItem,this.el.cbMove,
   this.el.batk,this.el.bdef,this.el.bitem].forEach(b=>{if(b)b.disabled=busy});
},
combatFX(type,value){
  if(REDUCED_MOTION)return;
  const flash=$('hit-flash');
  if(type==='player_hit'){
    if(flash){flash.className='hit-flash-red';setTimeout(()=>{flash.className='';flash.style.display='none'},350)}
    const gm=$('game');if(gm){gm.classList.add('screen-shake');setTimeout(()=>gm.classList.remove('screen-shake'),300)}
  }
  if(type==='enemy_hit'){
    if(flash){flash.className='hit-flash-gold';setTimeout(()=>{flash.className='';flash.style.display='none'},350)}
  }
  if(type==='dmg'||type==='heal'||type==='miss'){
    const pop=document.createElement('span');
    pop.className='dmg-pop '+(type==='heal'?'dmg-pop-green':type==='miss'?'dmg-pop-grey':'dmg-pop-'+(value<0?'gold':'red'));
    pop.textContent=type==='miss'?'MISS':type==='heal'?'+'+value:(value<0?value:'-'+value);
    pop.style.top=(this.el.nw.scrollTop+this.el.nw.clientHeight-40)+'px';
    this.el.nw.appendChild(pop);
    setTimeout(()=>pop.remove(),750);
  }
}
};
function $(id){return document.getElementById(id)}
function statBar(label,val,max){max=max||25;return'<div class="sbar"><span class="sbar-l">'+label+'</span><div class="sbar-o"><div class="sbar-i" style="width:'+Math.min(100,(val/max)*100)+'%"></div></div><span class="sbar-v">'+val+'</span></div>'}
function wtTag(wt){return'<span class="wt-tag wt-'+wt+'">'+(WT_NAMES[wt]||'?')+'</span>'}

function useConsumable(it,r){
  if(!it||it.t!=='consumable')return null;
  const idx=r.bp.indexOf(it);if(idx===-1)return null;
  r.bp.splice(idx,1);
  const parts=[];
  if(it.heal){const h=Math.min(it.heal,r.mHP-r.hp);r.hp+=h;parts.push('+'+h+' HP')}
  if(it.mana){const m=Math.min(it.mana,r.mMP-r.mp);r.mp+=m;parts.push('+'+m+' MP')}
  if(it.cure){if(!r.debuffs)r.debuffs=[];const bi=r.debuffs.findIndex(d=>d.type===it.cure);
    if(bi!==-1){r.debuffs.splice(bi,1);parts.push(it.cure+' cured')}
    else if(!it.heal&&!it.mana)parts.push('no effect')}
  GS.saveA();UI.updateHUD();
  return'Used '+it.name+(parts.length?': '+parts.join(', ')+'.':'.');
}

function rollLoot(enemy){
  if(!enemy.loot||!enemy.loot.length)return null;
  const total=enemy.loot.reduce((s,l)=>s+l.weight,0);
  let roll=Math.random()*total;
  for(const l of enemy.loot){roll-=l.weight;if(roll<=0)return l.item?{...ITEMS[l.item]}:null}
  return null;
}

// === MODAL SYSTEM ===
const ML={
active:null,prev:null,
open(id){this.closeAll();const o=$(id);if(!o)return;this.prev=document.activeElement;o.classList.add('open');this.active=o;
  const cl=o.querySelector('.mx');if(cl)cl.onclick=()=>this.closeAll();
  o.onclick=e=>{if(e.target===o)this.closeAll()};
  requestAnimationFrame(()=>{const f=o.querySelector('.mc').querySelectorAll('button,input,[tabindex]:not([tabindex="-1"])');if(f.length)f[0].focus()});
  o.onkeydown=this._trap},
_trap(e){if(e.key!=='Tab')return;const o=ML.active;if(!o)return;const f=o.querySelector('.mc').querySelectorAll('button,input,[tabindex]:not([tabindex="-1"])');if(!f.length)return;const fi=f[0],la=f[f.length-1];if(e.shiftKey&&document.activeElement===fi){e.preventDefault();la.focus()}else if(!e.shiftKey&&document.activeElement===la){e.preventDefault();fi.focus()}},
closeAll(){document.querySelectorAll('.mo.open').forEach(m=>m.classList.remove('open'));if(this.prev){this.prev.focus();this.prev=null}this.active=null},

openChar(tab){
  const b=$('m-char-b');b.innerHTML='';const r=GS.run;if(!r)return;
  const tabs=document.createElement('div');tabs.className='tab-bar';tabs.setAttribute('role','tablist');
  const panels={};const names=['Stats','Equipment','Backpack '+r.bp.length+'/6'];
  const keys=['stats','equip','bp'];
  const activeTab=tab||'stats';
  keys.forEach((k,i)=>{
    const t=document.createElement('button');t.className='tab-btn'+(k===activeTab?' act':'');t.textContent=names[i];
    t.setAttribute('role','tab');t.setAttribute('aria-selected',k===activeTab?'true':'false');
    t.onclick=()=>{tabs.querySelectorAll('.tab-btn').forEach(x=>{x.classList.remove('act');x.setAttribute('aria-selected','false')});t.classList.add('act');t.setAttribute('aria-selected','true');
      Object.values(panels).forEach(p=>p.classList.remove('act'));panels[k].classList.add('act')};
    tabs.appendChild(t);
    const pg=document.createElement('div');pg.className='tab-panel'+(k===activeTab?' act':'');pg.setAttribute('role','tabpanel');panels[k]=pg});
  b.appendChild(tabs);

  // Stats tab
  const sp=SP[r.species],subData=sp.subspecies?sp.subspecies[r.subspecies]:null;
  let sh='<div class="ist">Primary</div>';
  const primaryStats=['health','mana','melee','ranged'];
  primaryStats.forEach(k=>{
    let derived='';
    if(k==='health')derived=r.mHP+' HP';
    else if(k==='mana')derived=r.mMP+' MP';
    else if(k==='melee'){const h=CALC.meleeHit(r,0)-55;derived=(h>=0?'+':'')+h+'% hit, '+(CALC.meleeDmgMod(r)>=0?'+':'')+CALC.meleeDmgMod(r)+' dmg'}
    else if(k==='ranged'){const h=CALC.rangedHit(r,0)-55;derived=(h>=0?'+':'')+h+'% hit, '+(CALC.rangedDmgMod(r)>=0?'+':'')+CALC.rangedDmgMod(r)+' dmg'}
    sh+='<div class="stat-row"><span class="stat-name">'+STAT_LABELS[k]+'</span><span class="stat-val">'+r.stats[k]+'</span><span class="stat-derived">'+derived+'</span></div>'});
  sh+='<div class="ist">Secondary</div>';
  const secStats=['speech','sight','smarts','movement'];
  secStats.forEach(k=>{
    let derived='';
    if(k==='speech')derived=CALC.speech(r)+'%';
    else if(k==='sight')derived=CALC.search(r)+'%';
    else if(k==='smarts')derived=CALC.smarts(r)+'%';
    else if(k==='movement'){const eff=CALC.effMov(r);derived=CALC.combatMove(r)+'m/turn';
      if(eff!==r.stats[k])sh+='<div class="stat-row"><span class="stat-name">'+STAT_LABELS[k]+'</span><span class="stat-val">'+r.stats[k]+' ('+eff+')</span><span class="stat-derived">'+derived+'</span></div>';return}
    sh+='<div class="stat-row"><span class="stat-name">'+STAT_LABELS[k]+'</span><span class="stat-val">'+r.stats[k]+'</span><span class="stat-derived">'+derived+'</span></div>'});
  const traitName=subData?subData.trait:(r.species==='human'?sp.trait:'');
  const traitDesc=subData?subData.traitDesc:(r.species==='human'?sp.traitDesc:'');
  if(traitName)sh+='<div class="ist">Species Trait</div><div class="trait-card"><strong>'+traitName+'</strong><p>'+traitDesc+'</p></div>';
  sh+='<div class="ist">Level</div><div style="font-size:.9rem;color:var(--text2)">Level '+r.level+' Â· '+(r.level<25?r.xp+'/'+r.level*100+' XP':'Max Level')+'</div>';
  if(r.level<25)sh+='<div class="xp-bar-o"><div class="xp-bar-i" style="width:'+Math.min(100,(r.xp/(r.level*100))*100)+'%"></div></div>';
  sh+='<div style="font-size:.9rem;color:var(--gold);margin-top:4px">Gold: '+(r.gold||0)+'g</div>';

  // Class ability info
  const charAbilities=getAbilities(r);
  if(charAbilities.length){sh+='<div class="ist">Class Abilities</div>';
    charAbilities.forEach(ab=>{const cost=CALC.abilityCost(r,ab);
      sh+='<div class="trait-card"><strong>'+ab.name+' ('+cost+' MP)</strong><p>'+ab.desc+'</p></div>'})}
  panels.stats.innerHTML=sh;

  // Equipment tab
  const twoHanded=r.wpn&&r.wpn.twoHand;
  let eh='';
  [{l:'Weapon',k:'wpn',i:r.wpn},{l:'Offhand',k:'oh',i:r.oh},{l:'Armor',k:'arm',i:r.arm}].forEach(s=>{
    eh+='<div class="isl-l">'+s.l+'</div>';
    if(s.k==='oh'&&twoHanded){eh+='<div class="isl isl-empty"><span class="isl-e" style="color:var(--text3);font-style:italic">Locked \u2014 '+r.wpn.name+' (two-handed)</span></div>';return}
    if(s.i){eh+='<div class="isl"><div class="isl-top"><span class="isl-name">'+s.i.name+(s.i.wt!==undefined?wtTag(s.i.wt):'')+'</span></div><div class="isl-i">'+( s.i.desc||'')+'</div>';
      eh+='<div class="isl-a"><button class="iab" data-unequip="'+s.k+'">Unequip</button></div>';
      eh+='</div>'}
    else eh+='<div class="isl isl-empty"><span class="isl-e">Empty</span></div>'});
  const wt=CALC.totalWt(r);if(wt>0)eh+='<div style="font-size:.8rem;color:var(--text3);margin-top:8px">Weight penalty: -'+wt+' Movement</div>';
  panels.equip.innerHTML=eh;
  panels.equip.querySelectorAll('[data-unequip]').forEach(btn=>{
    btn.onclick=()=>{const k=btn.dataset.unequip;if(r.bp.length>=6){showToast('Backpack full!','error');return}r.bp.push(r[k]);r[k]=null;GS.recalcDerived();GS.saveA();ML.openChar('equip');UI.updateHUD()}});

  // Backpack tab
  let bh='';
  for(let i=0;i<6;i++){
    if(i<r.bp.length){const it=r.bp[i];
      bh+='<div class="isl"><div class="isl-top"><span class="isl-name">'+it.name+(it.wt!==undefined?wtTag(it.wt):'')+'</span></div><div class="isl-i">'+(it.desc||'')+'</div><div class="isl-a">';
      if(it.t==='consumable')bh+='<button class="iab" data-use="'+i+'">Use</button>';
      if(it.t==='melee'||it.t==='ranged'||it.t==='armor'||it.t==='shield'||it.t==='quiver'||it.t==='spellbook'||it.t==='light')bh+='<button class="iab" data-equip="'+i+'">Equip</button>';
      if(it.value&&!it.undrop)bh+='<button class="iab" data-sell="'+i+'">Sell ('+it.value+'g)</button>';
      if(!it.undrop)bh+='<button class="iab" data-drop="'+i+'">Drop</button>';
      bh+='</div></div>'}
    else bh+='<div class="isl isl-empty"><span class="isl-e">Empty slot</span></div>'}
  panels.bp.innerHTML=bh;
  panels.bp.querySelectorAll('[data-use]').forEach(btn=>{
    btn.onclick=()=>{const idx=parseInt(btn.dataset.use);const it=r.bp[idx];if(it){const msg=useConsumable(it,r);if(msg)UI.addN(msg,'s');ML.openChar('bp')}}});
  panels.bp.querySelectorAll('[data-equip]').forEach(btn=>{
    btn.onclick=()=>{const idx=parseInt(btn.dataset.equip);const it=r.bp[idx];
      r.bp.splice(idx,1);
      if(it.t==='armor'){if(r.arm)r.bp.push(r.arm);r.arm=it}
      else if(it.t==='shield'||it.t==='quiver'||it.t==='spellbook'||it.t==='light'){
        if(r.wpn&&r.wpn.twoHand){showToast('Cannot equip offhand with two-handed weapon!','error');r.bp.splice(idx,0,it);return}
        if(r.oh)r.bp.push(r.oh);r.oh=it}
      else{if(r.wpn)r.bp.push(r.wpn);r.wpn=it;
        if(it.twoHand&&r.oh){r.bp.push(r.oh);r.oh=null}}
      GS.recalcDerived();GS.saveA();UI.updateHUD();ML.openChar('bp')}});
  panels.bp.querySelectorAll('[data-drop]').forEach(btn=>{
    btn.onclick=()=>{const idx=parseInt(btn.dataset.drop);const it=r.bp.splice(idx,1)[0];GS.saveA();UI.addN('Dropped '+it.name+'.','y');ML.openChar('bp')}});
  panels.bp.querySelectorAll('[data-sell]').forEach(btn=>{
    btn.onclick=()=>{const idx=parseInt(btn.dataset.sell);const it=r.bp[idx];if(!it||!it.value)return;
      r.bp.splice(idx,1);if(!r.gold)r.gold=0;r.gold+=it.value;GS.saveA();UI.updateHUD();
      UI.addN('Sold '+it.name+' for '+it.value+'g.','s');ML.openChar('bp')}});
  Object.values(panels).forEach(p=>b.appendChild(p));
  this.open('m-char')},

openAct(){UI.openActionSheet()},

openJrn(){
  const b=$('m-jrn-b');b.innerHTML='';const r=GS.run,m=GS.getJM();
  const tabs=document.createElement('div');tabs.className='jtabs';tabs.setAttribute('role','tablist');
  const pgs={},names=['Combat','Classes','Species','Bestiary','World'];
  names.forEach((n,i)=>{const t=document.createElement('button');t.className='jtab'+(i===0?' act':'');t.textContent=n;t.setAttribute('role','tab');t.setAttribute('aria-selected',i===0?'true':'false');
    t.onclick=()=>{tabs.querySelectorAll('.jtab').forEach(x=>{x.classList.remove('act');x.setAttribute('aria-selected','false')});t.classList.add('act');t.setAttribute('aria-selected','true');Object.values(pgs).forEach(p=>p.classList.remove('act'));pgs[n].classList.add('act')};
    tabs.appendChild(t);const pg=document.createElement('div');pg.className='jp'+(i===0?' act':'');pg.setAttribute('role','tabpanel');pgs[n]=pg});
  b.appendChild(tabs);
  pgs.Combat.innerHTML='<h3>Combat System</h3><p>Combat uses percentage-based checks. Your hit chance is shown before each attack.</p><h3>Distance</h3><p>Battlefield spans 5mâ€“30m. Melee weapons strike at 5m. Ranged: 10â€“30m (penalty under 10m).</p><h3>Free Movement</h3><p>Each turn you can move AND take an action. Movement distance = Movement stat Ã— 2 meters, reduced by equipment weight.</p><h3>Actions</h3><p><strong style="color:var(--gold)">Attack</strong> â€” Hit chance: 55% + (attack stat âˆ’ 5) Ã— 5% âˆ’ enemy defense Ã— 3%.</p><p><strong style="color:var(--gold)">Block</strong> â€” Raise shield to reduce damage.</p><p><strong style="color:var(--gold)">Use Item</strong> â€” Consume potions mid-combat.</p><p><strong style="color:var(--gold)">Flee</strong> â€” 30% + distance Ã— 1.5% + (Movement âˆ’ 5) Ã— 5%.</p><h3>Damage</h3><p>Weapon dice + (attack stat âˆ’ 5) + trait bonuses. All rolls clamped 5%â€“95%.</p>';
  let clH='<h3>Classes</h3>';Object.values(CL).forEach(c=>{
    let gearStr=c.wpn?c.wpn.name:'â€”';if(c.arm)gearStr+=', '+c.arm.name;if(c.oh)gearStr+=', '+c.oh.name;
    let abStr=c.ability?'<p style="font-size:.9rem;color:var(--gold-bright)">'+c.ability.name+' ('+c.ability.cost+' MP): '+c.ability.desc+'</p>':'';
    clH+='<div style="margin-bottom:16px"><p><strong style="color:var(--gold)">'+c.name+'</strong></p><p style="font-style:italic;color:var(--text2)">'+c.desc+'</p><p style="font-size:.9rem;color:var(--text3)">Gear: '+gearStr+'</p>'+abStr+'</div>'});pgs.Classes.innerHTML=clH;
  let spH='<h3>Species</h3>';Object.entries(SP).forEach(([k,s])=>{spH+='<div style="margin-bottom:16px"><p><strong style="color:var(--gold)">'+s.name+'</strong></p><p style="font-style:italic;color:var(--text2)">'+s.desc+'</p>';
    spH+='<p style="font-size:.85rem;color:var(--text3)">';STAT_NAMES.forEach(st=>{spH+=STAT_LABELS[st]+':'+s.stats[st]+' '});spH+='</p>';
    if(s.subspecies)Object.values(s.subspecies).forEach(sub=>{spH+='<p style="margin-left:12px;margin-top:4px"><strong style="color:var(--gold-bright)">'+sub.name+'</strong> â€” <em style="color:var(--text2)">'+sub.trait+'</em>: '+sub.traitDesc+'</p>'});
    else if(s.trait)spH+='<p style="margin-left:12px"><em style="color:var(--text2)">'+s.trait+'</em>: '+s.traitDesc+'</p>';
    spH+='</div>'});pgs.Species.innerHTML=spH;
  const bst=m.bestiary||{};if(!Object.keys(bst).length)pgs.Bestiary.innerHTML='<h3>Bestiary</h3><p style="color:var(--text3);font-style:italic">No creatures encountered yet.</p>';
  else{let bH='<h3>Bestiary</h3>';Object.entries(bst).forEach(([id,be])=>{const se=r?(r.bSeen[id]||0):0,de=r?(r.bDef[id]||0):0;bH+='<div class="be"><div class="be-n">'+be.name+'</div><div class="be-l">'+be.lore+'</div><div class="be-s">HP:'+be.hp+' ATK:'+be.atk+' DEF:'+be.def+' DMG:'+be.dmg+' Move:'+be.spd+'m Range:'+be.rng+'m</div><div class="be-s" style="margin-top:4px">Encountered: '+se+' | Defeated: '+de+'</div></div>'});pgs.Bestiary.innerHTML=bH}
  pgs.World.innerHTML='<h3>The World</h3><p>The realm lies under an ashen sky. Once-great kingdoms crumbled into scattered settlements, connected by muddy trails winding through forests thick with ancient magic and creeping dangers. Travelers arm themselves not from paranoia but necessity â€” the wilds teem with oozes, beasts, and worse. Yet good folk remain on the roads: gatekeepers, healers, and wanderers who trade stories by firelight. The trail is dangerous, but it is the only way forward.</p>';
  Object.values(pgs).forEach(p=>b.appendChild(p));this.open('m-jrn')},

openMenu(){
  const b=$('m-menu-b');b.innerHTML='';
  const qs=GS.getQS();
  // Quick save button
  if(GS.run){const qsb=document.createElement('button');qsb.className='slb';qsb.textContent='Quick Save';qsb.style.cssText='width:100%;margin-bottom:12px';
    qsb.onclick=()=>{if(GS.qSave()){UI.addN('Game quick saved.','y');ML.openMenu()}else UI.addN('Quick save failed.','d')};b.appendChild(qsb)}
  // Save slots
  const sv=GS.getMSaves();
  const mkSlot=(title,data,loadFn)=>{
    const d=document.createElement('div');d.className='ssl';d.innerHTML='<div class="ssl-h">'+title+'</div>';
    if(data){const clName=CL[data.classes?data.classes[0]:data.class]?CL[data.classes?data.classes[0]:data.class].name:'?';
      d.innerHTML+='<div class="ssl-i">'+data.name+' Â· '+clName+' Lv'+data.level+' Â· '+data.scene+'<br>'+new Date(data.savedAt).toLocaleString()+'</div>';
      const a=document.createElement('div');a.className='ssl-a';
      const lb=document.createElement('button');lb.className='slb';lb.textContent='Load';lb.onclick=()=>{const res=loadFn();if(res==='incompatible'){alert('This save is from an older version.');return}if(res){ML.closeAll();UI.clearN();UI.restoreN();UI.updateHUD();SE.resume()}};a.appendChild(lb);d.appendChild(a)}
    else d.innerHTML+='<div class="ssl-i" style="color:var(--text3)">Empty</div>';return d};
  if(qs)b.appendChild(mkSlot('Quick Save',qs,()=>GS.qLoad()));
  for(let i=0;i<3;i++){const sl=document.createElement('div');sl.className='ssl';sl.innerHTML='<div class="ssl-h">Slot '+(i+1)+'</div>';
    if(sv[i]){const clName=CL[sv[i].classes?sv[i].classes[0]:sv[i].class]?CL[sv[i].classes?sv[i].classes[0]:sv[i].class].name:'?';
      sl.innerHTML+='<div class="ssl-i">'+sv[i].name+' Â· '+clName+' Lv'+sv[i].level+' Â· '+sv[i].scene+'<br>'+new Date(sv[i].savedAt).toLocaleString()+'</div>'}
    else sl.innerHTML+='<div class="ssl-i" style="color:var(--text3)">Empty</div>';
    const a=document.createElement('div');a.className='ssl-a';
    if(GS.run){const sb=document.createElement('button');sb.className='slb';sb.textContent='Save';const ii=i;sb.onclick=()=>{if(GS.mSave(ii)){UI.addN('Saved to slot '+(ii+1)+'.','y')}else{UI.addN('Save failed.','d')}ML.openMenu()};a.appendChild(sb)}
    if(sv[i]){const lb=document.createElement('button');lb.className='slb';lb.textContent='Load';const ii=i;lb.onclick=()=>{const res=GS.mLoad(ii);if(res==='incompatible'){alert('This save is from an older version.');return}if(res){ML.closeAll();UI.clearN();UI.restoreN();UI.updateHUD();SE.resume()}};a.appendChild(lb)}
    sl.appendChild(a);b.appendChild(sl)}
  const nr=document.createElement('button');nr.className='slb dng';nr.textContent='New Adventure';nr.style.cssText='margin-top:12px;width:100%';
  nr.onclick=()=>{if(GS.run&&!confirm('Start new run? Unsaved progress lost.'))return;GS.clearA();ML.closeAll();UI.clearN();UI.showCC()};b.appendChild(nr);
  const nt=document.createElement('div');nt.className='snotice';nt.textContent='Saves are stored in this browser.';b.appendChild(nt);
  const backBtn=(label)=>{const btn=document.createElement('button');btn.className='slb';btn.textContent=label;btn.style.cssText='margin-top:16px;width:100%';btn.onclick=()=>this.openMenu();return btn};
  const howBtn=document.createElement('button');howBtn.className='slb';howBtn.textContent='How to play';howBtn.style.cssText='margin-top:12px;width:100%';
  howBtn.onclick=()=>{b.innerHTML='<h3 class="mt" style="margin-bottom:12px">How to play</h3><p style="margin-bottom:12px;color:var(--text2)">Tap <strong>Actions</strong> to see what you can do: move to new locations, talk to NPCs, search, use items, or save. In combat, use the bar to attack, block, move distance, or flee. Your journal (unlocked when you find the guide) holds combat rules, bestiary, and world lore.</p>';b.appendChild(backBtn('Back to menu'))};b.appendChild(howBtn);
  const chgBtn=document.createElement('button');chgBtn.className='slb';chgBtn.textContent='Changelog';chgBtn.style.cssText='margin-top:8px;width:100%';
  chgBtn.onclick=()=>{b.innerHTML='<h3 class="mt" style="margin-bottom:12px">Changelog</h3><p style="font-size:.9rem;color:var(--text2);margin-bottom:8px">v1.0 \u2014 Massive Content Expansion</p><ul style="margin:0 0 12px 1.2em;color:var(--text2);font-size:.9rem"><li>Third adventure: The Ashen Waste (10 scenes, Elder Dragon boss)</li><li>Expanded tavern settlement: Market Square, Guard Post, Cellar</li><li>32 new enemies across all 5 tiers (39 total)</li><li>40 new items: weapons, armor, offhand, consumables, loot</li><li>12 new NPCs with data-driven dialogue trees and shops</li><li>18 new bounties and 10 new quests</li><li>Multi-ability system: 3 abilities per class (unlock at levels 1, 4, 8)</li><li>Lootable weapons, armor, and offhand from backpack</li><li>Generic shop system: multiple merchants with unique inventories</li><li>4 new debuff types: burn, curse, blind, weaken</li><li>Undying Rage, Divine Shield, Mana Shield combat buffs</li><li>Side locations: Witch Hut, Hermit Cave</li><li>12 new death quotes</li></ul><p style="font-size:.9rem;color:var(--text2);margin-bottom:8px">v0.9</p><ul style="margin:0 0 12px 1.2em;color:var(--text2);font-size:.9rem"><li>Combat overhaul: enemy HP bars, tier badges, visual hit/miss feedback</li><li>5-tier enemy system: Common, Uncommon, Dangerous, Elite, Boss</li><li>Screen shake and damage flash effects in combat</li><li>Variable combat pacing: suspense delays scale with enemy tier</li><li>Multi-wave encounters: face sequential enemies in one fight</li><li>Quick Resolve: skip trivial fights when significantly overleveled</li><li>The Hearthstone Tavern: hub scene with Brynn the Innkeeper</li><li>Bounty Board: repeatable combat bounties with gold and XP rewards</li><li>Quest system: accept and track one-off quests with milestone rewards</li><li>Bounty combat: non-lethal defeat returns you to the tavern</li></ul><p style="font-size:.9rem;color:var(--text2);margin-bottom:8px">v0.8</p><ul style="margin:0 0 12px 1.2em;color:var(--text2);font-size:.9rem"><li>Zone-based combat: Close/Mid/Far zones replace meter distance</li><li>Movement costs your action (free move for Quickfoot, Rogues, high Movement)</li><li>Block halves incoming damage instead of flat reduction</li><li>Failed flee gives enemy a free attack</li><li>Melee requires Close range; ranged has zone penalties</li><li>Turn counter in combat log</li><li>Toast notification system for errors and feedback</li><li>Global error boundary with auto-save</li><li>Save/load validation and corruption recovery</li><li>Character creation input validation with visual feedback</li><li>Scene navigation safety guards</li><li>Redesigned pixel art: icons, species portraits, class icons</li><li>Gameplay balance audit for zone system</li></ul><p style="font-size:.9rem;color:var(--text2);margin-bottom:8px">v0.7</p><ul style="margin:0 0 12px 1.2em;color:var(--text2);font-size:.9rem"><li>Second adventure: The Iron Hollows</li><li>3 new enemies, 2 new items, new NPC</li><li>Slow &amp; stun status effects</li><li>Accessibility improvements</li></ul><p style="font-size:.9rem;color:var(--text2);margin-bottom:8px">v0.6</p><ul style="margin:0 0 12px 1.2em;color:var(--text2);font-size:.9rem"><li>Gold economy: earn gold from combat, sell items from backpack</li><li>Merchant NPC: Garrett the Peddler at Trail\u2019s End (buy/sell potions)</li><li>New item: Marsh Root (heals 5 HP, sellable)</li><li>Items now have sell values</li><li>Bleed status effect from Dire Wolf</li><li>Generic debuff system: any effect type ticks automatically</li></ul><p style="font-size:.9rem;color:var(--text2);margin-bottom:8px">v0.5</p><ul style="margin:0 0 12px 1.2em;color:var(--text2);font-size:.9rem"><li>Extra scene branch: Whispering Bog (optional side path from midway)</li><li>New enemy: Bog Wraith</li><li>Gather Herbs search in post_bog grants Mana Potion</li></ul><p style="font-size:.9rem;color:var(--text2);margin-bottom:8px">v0.4</p><ul style="margin:0 0 12px 1.2em;color:var(--text2);font-size:.9rem"><li>New enemies: Giant Spider (poison) and Dire Wolf</li><li>New items: Mana Potion, Antidote, Wolf Pelt</li><li>Weighted loot drops from enemies</li><li>Poison status effect with Antidote cure</li><li>Extended trail: 4 new scenes with spider and wolf encounters</li><li>Richer NPC dialogue for Aldric and Mira</li><li>Combat item overhaul: use any consumable in combat</li><li>Game data extracted to data.js for easier modding</li><li>Code cleanup: removed legacy CSS vars, unified consumable logic</li></ul><p style="font-size:.9rem;color:var(--text2);margin-bottom:8px">v0.3</p><ul style="margin:0 0 12px 1.2em;color:var(--text2);font-size:.9rem"><li>Choice-only play: no typing; use Actions and scene buttons</li><li>New warm color palette</li><li>Menu: How to play, Changelog, Settings (high contrast, larger text)</li></ul>';b.appendChild(backBtn('Back to menu'))};b.appendChild(chgBtn);
  const setBtn=document.createElement('button');setBtn.className='slb';setBtn.textContent='Settings';setBtn.style.cssText='margin-top:8px;width:100%';
  setBtn.onclick=()=>{const st=GS.getSettings();b.innerHTML='<h3 class="mt" style="margin-bottom:12px">Settings</h3>';
    const row=(label,checked,key)=>{const wrap=document.createElement('div');wrap.style.cssText='display:flex;align-items:center;justify-content:space-between;margin-bottom:12px';
      const lab=document.createElement('span');lab.textContent=label;lab.style.color='var(--text2)';const cb=document.createElement('input');cb.type='checkbox';cb.checked=!!checked;cb.onchange=()=>{st[key]=cb.checked;GS.setSettings(st)};wrap.appendChild(lab);wrap.appendChild(cb);return wrap};
    b.appendChild(row('High contrast',st.highContrast,'highContrast'));b.appendChild(row('Larger text',st.largeText,'largeText'));b.appendChild(backBtn('Back to menu'))};b.appendChild(setBtn);
  this.open('m-menu')},

openDlg(speaker,title,text,opts,cb){
  $('dlg-t').textContent=speaker;const b=$('m-dlg-b');b.innerHTML='';
  b.innerHTML+='<div class="dlg-name">'+speaker+'</div>';
  if(title)b.innerHTML+='<div class="dlg-title">'+title+'</div>';
  b.innerHTML+='<div class="dtx">'+text+'</div>';
  if(opts&&opts.length){const od=document.createElement('div');od.className='dopts';
    opts.forEach((o,i)=>{const btn=document.createElement('button');btn.className='mbtn';btn.textContent=o.text;btn.onclick=()=>{ML.closeAll();if(cb)cb(i,o)};od.appendChild(btn)});b.appendChild(od)}
  this.open('m-dlg');
  // Remove close button and backdrop-close for dialogue (player must choose)
  const modal=$('m-dlg');const mx=modal.querySelector('.mx');if(mx)mx.style.display='none';
  modal.onclick=e=>{e.stopPropagation()}},

openLvl(lvl,cb){
  const b=$('m-lvl-b');b.innerHTML='';const r=GS.run;
  b.innerHTML+='<p style="text-align:center;font-size:1.2rem;color:var(--gold);margin-bottom:8px">You reached level '+lvl+'!</p>';
  b.innerHTML+='<p style="text-align:center;color:var(--green);margin-bottom:12px">+1 Health (automatic, +4 max HP)<br>HP and MP fully restored!</p>';
  b.innerHTML+='<div class="ist">Choose a stat to increase by 1:</div>';
  STAT_NAMES.forEach(k=>{const btn=document.createElement('button');btn.className='mbtn';
    btn.innerHTML='<strong>'+STAT_LABELS[k]+'</strong> <span style="color:var(--text2)">(currently '+r.stats[k]+')</span>';
    btn.onclick=()=>{r.stats[k]++;GS.recalcDerived();r.hp=r.mHP;r.mp=r.mMP;GS.saveA();ML.closeAll();UI.updateHUD();if(cb)cb()};
    b.appendChild(btn)});
  this.open('m-lvl')}
};

// === CHARACTER CREATION ===
const CC={
step:1,sp:null,subsp:null,cl:null,humanBonus:[],
reset(){this.step=1;this.sp=null;this.subsp=null;this.cl=null;this.humanBonus=[];this.showStep(1);UI.el.ni.value='';UI.el.cbk.style.display='none';UI.el.cnx.textContent='Continue';UI.el.cc.style.opacity='1';this.buildSP();this.buildCL()},
showStep(n){
  const prev=document.querySelector('.ccs.act');const next=$('ccs'+n);
  if(prev&&next&&prev!==next&&!REDUCED_MOTION){
    prev.style.opacity='0';
    setTimeout(()=>{prev.classList.remove('act');next.classList.add('act');next.style.opacity='0';
      requestAnimationFrame(()=>{next.style.opacity='1'})},200);
  } else {document.querySelectorAll('.ccs').forEach(s=>s.classList.remove('act'));if(next)next.classList.add('act')}
  UI.el.cbk.style.display=n>1?'block':'none';UI.el.cnx.textContent=n===6?'Begin Adventure':'Continue';
  let totalSteps=6;if(this.sp==='human')totalSteps=6;else if(this.sp&&SP[this.sp]&&!SP[this.sp].subspecies)totalSteps=5;
  UI.el.ccStep.textContent='Step '+n+' of '+totalSteps;
  if(n===1)requestAnimationFrame(()=>UI.el.ni.focus());if(n===6)this.buildSum()},
_shake(el){el.classList.remove('cc-shake');void el.offsetWidth;el.classList.add('cc-shake')},
_clearHints(){document.querySelectorAll('.cc-hint').forEach(h=>h.remove())},
_addHint(parent,msg){this._clearHints();const h=document.createElement('div');h.className='cc-hint';h.textContent=msg;parent.appendChild(h)},
async next(){
  this._clearHints();
  if(this.step===1){const v=UI.el.ni.value.trim();
    if(!v||v.length<1||v.length>20){this._shake(UI.el.ni);this._addHint($('ccs1'),'Enter a name (1\u201320 characters).');UI.el.ni.focus();return}}
  if(this.step===2&&!this.sp){this._addHint($('ccs2'),'Select a species to continue.');return}
  if(this.step===3&&!this.subsp){this._addHint($('ccs3'),'Select a lineage to continue.');return}
  if(this.step===4&&this.humanBonus.length<2){this._addHint($('ccs4'),'Assign both bonus points to continue.');return}
  if(this.step===5&&!this.cl){this._addHint($('ccs5'),'Select a class to continue.');return}
  if(this.step===6){
    const nm=UI.el.ni.value.trim();
    GS.newRun(nm,this.sp,this.subsp,this.cl,this.sp==='human'?this.humanBonus:null);
    const m=GS.getJM();if(m.guideFound||m.handbookFound){GS.run.jrnUnlk=true;GS.saveA()}
    const d=REDUCED_MOTION?0:300;
    UI.el.cc.style.transition='opacity '+d+'ms ease';UI.el.cc.style.opacity='0';
    await UI._wait(d+50);
    UI.showGame();
    UI.el.gm.style.opacity='0';UI.el.gm.style.transition='opacity '+d+'ms ease';
    await UI._wait(50);UI.el.gm.style.opacity='1';
    SE.enter('trailhead');return}
  this.step++;
  if(this.step===3&&this.sp==='human'){this.step=4;this.buildHumanBonus()}
  else if(this.step===3)this.buildSubSP();
  if(this.step===4&&this.sp!=='human')this.step=5;
  this.showStep(this.step)},
back(){if(this.step>1){
  this.step--;
  if(this.step===4&&this.sp!=='human')this.step=3;
  if(this.step===3&&this.sp==='human')this.step=2;
  this.showStep(this.step)}},
mkCard(cont,key,data,portraits,sel,setSel){
  const c=document.createElement('div');c.className='ccd';c.setAttribute('role','radio');c.setAttribute('aria-checked','false');c.setAttribute('tabindex','0');
  c.setAttribute('aria-label',data.name+': '+data.desc);
  const cv=document.createElement('canvas');cv.width=64;cv.height=64;cv.setAttribute('aria-hidden','true');
  if(portraits)PA.renderPortrait(cv,key);
  const info=document.createElement('div');info.className='ccd-i';
  let statsLine='';
  if(data.stats&&typeof data.stats==='object'&&!Array.isArray(data.stats)){
    const s=data.stats;statsLine=STAT_NAMES.map(k=>STAT_LABELS[k].substring(0,3)+':'+s[k]).join(' ')}
  else if(typeof data.stats==='string')statsLine=data.stats;
  let traitLine='';if(data.trait)traitLine='<div class="ccd-s" style="color:var(--gold)">'+data.trait+': '+(data.traitDesc||'')+'</div>';
  info.innerHTML='<div class="ccd-n">'+data.name+'</div><div class="ccd-d">'+data.desc+'</div>'+(statsLine?'<div class="ccd-s">'+statsLine+'</div>':'')+traitLine;
  c.appendChild(cv);c.appendChild(info);
  const pick=()=>{cont.querySelectorAll('.ccd').forEach(x=>{x.classList.remove('sel');x.setAttribute('aria-checked','false')});c.classList.add('sel');c.setAttribute('aria-checked','true');setSel(key)};
  c.onclick=pick;c.onkeydown=e=>{if(e.key==='Enter'||e.key===' '){e.preventDefault();pick()}};cont.appendChild(c)},
buildSP(){const c=$('sp-cards');c.innerHTML='';Object.entries(SP).forEach(([k,s])=>this.mkCard(c,k,s,true,this.sp,v=>{this.sp=v;this.subsp=null}))},
buildSubSP(){const c=$('subsp-cards');c.innerHTML='';const sp=SP[this.sp];if(!sp||!sp.subspecies)return;this.subsp=null;
  Object.entries(sp.subspecies).forEach(([k,sub])=>this.mkCard(c,k,sub,false,this.subsp,v=>{this.subsp=v}))},
buildHumanBonus(){const c=$('hb-list');c.innerHTML='';this.humanBonus=[];$('hb-pts').textContent='Points remaining: 2';
  STAT_NAMES.forEach(k=>{const row=document.createElement('div');row.className='hb-row';row.id='hb-'+k;
    const baseVal=SP.human.stats[k];
    row.innerHTML='<span class="hb-name">'+STAT_LABELS[k]+'</span><span class="hb-val" id="hbv-'+k+'">'+baseVal+'</span>';
    const btn=document.createElement('button');btn.className='hb-btn';btn.id='hbb-'+k;btn.textContent='+';
    btn.onclick=()=>{
      if(this.humanBonus.includes(k)){
        this.humanBonus=this.humanBonus.filter(x=>x!==k);$('hbv-'+k).textContent=baseVal;btn.textContent='+';btn.style.opacity='1';
        $('hb-pts').textContent='Points remaining: '+(2-this.humanBonus.length);
        STAT_NAMES.forEach(sk=>{const b=$('hbb-'+sk);if(b){b.disabled=false;b.style.opacity='1'}});return}
      if(this.humanBonus.length>=2)return;
      this.humanBonus.push(k);$('hbv-'+k).textContent=baseVal+1;btn.textContent='âˆ’';
      $('hb-pts').textContent='Points remaining: '+(2-this.humanBonus.length);
      if(this.humanBonus.length>=2)STAT_NAMES.forEach(sk=>{if(!this.humanBonus.includes(sk)){const b=$('hbb-'+sk);if(b){b.disabled=true;b.style.opacity='.3'}}})};
    row.appendChild(btn);c.appendChild(row)})},
buildCL(){const c=$('cl-cards');c.innerHTML='';
  Object.entries(CL).forEach(([k,cl])=>{
    const card=document.createElement('div');card.className='ccd';card.setAttribute('role','radio');card.setAttribute('aria-checked','false');card.setAttribute('tabindex','0');
    card.setAttribute('aria-label',cl.name+': '+cl.desc);
    const cv=document.createElement('canvas');cv.width=64;cv.height=64;cv.setAttribute('aria-hidden','true');
    PA.renderClassIcon(cv,k);
    const info=document.createElement('div');info.className='ccd-i';
    let gearLine=cl.wpn?cl.wpn.name:'â€”';if(cl.arm)gearLine+=', '+cl.arm.name;if(cl.oh)gearLine+=', '+cl.oh.name;
    let abilityLine='';const ccAb=cl.abilities?cl.abilities[0]:cl.ability;if(ccAb)abilityLine='<div class="ccd-s" style="color:var(--gold)">'+ccAb.name+' ('+ccAb.cost+' MP): '+ccAb.desc+'</div>';
    info.innerHTML='<div class="ccd-n">'+cl.name+'</div><div class="ccd-d">'+cl.desc+'</div><div class="ccd-s">Gear: '+gearLine+'</div>'+abilityLine;
    card.appendChild(cv);card.appendChild(info);
    const pick=()=>{c.querySelectorAll('.ccd').forEach(x=>{x.classList.remove('sel');x.setAttribute('aria-checked','false')});card.classList.add('sel');card.setAttribute('aria-checked','true');this.cl=k};
    card.onclick=pick;card.onkeydown=e=>{if(e.key==='Enter'||e.key===' '){e.preventDefault();pick()}};c.appendChild(card)})},
buildSum(){const c=$('cc-sum');const nm=UI.el.ni.value.trim(),sp=SP[this.sp],cl=CL[this.cl];
  const subData=sp.subspecies?sp.subspecies[this.subsp]:null;
  const stats={};STAT_NAMES.forEach(k=>{stats[k]=sp.stats[k]||5});
  if(this.sp==='human')this.humanBonus.forEach(k=>{if(stats[k]!==undefined)stats[k]++});
  const mHP=stats.health*4;
  let mMP=stats.mana*4;if(this.subsp==='brightelf'||this.subsp==='ashborn')mMP+=4;
  const traitName=subData?subData.trait:(this.sp==='human'?sp.trait:'');
  const traitDesc=subData?subData.traitDesc:(this.sp==='human'?sp.traitDesc:'');
  let h=[['Name',nm],['Species',sp.name+(subData?' â€” '+subData.name:'')],['Class',cl.name],['Max HP',mHP],['Max MP',mMP]];
  const sumAb=cl.abilities?cl.abilities[0]:cl.ability;if(sumAb)h.push(['Ability',sumAb.name+' ('+sumAb.cost+' MP)']);
  if(traitName)h.push(['Trait',traitName]);
  let html=h.map(([l,v])=>'<div class="csr"><span class="csl">'+l+'</span><span class="csv">'+v+'</span></div>').join('');
  html+='<div class="ist" style="margin-top:10px">Stats</div>';
  STAT_NAMES.forEach(k=>{html+=statBar(STAT_LABELS[k],stats[k])});
  if(traitDesc)html+='<div style="margin-top:10px;color:var(--text2);font-size:.9rem;font-style:italic">'+traitDesc+'</div>';
  c.innerHTML=html}
};

// === SCENE ENGINE ===
const SE={
_prevScene:null,

async enter(id){
  const r=GS.run,prevId=r.scene;
  if(id===prevId&&!(SCENE_DATA[id]&&SCENE_DATA[id].events.combat))return;
  const scene=SCENE_DATA[id];
  if(!scene){UI.addN("You can't go that way.",'y');console.warn('Undefined scene:',id);return}
  this._prevScene=prevId;
  r.scene=id;r.cs=null;GS.saveA();UI.setCombatMode(false);
  const firstVisit=!r.ss['visited_'+id];

  if(scene.events.combat){await this._startCombat(id,scene);return}

  if(id!==prevId&&r.mp<r.mMP){let regen=1;if(r.subspecies==='brightelf')regen=2;r.mp=Math.min(r.mp+regen,r.mMP);GS.saveA();UI.updateHUD()}

  if(prevId&&prevId!==id){
    UI.el.nw.style.transition='opacity '+(REDUCED_MOTION?0:200)+'ms ease';
    UI.el.nw.style.opacity='0';await UI._wait(250);
  }

  await UI.showTitleCard(scene.name,firstVisit?scene.subtitle:null,firstVisit?1000:500);

  r.ss['visited_'+id]=true;GS.saveA();
  UI.clearN();UI.addN(scene.description);
  if(scene.npcs)scene.npcs.forEach(nid=>{const n=NPCS[nid];if(n)UI.addN(n.desc,'f');else console.warn('Unknown NPC:',nid)});
  UI.renderNPCButtons(id);
  UI.renderSceneActions(id);
  UI.renderExits(id);
  if(scene.events&&scene.events.onEnter)scene.events.onEnter(r);
  if(firstVisit&&scene.events&&scene.events.onFirstVisit)scene.events.onFirstVisit(r);
  UI.el.nw.style.opacity='1';UI.updateHUD();
  requestAnimationFrame(()=>{const first=UI.el.nw.querySelector('button');if(first)first.focus()});
},

async _startCombat(id,scene){
  const r=GS.run;
  UI.addN(scene.description);
  UI.addN('Something stirs in the shadows ahead\u2026','f');
  await UI._wait(500);
  const combat=scene.events.combat;
  const waves=Array.isArray(combat)?combat:[combat];
  r._combatWaves=waves;r._combatWaveIdx=0;
  const eKey=waves[0],eName=ENEMIES[eKey]?ENEMIES[eKey].name:'a creature';
  UI.addN('A '+eName+' lurches from the undergrowth, blocking your path!','d');
  if(waves.length>1)UI.addN('You sense more foes waiting behind it\u2026','y');
  await UI._wait(300);
  const cs=CMB.start(eKey);
  if(!cs){UI.addN('The shadows disperse. Nothing attacks.','f');UI.updateHUD();return}
  UI.setCombatMode(true);
  UI.addN('Combat begins! You are at '+cs.playerZone.toUpperCase()+' range.','y');
  if(waves.length>1)UI.addN('Wave 1 of '+waves.length,'y');
  const eTier=ENEMIES[eKey]?ENEMIES[eKey].tier||1:1;
  if(r.level>=(eTier*3+2)&&waves.length===1){
    const qr=document.createElement('div');qr.style.cssText='margin-top:8px;padding:10px;background:var(--bg3);border:1px solid var(--border);border-radius:6px';
    qr.innerHTML='<div style="font-size:.85rem;color:var(--text2);margin-bottom:6px">This foe poses little threat.</div>';
    const qb=document.createElement('button');qb.className='nav-btn';qb.textContent='Quick Resolve';
    qb.onclick=async()=>{qr.remove();UI.setCombatBusy(true);
      const enemy=cs.enemy;const dmgTaken=CALC.rollDice(enemy.dD);r.hp=Math.max(1,r.hp-dmgTaken);
      enemy.hp=0;cs.over=true;cs.won=true;GS.recDef(enemy.id);GS.saveA();
      UI.addN('You dispatch the '+enemy.name+' with ease. Took '+dmgTaken+' damage.','s');
      UI.setCombatMode(false);await UI._wait(300);this.onWin()};
    qr.appendChild(qb);UI.addEl(qr);
  }
  UI.updateHUD();
},

async doCombatAction(cmd){
  if(UI._busy)return;
  UI.setCombatBusy(true);
  const cs0=CMB.gs();
  const eHPBefore=cs0?cs0.enemy.hp:0;
  const pHPBefore=GS.run?GS.run.hp:0;
  const allMs=CMB.pAct(cmd);
  const cs1=CMB.gs();
  const eHPAfter=cs1?cs1.enemy.hp:0;
  const pHPAfter=GS.run?GS.run.hp:0;
  const eDmgDealt=eHPBefore-eHPAfter;
  const pDmgTaken=pHPBefore-pHPAfter;
  const playerMs=[],enemyMs=[];let sep=false;
  allMs.forEach(m=>{
    if(!sep&&!m.t.startsWith('The '))playerMs.push(m);
    else{sep=true;enemyMs.push(m)}});
  if(!enemyMs.length){playerMs.length=0;playerMs.push(...allMs)}
  for(const m of playerMs){UI.addN(m.t,m.c)}
  UI.updateZoneDisplay(true);
  if(eDmgDealt>0)UI.combatFX('enemy_hit');
  if(eDmgDealt>0)UI.combatFX('dmg',-eDmgDealt);
  const hasPlayerMiss=playerMs.some(m=>m.t.includes('MISS'));
  if(hasPlayerMiss)UI.combatFX('miss');
  if(enemyMs.length){
    const tier=cs1&&cs1.enemy?cs1.enemy.tier||1:1;
    const suspenseDelay=Math.min(800,300+tier*80);
    await UI._wait(REDUCED_MOTION?0:suspenseDelay);
  }
  for(const m of enemyMs){UI.addN(m.t,m.c)}
  if(pDmgTaken>0){UI.combatFX('player_hit');UI.combatFX('dmg',pDmgTaken)}
  const hasEnemyMiss=enemyMs.some(m=>m.t.includes('misses'));
  if(hasEnemyMiss)UI.combatFX('miss');
  if(enemyMs.length)await UI._wait(REDUCED_MOTION?0:250);
  UI.updateHUD();
  const ca=CMB.gs();
  if(ca){
    UI.updateCombatUI();
    if(ca.over){
      if(ca.fled){this._handleFlee();return}
      if(ca.won)this.onWin();
      else this.onDeath();
      return;
    }
  }
  UI.setCombatBusy(false);
},

async _handleFlee(){
  UI.setCombatMode(false);
  UI.addN('You turn and sprint down the trail. The creature doesn\'t give chase.','s');
  await UI._wait(300);
  if(this._prevScene)this.enter(this._prevScene);
},

resume(){
  const cs=CMB.gs();
  if(cs&&!cs.over){UI.setCombatMode(true)}
  else{UI.setCombatMode(false)}
  UI.updateHUD();
},

getActions(){
  const r=GS.run,scene=SCENE_DATA[r.scene];if(!scene)return[];
  const a=[];
  if(scene.npcs)scene.npcs.forEach(nid=>{const n=NPCS[nid];if(n)a.push({l:'Talk to '+n.name,cmd:'talk_'+nid,d:n.desc})});
  if(scene.actions)scene.actions.forEach(act=>{if(!act.condition||act.condition(r))a.push({l:act.label,cmd:act.id,d:act.desc||''})});
  if(scene.exits)Object.keys(scene.exits).forEach(k=>{const ex=scene.exits[k];
    if(ex.discovered||r.ss['exit_'+r.scene+'_'+k])
      a.push({l:(k==='back'?'\u2190 ':'')+'Go to '+ex.label+(k!=='back'?' \u2192':''),cmd:'go_'+ex.scene,d:''})});
  return a;
},

handleAction(cmd){
  const r=GS.run,sceneId=r.scene;
  if(cmd.startsWith('go_')){this.enter(cmd.slice(3));return}
  if(cmd.startsWith('talk_')){
    const nid=cmd.slice(5);
    if(nid==='aldric')this.aldric();
    else if(nid==='mira')this.mira();
    else if(nid==='garrett')this.garrett();
    else if(nid==='torgun')this.torgun();
    else if(nid==='brynn')this.brynn();
    else if(NPCS[nid]&&NPCS[nid].dialogue)this.talkNPC(nid);
    else if(NPCS[nid])UI.addN(NPCS[nid].desc,'f');
    return;
  }
  if(cmd==='talk'){
    const scene=SCENE_DATA[sceneId];
    if(scene&&scene.npcs&&scene.npcs.length){this.handleAction('talk_'+scene.npcs[0]);return}
    UI.addN('There is no one here to talk to.','y');return;
  }
  if(cmd==='search'){
    if(sceneId==='midway'){
      if(!r.ss.pouch){r.ss.pouch=true;
        if(r.bp.length<6){r.bp.push({...ITEMS.hpot});UI.addN('You pry the pouch from the mud. Inside: a small vial of glowing red liquid \u2014 a Health Potion! Stowed in your backpack.','s')}
        else{UI.addN('The pouch holds a Health Potion but your backpack is full!','d');r.ss.pouch=false}GS.saveA()}
      else UI.addN('The empty pouch lies in the mud. Nothing else here.','f');return}
    if(sceneId==='post_ooze'){
      if(!r.ss.oozeSearch1){r.ss.oozeSearch1=true;
        if(r.bp.length<6){r.bp.push({...ITEMS.guide});r.hbFound=true;r.jrnUnlk=true;
          GS.setJM({guideFound:true});GS.saveA();
          UI.addN("You reach into the dissolving slime and pull out a weathered leather-bound book. Its pages are miraculously dry. The cover reads: \u201cPlayer\u2019s Guide.\u201d",'s');
          UI.addN("The guide has been added to your backpack. Your journal is now available!",'s');
          UI.updateHUD();UI.pulseJ()}
        else{UI.addN('Something solid, but your backpack is full! Make room and search again.','d');r.ss.oozeSearch1=false;GS.saveA()}}
      else if(!r.ss.oozeSearch2){r.ss.oozeSearch2=true;GS.saveA();
        UI.addN('You sift through the remains more carefully, but find only dissolving slime and a faint acidic smell.','f')}
      else UI.addN('Nothing more to find in the remains.','f');return}
    UI.addN('You look around carefully but find nothing of interest.','f');return;
  }
  if(cmd==='search_spider'){
    if(!r.ss.spiderSearch1){r.ss.spiderSearch1=true;
      if(r.bp.length<6){r.bp.push({...ITEMS.antidote});UI.addN('You cut through the webbing and find a small vial of greenish liquid \u2014 an Antidote. Someone came prepared.','s')}
      else{UI.addN('Something useful in the webs, but your backpack is full!','d');r.ss.spiderSearch1=false}GS.saveA()}
    else UI.addN('Nothing but old bones and silk.','f');return}
  if(cmd==='search_wolf'){
    if(!r.ss.wolfSearch1){r.ss.wolfSearch1=true;
      if(r.bp.length<6){r.bp.push({...ITEMS.hpot});UI.addN('Among the scattered remains you find a battered traveler\u2019s satchel. Inside: a Health Potion, still intact.','s')}
      else{UI.addN('A satchel with supplies, but your backpack is full!','d');r.ss.wolfSearch1=false}GS.saveA()}
    else UI.addN('Nothing else of value in the den.','f');return}
  if(cmd==='search_bog'){
    if(!r.ss.bogSearch1){r.ss.bogSearch1=true;
      if(r.bp.length<6){r.bp.push({...ITEMS.mpot});UI.addN('You gather the pale herbs. They have a faint magical shimmer \u2014 crushed into a vial, they could restore mana. A Mana Potion, of sorts.','s')}
      else{UI.addN('The herbs look useful, but your backpack is full!','d');r.ss.bogSearch1=false}GS.saveA()}
    else UI.addN('Nothing more grows here.','f');return}
  if(cmd==='search_ih_tunnels'){
    if(!r.ss.ihTunnelSearch){r.ss.ihTunnelSearch=true;
      if(r.bp.length<6){r.bp.push({...ITEMS.dwarven_ale});UI.addN('Inside the crate you find a dusty bottle of Dwarven Ale. Still sealed, still potent.','s')}
      else{UI.addN('The crate holds something, but your backpack is full!','d');r.ss.ihTunnelSearch=false}GS.saveA()}
    else UI.addN('Nothing else in the crate.','f');return}
  if(cmd==='search_ih_crawler'){
    if(!r.ss.ihCrawlerSearch){r.ss.ihCrawlerSearch=true;
      if(r.bp.length<6){r.bp.push({...ITEMS.iron_shard});UI.addN('You pry a jagged shard of living iron from the nest. It\u2019s warm to the touch.','s')}
      else{UI.addN('Something valuable in the nest, but your backpack is full!','d');r.ss.ihCrawlerSearch=false}GS.saveA()}
    else UI.addN('Nothing else in the debris.','f');return}
  if(cmd==='search_ih_golem'){
    if(!r.ss.ihGolemSearch){r.ss.ihGolemSearch=true;
      if(r.bp.length<6){r.bp.push({...ITEMS.dwarven_ale});UI.addN('The flask survived the golem\u2019s collapse. Dwarven Ale \u2014 could come in handy.','s')}
      else{UI.addN('A flask among the rubble, but your backpack is full!','d');r.ss.ihGolemSearch=false}GS.saveA()}
    else UI.addN('Nothing more among the iron.','f');return}
  if(cmd==='leave_hollows'){this.runComplete();return}
  if(cmd==='leave_waste'){this.runComplete();return}
  if(cmd==='rest'){this.runComplete();return}
  if(cmd==='search_ash_ruins'){
    if(!r.ss.ashRuinsSearch){r.ss.ashRuinsSearch=true;
      if(r.bp.length<6){r.bp.push({...ITEMS.ghpot});UI.addN('You pry open the visor. Inside: a Greater Health Potion, miraculously intact.','s')}
      else{UI.addN('Something useful in the armor, but your backpack is full!','d');r.ss.ashRuinsSearch=false}GS.saveA()}
    else UI.addN('Nothing more in the ruins.','f');return}
  if(cmd==='bounty_board'){this.openBountyBoard();return}
},

async onWin(){
  UI.setCombatMode(false);
  const cs=GS.run.cs,r=GS.run;if(!cs||!cs.enemy)return;
  const enemy=cs.enemy,xp=enemy.xp||0;
  const waves=r._combatWaves||[];
  const waveIdx=(r._combatWaveIdx||0)+1;
  if(waveIdx<waves.length){
    r._combatWaveIdx=waveIdx;
    const goldDrop=enemy.gold||0;if(goldDrop){if(!r.gold)r.gold=0;r.gold+=goldDrop}
    if(xp)GS.addXP(xp);
    const loot=rollLoot(enemy);if(loot&&r.bp.length<6)r.bp.push(loot);
    GS.saveA();UI.updateHUD();
    UI.addN('The '+enemy.name+' falls!','s');
    if(loot&&r.bp.length<=6)UI.addN('Looted: '+loot.name,'y');
    await UI._wait(600);
    const nextKey=waves[waveIdx],nextName=ENEMIES[nextKey]?ENEMIES[nextKey].name:'another foe';
    UI.addN('Another foe emerges \u2014 a '+nextName+'!','d');
    await UI._wait(400);
    const cs2=CMB.start(nextKey);
    if(!cs2){UI.addN('The shadows disperse.','f');UI.updateHUD();return}
    UI.setCombatMode(true);
    UI.addN('Wave '+(waveIdx+1)+' of '+waves.length+' \u2014 '+cs2.playerZone.toUpperCase()+' range.','y');
    UI.updateHUD();UI.setCombatBusy(false);return;
  }
  r._combatWaves=null;r._combatWaveIdx=0;
  await UI._wait(500);

  const card=document.createElement('div');card.className='vic-card';
  card.innerHTML='<div class="vic-h">\u2726 VICTORY</div>';
  card.innerHTML+='<div class="vic-stat">'+enemy.name+' defeated</div>';
  const xpRes=xp?GS.addXP(xp):{gained:0,leveled:false,lvls:[]};
  if(xp)card.innerHTML+='<div class="vic-stat">XP gained: +'+xpRes.gained+'</div>';
  const goldDrop=enemy.gold||0;if(goldDrop){if(!r.gold)r.gold=0;r.gold+=goldDrop;GS.saveA()}
  card.innerHTML+='<div class="vic-stat">HP remaining: '+r.hp+'/'+r.mHP+'</div>';
  card.innerHTML+='<div class="vic-stat">MP remaining: '+r.mp+'/'+r.mMP+'</div>';
  if(goldDrop)card.innerHTML+='<div class="vic-stat" style="color:var(--gold)">Gold earned: +'+goldDrop+'g</div>';

  if(xpRes.leveled){
    xpRes.lvls.forEach(lvl=>{
      const lvlDiv=document.createElement('div');
      lvlDiv.innerHTML='<div class="vic-lvl-h">Level Up! Level '+lvl+' reached!</div>';
      lvlDiv.innerHTML+='<div class="vic-lvl-info">+1 Health (+4 max HP). HP and MP fully restored!</div>';
      lvlDiv.innerHTML+='<div style="font-size:.85rem;color:var(--text2);margin-bottom:6px">Choose a stat to increase:</div>';
      const grid=document.createElement('div');grid.className='vic-stat-grid';
      STAT_NAMES.forEach(k=>{const b=document.createElement('button');b.className='vic-stat-btn';
        b.innerHTML=STAT_LABELS[k]+'<span>'+r.stats[k]+'</span>';
        b.onclick=()=>{r.stats[k]++;GS.recalcDerived();r.hp=r.mHP;r.mp=r.mMP;GS.saveA();UI.updateHUD();
          grid.querySelectorAll('.vic-stat-btn').forEach(x=>x.disabled=true);
          b.style.borderColor='var(--gold)';b.style.color='var(--gold)'};
        grid.appendChild(b)});
      lvlDiv.appendChild(grid);card.appendChild(lvlDiv)});
  }

  const loot=rollLoot(enemy);
  if(loot){
    card.innerHTML+='<div class="vic-loot-h">Loot</div>';
    const lootRow=document.createElement('div');lootRow.className='vic-loot-row';
    lootRow.innerHTML='<span class="vic-loot-name">'+loot.name+'</span><span class="vic-loot-desc">'+loot.desc+'</span>';
    if(r.bp.length<6){const takeBtn=document.createElement('button');takeBtn.className='vic-take-btn';takeBtn.textContent='Take';
      takeBtn.onclick=()=>{r.bp.push(loot);GS.saveA();takeBtn.disabled=true;takeBtn.textContent='Taken';UI.updateHUD()};lootRow.appendChild(takeBtn)}
    else{const fullBtn=document.createElement('button');fullBtn.className='vic-take-btn';fullBtn.disabled=true;fullBtn.textContent='Full';lootRow.appendChild(fullBtn)}
    card.appendChild(lootRow);
  }

  if(r.debuffs&&r.debuffs.length){r.debuffs.forEach(d=>{card.innerHTML+='<div class="vic-stat" style="color:var(--red)">Status: '+d.type+' ('+d.remaining+' turns)</div>'})}

  UI.addEl(card);UI.updateHUD();
  await UI._wait(500);
  if(r.activeBounty&&r.scene==='bounty_arena'){
    this.completeBounty();return}
  const nextMap={gray_ooze:'post_ooze',giant_spider:'post_spider',dire_wolf:'post_wolf',bog_wraith:'post_bog',cave_crawler:'ih_post_crawler',mine_shade:'ih_post_shade',iron_golem:'ih_post_golem',
    ember_beetle:'ash_post_road',fungal_horror:'ash_post_swamp',corrupted_knight:'ash_post_ruins',ash_wyrm:'ash_post_tower',elder_dragon:'ash_exit'};
  const nextScene=nextMap[enemy.id]||null;
  if(nextScene){
    const goBtn=document.createElement('button');goBtn.className='nav-btn';goBtn.style.marginTop='12px';
    goBtn.textContent='Continue \u2192';goBtn.onclick=()=>SE.enter(nextScene);
    UI.addEl(goBtn);
  }
},

async onDeath(){
  UI.setCombatMode(false);
  const r=GS.run;
  if(r.activeBounty&&r.scene==='bounty_arena'){
    r.hp=1;GS.saveA();UI.updateHUD();
    UI.addN('You fall, but drag yourself to safety\u2026','d');
    await UI._wait(800);
    this.failBounty();return}
  UI.addN('Everything fades to black\u2026','d');
  await UI._wait(1000);
  UI.showDeathScreen();
},
deathLoad(){
  UI.hideDeathScreen();
  const qs=GS.getQS();
  if(qs){GS.qLoad();UI.clearN();UI.restoreN();UI.updateHUD();SE.resume();return}
  const sv=GS.getMSaves();
  for(let i=0;i<3;i++){if(sv[i]){GS.mLoad(i);UI.clearN();UI.restoreN();UI.updateHUD();SE.resume();return}}
},
deathNewRun(){UI.hideDeathScreen();GS.clearA();UI.clearN();UI.showCC()},
deathTitle(){UI.hideDeathScreen();GS.clearA();UI.clearN();
  UI.el.app.classList.remove('vis');UI.showLanding()},

aldric(){
  const r=GS.run;
  if(r.ss.aldric){
    ML.openDlg('ALDRIC','The Gatekeeper','"Back again? The trail\u2019s gotten worse since you left. Spiders in the canopy past the ooze, and wolves in the hollow beyond. Watch yourself."',
      [{text:'"Tell me about the spiders."'},{text:'"What about the wolves?"'},{text:'"I\u2019ll be careful."'}],
      (i)=>{if(i===0)ML.openDlg('ALDRIC','The Gatekeeper','"Giant Spiders \u2014 they spit venom from the treetops. Keep your distance if you can, but they\u2019ll close fast. Carry an Antidote or you\u2019ll regret it."',[{text:'"Noted."'}],()=>{});
        else if(i===1)ML.openDlg('ALDRIC','The Gatekeeper','"Dire Wolves. Fast, strong, and smart. They start far but close the gap before you can blink. Melee fighters should let them come to you. Ranged? Shoot early, shoot often."',[{text:'"Thanks."'}],()=>{});
        else{}});return}
  ML.openDlg('ALDRIC','The Gatekeeper',
    '"Well met, '+r.name+'. You look like you can handle yourself, but the trail ahead is no place for carelessness. Let me share what I know."',
    [{text:'"What dangers lie ahead?"'},{text:'"I can handle myself."'},{text:'"Any advice for a traveler?"'}],
    (i)=>{r.ss.aldric=true;GS.saveA();
      if(i===0)ML.openDlg('ALDRIC','The Gatekeeper','"Gray Oozes have been spotted on the trail. Slow creatures, but they\u2019ll close the distance if you let them. Keep your weapon ready and strike when in range. If you have a shield, blocking can save your hide."',
        [{text:'"Thank you, Aldric."'}],()=>{UI.addN('Aldric nods and steps aside, opening the gate.','f')});
      else if(i===1)ML.openDlg('ALDRIC','The Gatekeeper','"Ha! Confidence is good, but listen \u2014 when something attacks, you can block with a shield to reduce the blow. And if things go badly, there\u2019s no shame in running. Distance is your friend."',
        [{text:'"I\'ll keep that in mind."'}],()=>{UI.addN('Aldric grins and opens the gate.','f')});
      else ML.openDlg('ALDRIC','The Gatekeeper','"Mind the distance between you and whatever you\u2019re fighting. Melee weapons need you close \u2014 5 meters or less. If you\u2019re using a bow, stay back at 10 meters or more. And keep a potion handy. You\u2019ll thank me later."',
        [{text:'"Wise words. Farewell."'}],()=>{UI.addN('Aldric steps aside and opens the gate.','f')})})},

mira(){
  const r=GS.run;
  if(r.ss.mira){
    ML.openDlg('MIRA','The Healer','"Welcome back, '+r.name+'. The shrine is always here for those who need it."',
      [{text:'"Heal me, please."'},{text:'"What lies beyond the trail?"'},{text:'"Just passing through."'}],
      (i)=>{if(i===0){r.hp=r.mHP;r.mp=r.mMP;if(r.debuffs)r.debuffs=[];GS.saveA();UI.updateHUD();
          ML.openDlg('MIRA','The Healer','"There. All mended."',[{text:'"Thank you."'}],()=>{UI.addN('HP and MP fully restored. Status effects cleared.','s')})}
        else if(i===1)ML.openDlg('MIRA','The Healer','"Beyond this shrine, the trails lead to darker places. The Whispering Bog, where the dead don\u2019t rest easy. The Iron Hollows, where dwarven mines collapsed into something worse. And further still\u2026 well, those are journeys for another day. For now, you\u2019ve earned your rest."',
          [{text:'"I look forward to it."'}],()=>{})
        else{}});return}
  ML.openDlg('MIRA','The Healer',
    '"Welcome, traveler. You bear the marks of battle \u2014 that acidic stench can only mean you faced an Ooze on the trail. Let me tend your wounds."',
    [{text:'"Please, I could use the help."'},{text:'"What can you tell me about this place?"'}],
    (i)=>{r.hp=r.mHP;r.mp=r.mMP;r.ss.mira=true;UI.updateHUD();
      if(i===0){if(r.bp.length<6)r.bp.push({...ITEMS.hpot});GS.saveA();
        ML.openDlg('MIRA','The Healer','"There. Good as new. Take this potion as well \u2014 the road beyond here grows darker still. You\u2019ve done well to make it this far, '+r.name+'. Perhaps we\u2019ll meet again."',
          [{text:'"Until next time, Mira."'}],()=>{UI.addN('Mira smiles and returns to her herbs. You feel restored.','s');UI.addN('HP and MP fully restored. Health Potion added to backpack.','y');SE.runComplete()})}
      else{if(r.bp.length<6)r.bp.push({...ITEMS.hpot});GS.saveA();
        ML.openDlg('MIRA','The Healer','"This shrine has stood since before the kingdoms fell. It\u2019s a place of healing \u2014 the forest seems to respect it. Beyond here, the trails lead to darker places: the Whispering Bog, the Iron Hollows\u2026 but those are journeys for another day."',
          [{text:'"I look forward to it. Thank you."'}],()=>{UI.addN('Mira heals your wounds and gives you a Health Potion.','s');UI.addN('HP and MP fully restored.','y');SE.runComplete()})}})},

garrett(){
  const r=GS.run;
  const shopGreet=r.ss.garrett?'"Back for more? I\u2019ve restocked since last time."':'"Well now, a survivor! Name\u2019s Garrett. I trade in what the trail provides \u2014 potions, antidotes, the odd curiosity. Show me what you\u2019ve got, or browse my wares."';
  if(!r.ss.garrett){r.ss.garrett=true;GS.saveA()}
  ML.openDlg('GARRETT','The Peddler',shopGreet,
    [{text:'"Show me your wares."'},{text:'"I want to sell."'},{text:'"Not now."'}],
    (i)=>{if(i===0)this.garrettBuy();else if(i===1)this.garrettSell();else{}})},

garrettBuy(){
  const r=GS.run;
  const stock=[{key:'hpot',price:12},{key:'mpot',price:12},{key:'antidote',price:10}];
  const b=$('m-dlg-b');b.innerHTML='';
  b.innerHTML+='<div class="dlg-name">GARRETT</div><div class="dlg-title">The Peddler</div>';
  b.innerHTML+='<div class="dtx" style="margin-bottom:12px">Gold: <span style="color:var(--gold)">'+(r.gold||0)+'g</span> \u00b7 Backpack: '+r.bp.length+'/6</div>';
  stock.forEach(s=>{const it=ITEMS[s.key];if(!it)return;
    const row=document.createElement('div');row.style.cssText='display:flex;justify-content:space-between;align-items:center;padding:10px;margin-bottom:6px;background:var(--bg3);border:1px solid var(--border);border-radius:6px';
    row.innerHTML='<div><strong style="color:var(--text)">'+it.name+'</strong><div style="font-size:.85rem;color:var(--text2)">'+it.desc+'</div></div>';
    const btn=document.createElement('button');btn.className='iab';btn.textContent='Buy ('+s.price+'g)';
    btn.disabled=(r.gold||0)<s.price||r.bp.length>=6;
    btn.onclick=()=>{if((r.gold||0)<s.price||r.bp.length>=6)return;
      r.gold-=s.price;r.bp.push({...ITEMS[s.key]});GS.saveA();UI.updateHUD();
      UI.addN('Bought '+it.name+' for '+s.price+'g.','s');this.garrettBuy()};
    row.appendChild(btn);b.appendChild(row)});
  const backBtn=document.createElement('button');backBtn.className='mbtn';backBtn.textContent='Done';backBtn.style.marginTop='12px';
  backBtn.onclick=()=>{ML.closeAll()};b.appendChild(backBtn)},

garrettSell(){
  const r=GS.run;
  const b=$('m-dlg-b');b.innerHTML='';
  b.innerHTML+='<div class="dlg-name">GARRETT</div><div class="dlg-title">The Peddler</div>';
  b.innerHTML+='<div class="dtx" style="margin-bottom:12px">Gold: <span style="color:var(--gold)">'+(r.gold||0)+'g</span></div>';
  const sellable=r.bp.map((it,i)=>({it,i})).filter(x=>x.it.value&&!x.it.undrop);
  if(!sellable.length){b.innerHTML+='<div class="dtx" style="color:var(--text2)">"\u2026Nothing worth buying in that pack of yours."</div>';
    const backBtn=document.createElement('button');backBtn.className='mbtn';backBtn.textContent='Done';backBtn.style.marginTop='12px';
    backBtn.onclick=()=>{ML.closeAll()};b.appendChild(backBtn);return}
  sellable.forEach(({it,i})=>{
    const row=document.createElement('div');row.style.cssText='display:flex;justify-content:space-between;align-items:center;padding:10px;margin-bottom:6px;background:var(--bg3);border:1px solid var(--border);border-radius:6px';
    row.innerHTML='<div><strong style="color:var(--text)">'+it.name+'</strong><div style="font-size:.85rem;color:var(--text2)">'+it.desc+'</div></div>';
    const btn=document.createElement('button');btn.className='iab';btn.textContent='Sell ('+it.value+'g)';
    btn.onclick=()=>{r.bp.splice(r.bp.indexOf(it),1);if(!r.gold)r.gold=0;r.gold+=it.value;GS.saveA();UI.updateHUD();
      UI.addN('Sold '+it.name+' for '+it.value+'g.','s');this.garrettSell()};
    row.appendChild(btn);b.appendChild(row)});
  const backBtn=document.createElement('button');backBtn.className='mbtn';backBtn.textContent='Done';backBtn.style.marginTop='12px';
  backBtn.onclick=()=>{ML.closeAll()};b.appendChild(backBtn)},

torgun(){
  const r=GS.run;
  if(r.ss.torgun){
    ML.openDlg('TORGUN','The Lost Miner','"Still alive, are you? The forge is ahead \u2014 the Golem guards it still. Nothing I could do against that thing. But you\u2026 maybe you\u2019ve got a chance."',
      [{text:'"Tell me about the Golem."'},{text:'"I\u2019ll manage."'}],
      (i)=>{if(i===0)ML.openDlg('TORGUN','The Lost Miner','"Iron Golem. Built by the old forge-masters to guard their work. Tough as the mountain itself \u2014 high defense, hits like a cave-in. Close the distance and hit hard. Don\u2019t let it corner you."',[{text:'"Thanks, Torgun."'}],()=>{});
        else{}});return}
  ML.openDlg('TORGUN','The Lost Miner',
    '"You\u2019re the first living soul I\u2019ve seen in\u2026 I\u2019ve lost count. Name\u2019s Torgun. My crew and I came down here looking for iron veins. Found something worse. Crawlers in the tunnels. Shades in the halls. And deeper still, something that doesn\u2019t die."',
    [{text:'"What happened to your crew?"'},{text:'"What\u2019s deeper in?"'}],
    (i)=>{r.ss.torgun=true;r.hp=r.mHP;r.mp=r.mMP;if(r.debuffs)r.debuffs=[];GS.saveA();UI.updateHUD();
      if(i===0)ML.openDlg('TORGUN','The Lost Miner','"Gone. The shades took most of them. Quick and silent. I barely got out of the deep halls. Take this advice: when you see shadows that move on their own, don\u2019t blink. They\u2019ll stun you cold."',
        [{text:'"I\u2019ll be careful."'}],()=>{UI.addN('Torgun nods grimly. You feel restored by his company.','s');UI.addN('HP and MP fully restored. Status effects cleared.','y')});
      else ML.openDlg('TORGUN','The Lost Miner','"An Iron Golem. The old forge-masters built it to guard the deep forge. It\u2019s been down here for centuries, still patrolling. Nothing we had could scratch it. But you look tougher than my lot."',
        [{text:'"I\u2019ll find a way."'}],()=>{UI.addN('Torgun offers a weary smile. You feel restored.','s');UI.addN('HP and MP fully restored. Status effects cleared.','y')})})},

brynn(){
  const r=GS.run;
  if(r.ss.brynn){
    ML.openDlg('BRYNN','The Innkeeper','"Welcome back. The board\u2019s been updated if you\u2019re looking for work. Or just sit by the fire \u2014 no charge for that."',
      [{text:'"I\u2019ll check the board."'},{text:'"Heal me up."'},{text:'"Just resting."'}],
      (i)=>{if(i===0){ML.closeAll();this.openBountyBoard()}
        else if(i===1){r.hp=r.mHP;r.mp=r.mMP;if(r.debuffs)r.debuffs=[];GS.saveA();UI.updateHUD();
          ML.openDlg('BRYNN','The Innkeeper','"There. Warm food and a clean bandage do wonders."',[{text:'"Thanks, Brynn."'}],()=>{UI.addN('HP and MP fully restored. Status effects cleared.','s')})}
        else{}});return}
  ML.openDlg('BRYNN','The Innkeeper',
    '"Well met, traveler. I\u2019m Brynn. This place has stood since before the hollows were sealed. I keep the fire lit and the bounty board updated. If you\u2019re looking for coin or glory, you\u2019ve come to the right crossroads."',
    [{text:'"Tell me about the bounties."'},{text:'"Heal me up, if you would."'},{text:'"I\u2019ll be on my way."'}],
    (i)=>{r.ss.brynn=true;GS.saveA();
      if(i===0){ML.closeAll();this.openBountyBoard()}
      else if(i===1){r.hp=r.mHP;r.mp=r.mMP;if(r.debuffs)r.debuffs=[];GS.saveA();UI.updateHUD();
        ML.openDlg('BRYNN','The Innkeeper','"Rest easy. The hearth heals all."',[{text:'"Thank you."'}],()=>{UI.addN('HP and MP fully restored. Status effects cleared.','s')})}
      else{}})},

talkNPC(nid){
  const r=GS.run,npc=NPCS[nid];if(!npc||!npc.dialogue)return;
  const dlg=npc.dialogue;
  const key=r.ss[nid]?'returning':'initial';
  const node=dlg[key]||dlg.initial;
  if(!node)return;
  r.ss[nid]=true;GS.saveA();
  this._showDlgNode(nid,npc,node);
},
_showDlgNode(nid,npc,node){
  if(!node)return;
  if(node.effect)this._dlgEffect(node.effect,nid);
  if(!node.options||!node.options.length){
    ML.openDlg(npc.name.toUpperCase(),npc.title,node.text,[{text:'Continue'}],()=>{});return}
  ML.openDlg(npc.name.toUpperCase(),npc.title,node.text,
    node.options.map(o=>({text:o.text})),
    (i)=>{const opt=node.options[i];
      if(opt.next){const nextNode=NPCS[nid].dialogue[opt.next];
        if(nextNode)this._showDlgNode(nid,npc,nextNode)}});
},
_dlgEffect(eff,nid){
  const r=GS.run;
  if(eff==='heal'){r.hp=r.mHP;r.mp=r.mMP;if(r.debuffs)r.debuffs=[];GS.saveA();UI.updateHUD();UI.addN('HP and MP fully restored. Status effects cleared.','s')}
  else if(eff==='bounty_board'){ML.closeAll();this.openBountyBoard()}
  else if(eff==='shop'){ML.closeAll();this.openShop(nid)}
  else if(eff.startsWith('give_item:')){const itemKey=eff.split(':')[1];
    if(itemKey&&ITEMS[itemKey]&&r.bp.length<6){r.bp.push({...ITEMS[itemKey]});GS.saveA();UI.updateHUD();UI.addN('Received '+ITEMS[itemKey].name+'!','s')}
    else if(r.bp.length>=6)UI.addN('Your backpack is full!','d')}
},
openShop(nid){
  const r=GS.run,npc=NPCS[nid];if(!npc||!npc.shop)return;
  const b=$('m-dlg-b');b.innerHTML='';
  $('dlg-t').textContent=npc.name.toUpperCase();
  b.innerHTML+='<div class="dlg-name">'+npc.name.toUpperCase()+'</div><div class="dlg-title">'+npc.title+'</div>';
  b.innerHTML+='<div class="dtx" style="margin-bottom:12px">Gold: <span style="color:var(--gold)">'+(r.gold||0)+'g</span> \u00b7 Backpack: '+r.bp.length+'/6</div>';
  b.innerHTML+='<div class="ist">Wares</div>';
  npc.shop.stock.forEach(s=>{
    const it=ITEMS[s.key];if(!it)return;
    const row=document.createElement('div');
    row.style.cssText='display:flex;justify-content:space-between;align-items:center;padding:10px;margin-bottom:6px;background:var(--bg3);border:1px solid var(--border);border-radius:6px';
    row.innerHTML='<div><strong style="color:var(--text)">'+it.name+'</strong><div style="font-size:.85rem;color:var(--text2)">'+it.desc+'</div></div>';
    const btn=document.createElement('button');btn.className='iab';btn.textContent='Buy ('+s.price+'g)';
    btn.disabled=(r.gold||0)<s.price||r.bp.length>=6;
    btn.onclick=()=>{if((r.gold||0)<s.price||r.bp.length>=6)return;
      r.gold-=s.price;r.bp.push({...ITEMS[s.key]});GS.saveA();UI.updateHUD();
      UI.addN('Bought '+it.name+' for '+s.price+'g.','s');this.openShop(nid)};
    row.appendChild(btn);b.appendChild(row)});
  b.innerHTML+='<div class="ist" style="margin-top:12px">Sell</div>';
  const sellable=r.bp.map((it,i)=>({it,i})).filter(x=>x.it.value&&!x.it.undrop);
  if(!sellable.length)b.innerHTML+='<div style="font-size:.85rem;color:var(--text3);font-style:italic">Nothing to sell.</div>';
  sellable.forEach(({it})=>{
    const row=document.createElement('div');
    row.style.cssText='display:flex;justify-content:space-between;align-items:center;padding:10px;margin-bottom:6px;background:var(--bg3);border:1px solid var(--border);border-radius:6px';
    row.innerHTML='<div><strong style="color:var(--text)">'+it.name+'</strong><div style="font-size:.85rem;color:var(--text2)">'+it.desc+'</div></div>';
    const btn=document.createElement('button');btn.className='iab';btn.textContent='Sell ('+it.value+'g)';
    btn.onclick=()=>{r.bp.splice(r.bp.indexOf(it),1);if(!r.gold)r.gold=0;r.gold+=it.value;GS.saveA();UI.updateHUD();
      UI.addN('Sold '+it.name+' for '+it.value+'g.','s');this.openShop(nid)};
    row.appendChild(btn);b.appendChild(row)});
  const doneBtn=document.createElement('button');doneBtn.className='mbtn';doneBtn.textContent='Done';doneBtn.style.marginTop='12px';
  doneBtn.onclick=()=>ML.closeAll();b.appendChild(doneBtn);
  ML.open('m-dlg');
  const modal=$('m-dlg');const mx=modal.querySelector('.mx');if(mx)mx.style.display='';
},
_generateBountyBoard(){
  const r=GS.run,lvl=r.level;
  const pool=Object.entries(BOUNTIES).filter(([,b])=>{
    if(lvl<=3)return b.tier<=2;if(lvl<=6)return b.tier<=3;return true});
  const shuffled=pool.sort(()=>Math.random()-0.5);
  return shuffled.slice(0,Math.min(5,shuffled.length)).map(([id,b])=>({id,...b}));
},

openBountyBoard(){
  const r=GS.run;
  if(!r.bountyBoard||!r.bountyBoard.length)r.bountyBoard=this._generateBountyBoard();
  if(!r.activeQuests)r.activeQuests=[];
  if(!r.completedQuests)r.completedQuests={};
  if(!r.questProgress)r.questProgress={};
  GS.saveA();
  const b=$('m-dlg-b');b.innerHTML='';
  $('dlg-t').textContent='BOUNTY BOARD';
  b.innerHTML+='<div class="dlg-name">BOUNTY BOARD</div><div class="dlg-title">The Hearthstone Tavern</div>';
  b.innerHTML+='<div class="dtx" style="margin-bottom:8px">Gold: <span style="color:var(--gold)">'+(r.gold||0)+'g</span> \u00b7 Level '+r.level+'</div>';
  b.innerHTML+='<div class="ist">Bounties</div>';
  r.bountyBoard.forEach(bn=>{
    const enemy=ENEMIES[bn.enemy];if(!enemy)return;
    const row=document.createElement('div');
    row.style.cssText='padding:10px;margin-bottom:6px;background:var(--bg3);border:1px solid var(--border);border-radius:6px';
    row.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center"><strong style="color:var(--text)">'+bn.name+'</strong><span class="tier-badge tier-'+bn.tier+'">'+TIER_LABELS[bn.tier]+'</span></div><div style="font-size:.85rem;color:var(--text2)">'+bn.desc+'</div><div style="font-size:.8rem;color:var(--text3);margin-top:4px">Target: '+enemy.name+' \u00b7 Reward: <span style="color:var(--gold)">'+bn.goldReward+'g</span> + '+bn.xpReward+' XP</div>';
    const btn=document.createElement('button');btn.className='iab';btn.style.cssText='margin-top:6px';btn.textContent='Accept Bounty';
    btn.onclick=()=>{r.activeBounty={id:bn.id,enemy:bn.enemy,goldReward:bn.goldReward,xpReward:bn.xpReward,name:bn.name};
      r.bountyBoard=null;GS.saveA();ML.closeAll();this.startBounty()};
    row.appendChild(btn);b.appendChild(row)});
  const refreshBtn=document.createElement('button');refreshBtn.className='iab';refreshBtn.style.cssText='margin-top:8px;width:100%';refreshBtn.textContent='Refresh Board';
  refreshBtn.onclick=()=>{r.bountyBoard=this._generateBountyBoard();GS.saveA();this.openBountyBoard()};
  b.appendChild(refreshBtn);
  b.innerHTML+='<div class="ist" style="margin-top:16px">Quests</div>';
  const available=Object.entries(QUESTS).filter(([id,q])=>!r.completedQuests[id]);
  if(!available.length)b.innerHTML+='<div style="font-size:.85rem;color:var(--text3);font-style:italic">All quests completed!</div>';
  available.forEach(([id,q])=>{
    const accepted=r.activeQuests.includes(id);
    const prog=r.questProgress[id]||0;
    const qd=document.createElement('div');
    qd.style.cssText='padding:10px;margin-bottom:6px;background:var(--bg3);border:1px solid var(--border);border-radius:6px';
    let rewardStr='<span style="color:var(--gold)">'+q.reward.gold+'g</span> + '+q.reward.xp+' XP';
    if(q.reward.item)rewardStr+=' + '+ITEMS[q.reward.item].name;
    qd.innerHTML='<strong style="color:var(--text)">'+q.name+'</strong><div style="font-size:.85rem;color:var(--text2)">'+q.desc+'</div><div style="font-size:.8rem;color:var(--text3);margin-top:4px">Reward: '+rewardStr+(accepted?' \u00b7 Progress: '+prog+'/'+q.count:'')+'</div>';
    if(!accepted){const ab=document.createElement('button');ab.className='iab';ab.style.cssText='margin-top:6px';ab.textContent='Accept';
      ab.onclick=()=>{r.activeQuests.push(id);GS.saveA();this.openBountyBoard()};qd.appendChild(ab)}
    else{const tag=document.createElement('span');tag.style.cssText='display:inline-block;margin-top:6px;font-size:.8rem;color:var(--green)';tag.textContent='Accepted ('+prog+'/'+q.count+')';qd.appendChild(tag)}
    b.appendChild(qd)});
  const doneBtn=document.createElement('button');doneBtn.className='mbtn';doneBtn.textContent='Done';doneBtn.style.marginTop='12px';
  doneBtn.onclick=()=>ML.closeAll();b.appendChild(doneBtn);
  ML.open('m-dlg');
  const modal=$('m-dlg');const mx=modal.querySelector('.mx');if(mx)mx.style.display='';
},

startBounty(){
  const r=GS.run,bn=r.activeBounty;if(!bn)return;
  const enemy=ENEMIES[bn.enemy];if(!enemy){UI.addN('Bounty target unknown.','d');return}
  const arenaScene=SCENE_DATA.bounty_arena;
  arenaScene.description='You track your quarry to a clearing. A '+enemy.name+' awaits.';
  arenaScene.events.combat=bn.enemy;
  this.enter('bounty_arena');
},

async completeBounty(){
  const r=GS.run,bn=r.activeBounty;if(!bn)return;
  if(!r.gold)r.gold=0;r.gold+=bn.goldReward;
  const xpRes=GS.addXP(bn.xpReward);
  UI.addN('Bounty Complete: '+bn.name+'!','h');
  UI.addN('Bonus reward: +'+bn.goldReward+'g, +'+xpRes.gained+' XP','s');
  this._trackQuestProgress('bounty_complete');
  this._trackQuestProgress('defeat_'+bn.enemy);
  r.activeBounty=null;GS.saveA();UI.updateHUD();
  if(xpRes.leveled){
    const showLvl=(idx)=>{if(idx>=xpRes.lvls.length){this._bountyReturn();return}
      ML.openLvl(xpRes.lvls[idx],()=>showLvl(idx+1))};showLvl(0)}
  else this._bountyReturn();
},

failBounty(){
  const r=GS.run;
  UI.addN('Bounty failed. Return to the tavern to try again.','d');
  r.activeBounty=null;GS.saveA();
  this._bountyReturn();
},

async _bountyReturn(){
  await UI._wait(500);
  const btn=document.createElement('button');btn.className='nav-btn';btn.style.marginTop='12px';
  btn.textContent='Return to Tavern \u2192';
  btn.onclick=()=>this.enter('tavern_hub');
  UI.addEl(btn);
},

_trackQuestProgress(trigger){
  const r=GS.run;
  if(!r.activeQuests||!r.activeQuests.length)return;
  if(!r.questProgress)r.questProgress={};
  if(!r.completedQuests)r.completedQuests={};
  r.activeQuests.forEach(qid=>{
    const q=QUESTS[qid];if(!q||r.completedQuests[qid])return;
    if(q.trigger===trigger){
      r.questProgress[qid]=(r.questProgress[qid]||0)+1;
      if(r.questProgress[qid]>=q.count){
        r.completedQuests[qid]=true;
        r.activeQuests=r.activeQuests.filter(x=>x!==qid);
        if(!r.gold)r.gold=0;r.gold+=q.reward.gold;
        GS.addXP(q.reward.xp);
        if(q.reward.item&&r.bp.length<6)r.bp.push({...ITEMS[q.reward.item]});
        UI.addN('Quest Complete: '+q.name+'!','h');
        UI.addN('Reward: +'+q.reward.gold+'g, +'+q.reward.xp+' XP'+(q.reward.item?' + '+ITEMS[q.reward.item].name:''),'s');
        showToast('Quest Complete: '+q.name,'success');
      }
    }
  });
  GS.saveA();UI.updateHUD();
},

runComplete(){
  const r=GS.run,adv=r.adventure||'muddy_trail',xpRes=GS.addXP(25);
  const advNames={muddy_trail:'The Muddy Trail',iron_hollows:'The Iron Hollows',ashen_waste:'The Ashen Waste'};
  UI.addN((advNames[adv]||'Adventure')+' Complete!','h');
  UI.addN('XP earned: '+xpRes.gained+' (exploration bonus)','s');
  const afterLvl=()=>{
    UI.addN('Total XP: '+r.xp+'/'+(r.level<25?r.level*100:'MAX'),'y');
    if(adv==='muddy_trail'){
      UI.addN('The Muddy Trail is behind you. But darker places await \u2014 the Iron Hollows, where dwarven mines collapsed into something worse.','f');
      const btn=document.createElement('button');btn.className='nav-btn';btn.style.marginTop='12px';
      btn.textContent='Continue to the Iron Hollows \u2192';btn.onclick=()=>this.startAdventure('iron_hollows');
      UI.addEl(btn)}
    else if(adv==='iron_hollows'){
      UI.addN('The Iron Hollows are behind you. But beyond the mountains, a scorched wasteland awaits \u2014 the Ashen Waste, where fire and ruin reign.','f');
      const btn2=document.createElement('button');btn2.className='nav-btn';btn2.style.marginTop='12px';
      btn2.textContent='Continue to the Ashen Waste \u2192';btn2.onclick=()=>this.startAdventure('ashen_waste');
      UI.addEl(btn2)}
    else{UI.addN('You emerge into daylight. All adventures are complete. Save your progress from the menu, or begin anew.','f')}
    UI.updateHUD()};
  if(xpRes.leveled){
    const showLvl=(idx)=>{if(idx>=xpRes.lvls.length){afterLvl();return}
      UI.addN('Level up! You are now level '+xpRes.lvls[idx]+'!','s');
      ML.openLvl(xpRes.lvls[idx],()=>showLvl(idx+1))};
    showLvl(0)}
  else afterLvl();
  GS.saveA();
},

startAdventure(advId){
  const r=GS.run;r.adventure=advId;r.cs=null;
  if(r.debuffs)r.debuffs=[];
  const starts={iron_hollows:'ih_entrance',ashen_waste:'ash_gate'};
  const startScene=starts[advId]||'trailhead';
  r.scene=startScene;GS.saveA();
  UI.clearN();this.enter(startScene);
}
};

// === PARTICLES ===
const Particles={
  cvs:null,ctx:null,particles:[],running:false,raf:null,
  start(){this.cvs=$('particles');if(!this.cvs)return;this.ctx=this.cvs.getContext('2d');
    this.resize();window.addEventListener('resize',()=>this.resize());
    this.particles=[];for(let i=0;i<25;i++)this.particles.push(this.spawn());
    this.running=true;this.loop()},
  stop(){this.running=false;if(this.raf)cancelAnimationFrame(this.raf)},
  resize(){if(!this.cvs)return;this.cvs.width=window.innerWidth;this.cvs.height=window.innerHeight},
  spawn(){return{x:Math.random()*window.innerWidth,y:Math.random()*window.innerHeight,
    r:1+Math.random()*1.5,vy:-(0.2+Math.random()*0.3),vx:(Math.random()-0.5)*0.3,
    o:0.08+Math.random()*0.12}},
  loop(){if(!this.running)return;const c=this.ctx,w=this.cvs.width,h=this.cvs.height;
    c.clearRect(0,0,w,h);
    this.particles.forEach(p=>{p.x+=p.vx;p.y+=p.vy;
      if(p.y<-10){p.y=h+10;p.x=Math.random()*w}
      c.beginPath();c.arc(p.x,p.y,p.r,0,Math.PI*2);c.fillStyle='rgba(201,168,76,'+p.o+')';c.fill()});
    this.raf=requestAnimationFrame(()=>this.loop())}
};

// === INIT ===
document.addEventListener('DOMContentLoaded',()=>{
  UI.init();
  UI.showLanding();
});

// === PWA SERVICE WORKER REGISTRATION ===
if('serviceWorker' in navigator){navigator.serviceWorker.register('./sw.js').then(reg=>{
  reg.addEventListener('updatefound',()=>{const nw=reg.installing;if(nw)nw.addEventListener('statechange',()=>{
    if(nw.state==='activated'&&navigator.serviceWorker.controller)UI.addN('A new version is available. Refresh to update.','y')})})
}).catch(e=>console.warn('SW registration failed:',e))}
</script>

</body>
</html>
